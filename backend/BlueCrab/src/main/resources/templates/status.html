<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BlueCrab API 테스트 도구</title>
    <link rel="stylesheet" th:href="@{/css/api-tester.css}" href="/css/api-tester.css">
</head>
<body>
    <div class="container">
        <!-- 헤더 -->
        <div class="header">
            <div class="header-content">
                <div class="header-title">
                    <h1>🦀 BlueCrab API 테스트 도구</h1>
                    <p>JWT 기반 인증 API 테스트 및 디버깅</p>
                </div>
                <button class="help-button" onclick="showHelpModal()">
                    ❓ 사용 설명
                </button>
            </div>
        </div>

        <!-- 서버 정보 바 -->
        <div class="server-info">
            <div class="server-info-item">
                <span class="status-indicator"></span>
                <span class="label">상태:</span>
                <span class="value" th:text="${status ?: '백엔드 서버 정상 작동중'}">백엔드 서버 정상 작동중</span>
            </div>
            <div class="server-info-item">
                <span class="label">서버 시간:</span>
                <span class="value" th:text="${#temporals.format(serverTime, 'yyyy-MM-dd HH:mm:ss')}">2025-10-11 19:25:45</span>
            </div>
            <div class="server-info-item">
                <span class="label">버전:</span>
                <span class="value" th:text="${version ?: '1.0.0'}">1.0.0</span>
            </div>
        </div>

        <div class="layout-grid">
            <!-- 인증 & 토큰 -->
            <div class="section auth-section layout-span-2">
                <h3>🔐 인증 & 토큰</h3>

                <div class="endpoint-info">
                    <strong>서버 URL:</strong> <span id="serverUrl">현재 서버와 동일</span><br>
                    <strong>상태:</strong> <span class="status-indicator-inline status-success"></span>Same-Origin (CORS 문제 없음)
                </div>

                <!-- 인증 탭 네비게이션 -->
                <div class="auth-tabs">
                    <button class="auth-tab active" onclick="switchAuthTab('general')">
                        <span class="tab-icon">👤</span>
                        <span class="tab-label">일반 사용자</span>
                    </button>
                    <button class="auth-tab" onclick="switchAuthTab('admin')">
                        <span class="tab-icon">👔</span>
                        <span class="tab-label">관리자 2단계</span>
                    </button>
                </div>

                <!-- 일반 로그인 탭 콘텐츠 -->
                <div id="general-auth-tab" class="auth-tab-content active">
                    <div class="auth-subsection">
                        <label for="username">사용자명 (이메일):</label>
                        <input type="email" id="username" placeholder="student@university.edu" value="">

                        <label for="password">비밀번호:</label>
                        <input type="password" id="password" placeholder="••••••••" value="">

                        <div class="button-group">
                            <button onclick="login()">로그인</button>
                            <button onclick="refreshAccessToken()" class="success">토큰 갱신</button>
                            <button onclick="logout()" class="danger">로그아웃</button>
                        </div>
                    </div>
                </div>

                <!-- 관리자 2단계 인증 탭 콘텐츠 -->
                <div id="admin-auth-tab" class="auth-tab-content">
                    <div class="auth-subsection">
                        <div class="endpoint-info">
                            <strong>⚠️ 절차:</strong> 임시토큰 입력 → 인증코드 이메일로 발송 → 검증
                        </div>

                        <label for="adminTempToken">임시 토큰:</label>
                        <input type="text" id="adminTempToken" placeholder="임시 세션 토큰을 입력하세요">

                        <button onclick="adminRequestAuthCode()" style="background: #9b59b6;">Step 1: 인증코드 요청</button>

                        <div id="adminStep2Section" style="margin-top: 15px; padding-top: 15px; border-top: 2px dashed #ddd; display: none;">
                            <label for="adminAuthCode">인증 코드 (6자리):</label>
                            <input type="text" id="adminAuthCode" placeholder="ABC123" maxlength="6" style="text-transform: uppercase;">

                            <button onclick="adminVerifyAuthCode()" style="background: #8e44ad;">Step 2: 인증코드 검증</button>
                        </div>

                        <div id="adminAuthStatus" style="margin-top: 10px; padding: 10px; background: #f0f0f0; border-radius: 5px; font-size: 12px; display: none;">
                            <strong>상태:</strong> <span id="adminAuthStatusText"></span>
                        </div>
                    </div>
                </div>

                <!-- 토큰 정보 표시 -->
                <div id="tokenInfo" class="token-info" style="display: none;">
                    <div><strong>Access Token:</strong> <span id="accessTokenDisplay"></span></div>
                    <div><strong>Refresh Token:</strong> <span id="refreshTokenDisplay"></span></div>
                    <div><strong>만료 시간:</strong> <span id="tokenExpiry"></span></div>
                    <button onclick="toggleTokenDecoded()" style="margin-top: 10px; font-size: 11px; padding: 5px 10px;">토큰 내용 보기/숨기기</button>
                    <div id="tokenDecoded" class="token-decoded" style="display: none;">
                        <strong>🔍 Access Token 디코딩 결과:</strong><br>
                        <span id="accessTokenParsed"></span>
                    </div>
                </div>
            </div>

            <!-- 토큰 세트 관리 -->
            <div class="section token-management-section">
                <h3>💾 토큰 세트 관리</h3>

                <div class="token-save-form">
                    <label for="tokenSetName">세트 이름:</label>
                    <input type="text" id="tokenSetName" placeholder="토큰 세트 이름 (예: stu01)">
                    <button onclick="saveTokenSet()" class="success full-width">현재 토큰 저장</button>
                </div>

                <h4 class="storage-subtitle">저장된 토큰 세트</h4>
                <div id="tokenSetsList"></div>
            </div>

            <!-- API 테스트 -->
            <div class="section api-test-section layout-span-2">
                <h3>⚡ API 테스트</h3>

                <!-- 인증 상태 배너 -->
                <div class="auth-status-banner" id="authStatusBanner">
                    <div class="auth-status-indicator">
                        <span class="status-icon" id="authStatusIcon">🔓</span>
                        <span class="status-text" id="authStatusText">로그인 필요 (토큰 없음)</span>
                    </div>
                    <div class="auth-status-info">
                        선택한 API가 인증을 요구하면 자동으로 Authorization 헤더에 토큰이 추가됩니다.
                    </div>
                </div>

                <label for="testEndpoint">테스트할 엔드포인트:</label>
                <select id="testEndpoint" onchange="updateEndpointInfo()">
                    <option value="">-- 엔드포인트 로딩중 --</option>
                </select>
                <div id="endpointSummary" class="endpoint-summary"></div>

                <label for="httpMethod">HTTP 메소드:</label>
                <select id="httpMethod">
                    <option value="GET">GET</option>
                    <option value="POST">POST</option>
                    <option value="PUT">PUT</option>
                    <option value="DELETE">DELETE</option>
                </select>

                <label for="customUrl" id="customUrlLabel" style="display: none;">커스텀 URL:</label>
                <input type="text" id="customUrl" placeholder="/api/custom-endpoint" style="display: none;">

                <!-- 동적 파라미터 필드 -->
                <div class="dynamic-section-label">요청 파라미터</div>
                <div id="dynamicParams"></div>

                <div class="dynamic-section-label" id="dynamicHeadersLabel" style="display: none;">커스텀 헤더</div>
                <div id="dynamicHeaders" class="dynamic-headers" style="display: none;"></div>

                <!-- 요청 본문 템플릿 (접을 수 있는 섹션) -->
                <div class="collapsible-section">
                    <div class="section-header" onclick="toggleSection('bodyTemplates')">
                        <span class="toggle-icon" id="bodyTemplatesIcon">▶</span>
                        <span class="section-header-title">📄 요청 본문 템플릿 관리</span>
                        <span class="badge" id="bodyTemplatesBadge">0개 저장됨</span>
                    </div>
                    <div id="bodyTemplates" class="section-content collapsed">
                        <div class="body-template-controls">
                            <input type="text" id="bodyTemplateName" placeholder="템플릿 이름 (예: 학생등록)">
                            <button type="button" onclick="saveBodyTemplate()">저장</button>
                            <select id="savedBodyTemplates" onchange="loadBodyTemplate()">
                                <option value="">-- 저장된 템플릿 선택 --</option>
                            </select>
                            <button type="button" class="danger" onclick="deleteBodyTemplate()">삭제</button>
                        </div>
                    </div>
                </div>

                <label for="requestBody">요청 본문 (JSON):</label>
                <textarea id="requestBody" rows="6" placeholder='{"key": "value"}'></textarea>

                <div class="button-group">
                    <button onclick="sendRequest()" class="primary">API 호출</button>
                    <button onclick="clearResponse()" class="danger">응답 지우기</button>
                </div>
            </div>

            <div class="section history-section">
                <h3>📜 요청 히스토리</h3>
                <button onclick="clearHistory()" class="danger full-width">히스토리 전체 삭제</button>
                <div id="historyList"></div>
            </div>

            <div class="section response-section layout-span-3">
                <h3>📋 응답 결과</h3>
                <div id="response" class="response">여기에 API 응답이 표시됩니다...</div>
            </div>

            <div class="section attachments-section layout-span-3">
                <div class="section-header-inline">
                    <h3>📎 첨부파일 워크플로</h3>
                    <div>
                        <button type="button" class="danger" onclick="clearAttachmentLog()">로그 지우기</button>
                    </div>
                </div>

                <p class="section-description">
                    게시글 생성 → 파일 업로드 → 첨부 연결 흐름을 한 화면에서 실행합니다. 로그인 후 토큰이 준비된 상태에서 사용하세요.
                </p>

                <div class="attachments-grid">
                    <div class="attachment-form">
                        <label for="attachmentBoardId">게시글 IDX</label>
                        <input type="number" id="attachmentBoardId" placeholder="기존 게시글 번호 (선택)">
                        <p class="input-hint">직접 입력하거나 아래에서 새 게시글을 생성하면 자동으로 채워집니다.</p>

                        <label for="attachmentBoardCode">게시판 코드</label>
                        <input type="number" id="attachmentBoardCode" value="3" min="1">
                        <p class="input-hint">기본값 3 (공지사항). 필요한 경우 다른 코드로 변경하세요.</p>

                        <label for="attachmentTitle">게시글 제목</label>
                        <input type="text" id="attachmentTitle" placeholder="테스트 게시글 제목">

                        <label for="attachmentContent">게시글 본문</label>
                        <textarea id="attachmentContent" placeholder="게시글 본문"></textarea>

                        <div class="button-group">
                            <button type="button" class="primary" onclick="attachmentCreateBoard()">게시글 생성</button>
                            <button type="button" class="success" onclick="attachmentCreateBoardWithFiles()">게시글 + 첨부 한번에</button>
                        </div>

                        <label for="attachmentFileInput">첨부파일 (최대 5개)</label>
                        <div class="attachment-file-input">
                            <input type="file" id="attachmentFileInput" multiple>
                        </div>
                        <p class="input-hint">파일을 선택하면 자동으로 로그에 정보가 표시됩니다.</p>

                        <label for="attachmentManualIds">첨부파일 IDX 직접 입력</label>
                        <input type="text" id="attachmentManualIds" placeholder="예: 12, 15, 18">
                        <p class="input-hint">이전 업로드 결과를 직접 입력하여 재연결할 수 있습니다.</p>

                        <div class="button-group">
                            <button type="button" onclick="attachmentUploadFiles()">파일 업로드</button>
                            <button type="button" class="success" onclick="attachmentLinkFiles()">첨부 연결</button>
                        </div>
                    </div>
                    <div class="attachment-status-card">
                        <h4>최근 상태</h4>
                        <dl>
                            <dt>마지막 게시글</dt>
                            <dd id="attachmentStateBoard">없음</dd>
                            <dt>최근 업로드된 첨부</dt>
                            <dd id="attachmentStateFiles">없음</dd>
                        </dl>
                        <div class="button-group">
                            <button type="button" onclick="attachmentUseLastBoard()">게시글 IDX 적용</button>
                            <button type="button" onclick="attachmentUseLastAttachments()">첨부 IDX 적용</button>
                        </div>
                        <p class="input-hint">첨부파일 API는 모두 인증이 필요합니다. 로그인 후 사용하세요.</p>
                    </div>
                </div>

                <div class="attachment-log" id="attachmentLog">
                    <div class="attachment-log-placeholder">여기에 첨부 파일 흐름 로그가 표시됩니다.</div>
                </div>
            </div>
        </div>
    </div>

    <!-- 도움말 모달 -->
    <div id="helpModal" class="modal" onclick="closeHelpModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h2>🦀 API 테스터 사용 가이드</h2>
                <button class="modal-close" onclick="closeHelpModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="help-section">
                    <h3>📚 기본 사용법</h3>

                    <div class="help-step">
                        <div class="step-number">1️⃣</div>
                        <div class="step-content">
                            <h4>로그인</h4>
                            <p>이메일/비밀번호 입력 후 로그인 버튼 클릭</p>
                            <p>→ Access Token & Refresh Token 자동 발급 및 저장</p>
                        </div>
                    </div>

                    <div class="help-step">
                        <div class="step-number">2️⃣</div>
                        <div class="step-content">
                            <h4>API 테스트</h4>
                            <p>엔드포인트 선택 시 자동으로:</p>
                            <ul>
                                <li>HTTP 메소드 설정</li>
                                <li>파라미터 입력 필드 생성</li>
                                <li>요청 본문 템플릿 자동 입력</li>
                            </ul>
                            <p>파라미터/본문 수정 후 API 호출 버튼 클릭</p>
                        </div>
                    </div>

                    <div class="help-step">
                        <div class="step-number">3️⃣</div>
                        <div class="step-content">
                            <h4>토큰 관리</h4>
                            <p>여러 계정의 토큰을 세트로 저장 가능</p>
                            <p>→ 빠른 계정 전환 지원 (클릭 한 번으로 토큰 변경)</p>
                        </div>
                    </div>
                </div>

                <div class="help-section">
                    <h3>💡 팁</h3>
                    <ul>
                        <li><strong>인증 자동 추가:</strong> 로그인 상태에서 인증 필요 API 호출 시 자동으로 토큰이 추가됩니다</li>
                        <li><strong>요청 본문 템플릿:</strong> 자주 사용하는 JSON을 템플릿으로 저장하여 재사용 가능</li>
                        <li><strong>히스토리 재실행:</strong> 이전 요청을 한 번의 클릭으로 재실행</li>
                        <li><strong>본문 미리보기:</strong> 히스토리에서 요청 본문의 주요 내용을 즉시 확인 가능</li>
                    </ul>
                </div>

                <div class="help-section">
                    <h3>🔒 보안 안내</h3>
                    <ul>
                        <li>토큰은 브라우저의 LocalStorage에 저장됩니다</li>
                        <li>만료된 토큰은 자동으로 제거됩니다</li>
                        <li>브라우저를 닫으면 토큰이 유지되지만, 시크릿 모드에서는 삭제됩니다</li>
                    </ul>
                </div>
            </div>
            <div class="modal-footer">
                <button class="primary" onclick="closeHelpModal()">시작하기</button>
            </div>
        </div>
    </div>

    <!-- Thymeleaf inline script for server info -->
    <script th:inline="javascript">
        const serverInfo = {
            status: /*[[${status}]]*/ '정상 작동중',
            version: /*[[${version}]]*/ '1.0.0',
            serverTime: /*[[${#temporals.format(serverTime, 'yyyy-MM-dd HH:mm:ss')}]]*/ '2025-10-11 19:25:45'
        };
        console.log('Server Info:', serverInfo);
    </script>

    <!-- External JavaScript modules -->
    <script th:src="@{/js/ui-utils.js}" src="/js/ui-utils.js"></script>
    <script th:src="@{/js/token-manager.js}" src="/js/token-manager.js"></script>
    <script th:src="@{/js/history-manager.js}" src="/js/history-manager.js"></script>
    <script th:src="@{/js/body-template-manager.js}" src="/js/body-template-manager.js"></script>
    <script th:src="@{/js/api-tester.js}" src="/js/api-tester.js"></script>
    <script th:src="@{/js/attachment-tools.js}" src="/js/attachment-tools.js"></script>
</body>
</html>
