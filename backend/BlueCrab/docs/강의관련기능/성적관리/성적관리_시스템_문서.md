# Blue Crab LMS 성적 관리 시스템 문서

## 📋 시스템 개요

Blue Crab LMS의 성적 관리 시스템은 강의별 성적 평가를 위한 종합적인 솔루션입니다. lecSerial + studentIdx 통합 구조를 기반으로 하며, enrollmentIdx 자동 조회 기능을 제공합니다.

### 🎯 주요 특징

- **이벤트 기반 자동 계산**: 출석, 과제, 시험 점수 변경 시 자동으로 총점 재계산
- **JSON 기반 유연성**: ENROLLMENT_DATA 필드에 구조화된 JSON 데이터 저장
- **60% 기준 상대평가**: 합격/불합격 분류 후 하위 침범 방식 등급 배정
- **교수 전용 관리**: 교수 계정만 성적 입력 및 관리 가능

### 📊 시스템 구성 요소

1. **출석 점수**: 출석율 × 지정 만점 (기본 20점)
2. **과제 점수**: 개별 과제별 점수 누적
3. **시험 점수**: 중간고사/기말고사 점수
4. **총점 계산**: 이벤트 기반 자동 합계 및 백분율 계산

## 🔧 API 엔드포인트

### ✅ 구현 완료된 API

| 엔드포인트 | 메서드 | 설명 | 상태 |
|-----------|--------|------|------|
| `/enrollments/grade-config` | POST | 성적 구성 설정 (교수) | ✅ 완료 |
| `/enrollments/grade-info` | POST | 학생/교수 성적 조회 | ✅ 완료 |
| `/enrollments/grade-list` | POST | 전체 성적 목록 조회 | ✅ 완료 |
| `/enrollments/grade-finalize` | POST | 최종 등급 배정 | ✅ 완료 |
| `/enrollments/{enrollmentIdx}/attendance` | PUT | 출석 업데이트 + 이벤트 | ✅ 완료 |
| `/assignments/{assignmentIdx}/grade` | PUT | 과제 채점 + 이벤트 | ✅ 완료 |

### 📝 API 상세 설명

#### 1. 성적 구성 설정 (POST /enrollments/grade-config)

교수가 강의별 성적 비율을 설정합니다.

**요청 예시:**

```json
{
  "action": "set-config",
  "lecSerial": "ETH201",
  "attendanceMaxScore": 80,
  "latePenaltyPerSession": 0.5,
  "gradeDistribution": {
    "A": 30,
    "B": 40,
    "C": 20,
    "D": 10
  }
}
```

**응답 예시:**

```json
{
  "success": true,
  "message": "성적 구성이 설정되었습니다.",
  "data": {
    "lecIdx": 1,
    "gradeConfig": {
      "attendanceMaxScore": 20,
      "assignmentTotalScore": 50,
      "examTotalScore": 30,
      "latePenaltyPerSession": 0.5,
      "gradeDistribution": {"A": 30, "B": 40, "C": 20, "D": 10},
      "totalMaxScore": 100,
      "configuredAt": "2025-10-22T10:00:00"
    }
  }
}
```

#### 2. 성적 조회 (POST /enrollments/grade-info)

학생과 교수가 성적 정보를 조회합니다.

**요청 예시 (학생):**

```json
{
  "action": "get-grade",
  "lecSerial": "CS101",
  "studentIdx": 100
}
```

**요청 예시 (교수):**

```json
{
  "action": "professor-view",
  "lecSerial": "CS101"
}
```

#### 3. 최종 등급 배정 (POST /enrollments/grade-finalize)

학기 종료 시 최종 등급을 배정합니다.

**평가 방식:**

- 60% 미만: 무조건 F등급
- 60% 이상: A,B,C,D 상대평가
- 낙제자가 D→C→B 순서로 하위등급 침범
- 동점자: 모두 상위등급에 배정
- 합격자: 남은 등급에 성적순 배정

## 🏗️ 주요 컴포넌트

### 서비스 클래스

#### GradeManagementService

성적 관리의 핵심 서비스 클래스입니다.

```java
@Service
@Transactional(readOnly = true)
public class GradeManagementService {
    // 성적 구성 설정
    @Transactional
    public Map<String, Object> configureGrade(Map<String, Object> request) {
        // 성적 비율 설정 로직
    }

    // 교수용 성적 조회
    public Map<String, Object> getProfessorGradeView(Integer lecIdx) {
        // 교수용 성적 목록 조회
    }

    // 최종 등급 배정
    @Transactional
    public Map<String, Object> finalizeGrades(Integer lecIdx) {
        // 등급 배정 실행
    }
}
```

#### GradeCalculationService

성적 계산 로직을 담당합니다.

```java
@Service
@Transactional(readOnly = true)
public class GradeCalculationService {
    // 학생 성적 계산
    @Transactional
    public Map<String, Object> calculateStudentGrade(Integer lecIdx, Integer studentIdx) {
        // 출석 점수 계산
        Map<String, Object> attendanceData = calculateAttendanceScore(lecIdx, studentIdx);

        // 과제 점수 집계
        List<Map<String, Object>> assignmentScores = calculateAssignmentScores(lecIdx, studentIdx);

        // 총점 계산
        Map<String, Object> totalData = calculateTotalScore(attendanceData, assignmentScores);

        return totalData;
    }
}
```

#### GradeFinalizer

최종 등급 배정 알고리즘을 구현합니다.

```java
public class GradeFinalizer {
    public Map<String, Object> execute() {
        // 1. 합격/불합격 분류 (60% 기준)
        // 2. 등급 배정 (하위 침범 방식)
        // 3. 동점자 처리
        // 4. 데이터 업데이트
    }
}
```

### 이벤트 시스템

#### GradeUpdateEvent

성적 변경 시 자동 계산을 위한 이벤트입니다.

```java
public class GradeUpdateEvent extends ApplicationEvent {
    private final Integer lecIdx;
    private final Integer studentIdx;
    private final String updateType; // "ATTENDANCE", "ASSIGNMENT", "EXAM"

    public GradeUpdateEvent(Object source, Integer lecIdx, Integer studentIdx, String updateType) {
        super(source);
        this.lecIdx = lecIdx;
        this.studentIdx = studentIdx;
        this.updateType = updateType;
    }
}
```

## 📋 성적 관리 프로세스

### 1단계: 성적 구성 설정

- 교수: 출석/과제/시험 비율 설정
- 지각 감점 정책 설정
- 등급 분포 기준 설정

### 2단계: 점수 입력

- 출석: 자동 반영 (출결 정보)
- 과제: 교수 채점 입력
- 시험: 중간/기말고사 점수

### 3단계: 자동 계산

- 이벤트 기반 총점 재계산
- 백분율 및 등급 계산
- 실시간 업데이트

### 4단계: 최종 배정

- 60% 기준 합격/불합격 분류
- 상대평가 등급 배정
- 학기 종료 처리

## 💾 데이터 구조

### ENROLLMENT_DATA JSON 구조

```json
{
  "gradeConfig": {
    "attendanceMaxScore": 20,
    "assignmentTotalScore": 50,
    "examTotalScore": 30,
    "latePenaltyPerSession": 0.5,
    "gradeDistribution": {"A": 30, "B": 40, "C": 20, "D": 10},
    "totalMaxScore": 100,
    "configuredAt": "2025-10-22T10:00:00"
  },
  "grade": {
    "attendance": {
      "maxScore": 20,
      "currentScore": 18.5,
      "rate": 92.5,
      "lateCount": 2,
      "latePenalty": 1.0,
      "percentage": 92.5
    },
    "assignments": [
      {"name": "과제1", "score": 9, "maxScore": 10},
      {"name": "중간고사", "score": 85, "maxScore": 100},
      {"name": "기말고사", "score": 92, "maxScore": 100}
    ],
    "total": {
      "score": 204.5,
      "maxScore": 230,
      "percentage": 88.9
    },
    "letterGrade": "A"
  }
}
```

### 엔티티 구조

#### EnrollmentExtendedTbl

수강신청 정보를 확장하여 성적 데이터를 저장합니다.

```java
@Entity
@Table(name = "ENROLLMENT_EXTENDED_TBL")
public class EnrollmentExtendedTbl {
    @Id
    @Column(name = "ENROLLMENT_IDX")
    private Integer enrollmentIdx;

    @Column(name = "STUDENT_IDX")
    private Integer studentIdx;

    @Column(name = "LEC_IDX")
    private Integer lecIdx;

    @Column(name = "ENROLLMENT_DATA", columnDefinition = "TEXT")
    private String enrollmentData; // JSON 데이터 저장

    // 기타 필드...
}
```

## 🎯 구현 세부 사항

### 출석 점수 계산

- 출석율 = (총수업일 - 결석일) / 총수업일 × 100
- 점수 = 출석율 × 만점 / 100
- 지각 감점: 교수 설정에 따라 지각 횟수 × 감점률

### 과제 점수 집계

- 개별 과제 점수 합산
- 과제 생성/채점 시 이벤트 발행
- GradeUpdateEvent("ASSIGNMENT") 트리거

### 총점 계산 공식

```text
총점 = 출석점수 + Σ(과제점수) + Σ(시험점수)
백분율 = (총점 / 총만점) × 100
```

### 등급 배정 알고리즘

1. 60% 미만 → F등급
2. 60% 이상 학생들을 성적순 정렬
3. 설정된 등급 분포에 따라 배정
4. 낙제자 수만큼 하위 등급에서 상위 등급으로 침범
5. 동점자는 모두 상위 등급에 배정

## 📈 진행 상황

- ✅ Phase 1: 성적 구성 및 조회 (100%)
- ✅ Phase 2: 출석/과제 점수 입력 (100%)
- ✅ Phase 3: 이벤트 기반 계산 (100%)
- ✅ Phase 4: 최종 등급 배정 (100%)
- ⏳ 프론트엔드 통합 (대기 중)

### 전체 진행률: 93%

## 🔗 관련 문서

- [브라우저 콘솔 테스트 가이드](../브라우저콘솔테스트/04-grade/00-README.md)
- [과제 평가 시스템](./과제평가/00-README.md)
- [API 명세서](./과제평가/01-API-SPECIFICATION.md)
- [시스템 설계 다이어그램](./06-SYSTEM-DESIGN.drawio)
- [전체 가이드](../../전체가이드/Phase4_Evaluation_Closure.md)

## 🧪 테스트 및 검증

### 브라우저 콘솔 테스트

성적 관리 시스템은 완전 독립 실행 가능한 브라우저 콘솔 테스트를 제공합니다.

#### 📁 테스트 파일 구조

```text
04-grade/
├── 00-README.md              # 📖 테스트 가이드 및 사용법
├── 01-grade-phase1-tests.js  # Phase 1: 성적 관리 핵심 기능 (5개 API)
├── 02-grade-phase3-tests.js  # Phase 3: 이벤트 기반 업데이트 (2개 API)
└── 11-TEST-FLOW.drawio       # 테스트 플로우 다이어그램
```

**📋 테스트 개요:**

- **총 7개 API 테스트** (Phase 1: 5개 + Phase 3: 2개)
- **완전 독립 실행**: 각 파일이 독립적으로 실행 가능
- **실제 서버 테스트**: `https://bluecrab.chickenkiller.com` 환경 사용
- **JWT 인증**: 실제 사용자 토큰으로 인증
- **lecSerial 기반**: 강의 코드로 데이터 조회/관리
- **enrollmentIdx 자동 조회**: Phase 3에서 자동으로 enrollmentIdx 조회 ⭐
