# 📊 Blue Crab LMS 성적 관리 시스템 구현 가이드

> **작성일**: 2025-10-18  
> **목적**: JSON 기반 성적 관리 시스템 구현 및 개발 가이드  
> **대상**: 백엔드 개발자

---

## 📋 개요

Blue Crab LMS의 성적 관리 시스템은 **ENROLLMENT_EXTENDED_TBL의 ENROLLMENT_DATA (JSON 컬럼)**을 활용하여 유연하고 확장 가능한 성적 관리를 제공합니다.

### 🎯 설계 원칙
1. **JSON 기반 저장**: 유연한 데이터 구조로 확장성 확보
2. **실시간 자동 계산**: 출석, 과제 점수 자동 집계
3. **POST 방식 통일**: 기존 시스템과의 일관성 유지
4. **백분위 등급 배정**: 상대평가 기준 등급 산출

---

## 🗃️ 데이터 구조

### ENROLLMENT_DATA JSON 스키마

```json
{
  "grade": {
    "attendance": {
      "maxScore": 20,
      "currentScore": 18.5,
      "rate": 92.5
    },
    "assignments": [
      {
        "name": "과제1",
        "score": 9,
        "maxScore": 10
      },
      {
        "name": "중간고사",
        "score": 85,
        "maxScore": 100
      },
      {
        "name": "기말고사",
        "score": 92,
        "maxScore": 100
      }
    ],
    "total": {
      "score": 204.5,
      "maxScore": 230,
      "percentage": 88.9
    },
    "letterGrade": "A"
  }
}
```

### 데이터 구성 요소

| 구분 | 설명 | 계산 방식 |
|------|------|-----------|
| **출석 점수** | 출석율 기반 자동 계산 | `출석율 × 지정 만점` |
| **과제 점수** | 개별 과제별 점수 관리 | `ASSIGNMENT_TBL`에서 집계 |
| **중간/기말고사** | 과제의 특수 형태 | 과제명으로 구분 |
| **합계 점수** | 전체 점수 총합 | 실시간 자동 계산 |
| **등급** | 백분위 기준 등급 | A, B, C, D, F |

---

## 🔧 API 설계

### 1. 성적 구성 설정

**엔드포인트**: `POST /api/enrollments/grade-config`

```javascript
// 요청 예시
{
  "lecIdx": 1,
  "attendanceMaxScore": 20,
  "assignmentTotalScore": 50,
  "examTotalScore": 30,
  "gradeDistribution": {
    "A": 30,  // 상위 30%
    "B": 40,  // 30~70%
    "C": 20,  // 70~90%
    "D": 10   // 나머지
  },
  "action": "set-config"
}

// 응답 예시
{
  "success": true,
  "message": "성적 구성이 설정되었습니다.",
  "data": {
    "lecIdx": 1,
    "gradeConfig": { ... }
  }
}
```

### 2. 개별 성적 조회

**엔드포인트**: `POST /api/enrollments/grade-info`

```javascript
// 요청 예시 (학생 본인 조회)
{
  "lecIdx": 1,
  "studentIdx": 100,
  "action": "get-grade"
}

// 요청 예시 (교수용 조회)
{
  "lecIdx": 1,
  "studentIdx": 100,
  "professorIdx": 22,
  "action": "professor-view"
}

// 응답 예시
{
  "success": true,
  "data": {
    "studentInfo": {
      "studentIdx": 100,
      "studentName": "홍길동",
      "studentId": "STU001"
    },
    "grade": {
      "attendance": {
        "maxScore": 20,
        "currentScore": 18.5,
        "rate": 92.5
      },
      "assignments": [ ... ],
      "total": {
        "score": 204.5,
        "maxScore": 230,
        "percentage": 88.9
      },
      "letterGrade": "A",
      "rank": 3,
      "totalStudents": 45
    }
  }
}
```

### 3. 전체 수강생 성적 목록

**엔드포인트**: `POST /api/enrollments/grade-list`

```javascript
// 요청 예시
{
  "lecIdx": 1,
  "page": 0,
  "size": 20,
  "sortBy": "percentage",  // percentage, name, studentId
  "sortOrder": "desc",     // asc, desc
  "action": "list-all"
}

// 응답 예시
{
  "success": true,
  "data": {
    "content": [
      {
        "studentIdx": 100,
        "studentName": "홍길동",
        "studentId": "STU001",
        "attendance": { ... },
        "assignments": [ ... ],
        "total": { ... },
        "letterGrade": "A",
        "rank": 1
      }
    ],
    "totalElements": 45,
    "totalPages": 3,
    "currentPage": 0
  }
}
```

### 4. 최종 등급 배정

**엔드포인트**: `POST /api/enrollments/grade-finalize`

```javascript
// 요청 예시
{
  "lecIdx": 1,
  "gradeDistribution": {
    "A": 30,
    "B": 40,
    "C": 20,
    "D": 10
  },
  "action": "finalize"
}

// 응답 예시
{
  "success": true,
  "message": "최종 등급이 배정되었습니다.",
  "data": {
    "gradeStats": {
      "A": 14,  // 14명
      "B": 18,  // 18명
      "C": 9,   // 9명
      "D": 4,   // 4명
      "F": 0    // 0명
    },
    "totalStudents": 45
  }
}
```

---

## 🏗️ 백엔드 구현

### EnrollmentController 확장

```java
@RestController
@RequestMapping("/api/enrollments")
public class EnrollmentController {

    @Autowired
    private EnrollmentService enrollmentService;

    @PostMapping("/grade-config")
    public ResponseEntity<?> setGradeConfig(@RequestBody Map<String, Object> request) {
        try {
            String action = (String) request.get("action");
            
            if ("set-config".equals(action)) {
                return handleGradeConfig(request);
            }
            
            return ResponseEntity.badRequest()
                .body(createErrorResponse("지원하지 않는 액션입니다."));
                
        } catch (Exception e) {
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR)
                .body(createErrorResponse("성적 구성 설정 중 오류가 발생했습니다."));
        }
    }

    @PostMapping("/grade-info")
    public ResponseEntity<?> getGradeInfo(@RequestBody Map<String, Object> request) {
        try {
            String action = (String) request.get("action");
            
            switch (action) {
                case "get-grade":
                    return handleStudentGradeInfo(request);
                case "professor-view":
                    return handleProfessorGradeView(request);
                default:
                    return ResponseEntity.badRequest()
                        .body(createErrorResponse("지원하지 않는 액션입니다."));
            }
            
        } catch (Exception e) {
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR)
                .body(createErrorResponse("성적 조회 중 오류가 발생했습니다."));
        }
    }

    @PostMapping("/grade-list")
    public ResponseEntity<?> getGradeList(@RequestBody Map<String, Object> request) {
        try {
            String action = (String) request.get("action");
            
            if ("list-all".equals(action)) {
                return handleGradeList(request);
            }
            
            return ResponseEntity.badRequest()
                .body(createErrorResponse("지원하지 않는 액션입니다."));
                
        } catch (Exception e) {
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR)
                .body(createErrorResponse("성적 목록 조회 중 오류가 발생했습니다."));
        }
    }

    @PostMapping("/grade-finalize")
    public ResponseEntity<?> finalizeGrades(@RequestBody Map<String, Object> request) {
        try {
            String action = (String) request.get("action");
            
            if ("finalize".equals(action)) {
                return handleGradeFinalize(request);
            }
            
            return ResponseEntity.badRequest()
                .body(createErrorResponse("지원하지 않는 액션입니다."));
                
        } catch (Exception e) {
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR)
                .body(createErrorResponse("등급 배정 중 오류가 발생했습니다."));
        }
    }
}
```

### EnrollmentService 구현

```java
@Service
@Transactional
public class EnrollmentService {

    @Autowired
    private EnrollmentExtendedRepository enrollmentExtendedRepository;
    
    @Autowired
    private AttendanceRepository attendanceRepository;
    
    @Autowired
    private AssignmentRepository assignmentRepository;

    /**
     * 성적 구성 설정
     */
    public ResponseEntity<?> setGradeConfig(Map<String, Object> request) {
        Integer lecIdx = (Integer) request.get("lecIdx");
        
        // 강의별 성적 구성 설정 로직
        // ENROLLMENT_DATA JSON 업데이트
        
        return ResponseEntity.ok(createSuccessResponse("성적 구성이 설정되었습니다."));
    }

    /**
     * 개별 학생 성적 계산 및 조회
     */
    public ResponseEntity<?> getStudentGradeInfo(Map<String, Object> request) {
        Integer lecIdx = (Integer) request.get("lecIdx");
        Integer studentIdx = (Integer) request.get("studentIdx");
        
        // 1. 출석 점수 계산
        Double attendanceScore = calculateAttendanceScore(lecIdx, studentIdx);
        
        // 2. 과제 점수 집계
        List<AssignmentScore> assignmentScores = calculateAssignmentScores(lecIdx, studentIdx);
        
        // 3. 총점 계산
        GradeInfo gradeInfo = calculateTotalScore(attendanceScore, assignmentScores);
        
        // 4. ENROLLMENT_DATA 업데이트
        updateEnrollmentGradeData(lecIdx, studentIdx, gradeInfo);
        
        return ResponseEntity.ok(createSuccessResponse(gradeInfo));
    }

    /**
     * 출석 점수 계산
     */
    private Double calculateAttendanceScore(Integer lecIdx, Integer studentIdx) {
        // ATTENDANCE_TBL에서 출석율 계산
        // 출석율 × 지정 만점 = 출석 점수
        return attendanceRepository.calculateAttendanceScore(lecIdx, studentIdx);
    }

    /**
     * 과제 점수 집계
     */
    private List<AssignmentScore> calculateAssignmentScores(Integer lecIdx, Integer studentIdx) {
        // ASSIGNMENT_TBL에서 해당 강의의 모든 과제 점수 조회
        return assignmentRepository.getStudentAssignmentScores(lecIdx, studentIdx);
    }

    /**
     * 최종 등급 배정 (백분위 기반)
     */
    public ResponseEntity<?> finalizeGrades(Map<String, Object> request) {
        Integer lecIdx = (Integer) request.get("lecIdx");
        Map<String, Integer> gradeDistribution = (Map<String, Integer>) request.get("gradeDistribution");
        
        // 1. 전체 수강생 성적 조회
        List<StudentGrade> allGrades = getAllStudentGrades(lecIdx);
        
        // 2. 성적순 정렬
        allGrades.sort((a, b) -> Double.compare(b.getPercentage(), a.getPercentage()));
        
        // 3. 백분위 기준 등급 배정
        assignLetterGrades(allGrades, gradeDistribution);
        
        // 4. ENROLLMENT_DATA 업데이트
        updateFinalGrades(allGrades);
        
        return ResponseEntity.ok(createSuccessResponse("등급 배정이 완료되었습니다."));
    }
}
```

---

## 📝 성적 관리 프로세스

### 1️⃣ 성적 구성 설정
- 교수가 강의별 성적 비율 설정
- 출석, 과제, 시험 배점 결정
- 등급 분포 기준 설정

### 2️⃣ 출석/과제 점수 입력
- 출석 점수: ATTENDANCE_TBL에서 자동 계산
- 과제 점수: ASSIGNMENT_TBL에서 자동 집계
- 실시간 반영 및 업데이트

### 3️⃣ 실시간 합계 계산
- JSON 데이터 자동 업데이트
- 백분율 계산
- 순위 산정

### 4️⃣ 최종 등급 배정
- 백분위 기준 등급 배정
- A, B, C, D, F 등급 부여
- 최종 성적 확정

---

## ✨ 주요 특징

### 🔄 실시간 자동 계산
- 출석, 과제 입력 시 즉시 반영
- JSON 기반 효율적 업데이트
- 성능 최적화된 계산 로직

### 📊 JSON 기반 유연성
- 확장 가능한 데이터 구조
- 동적 성적 구성 지원
- 복잡한 계산 로직 단순화

### 🎯 백분위 등급 배정
- 상대평가 기준 등급 산출
- 유연한 등급 분포 설정
- 공정한 성적 평가 보장

### 👨‍🏫 교수 전용 관리
- 교수별 권한 관리
- 강의별 독립적 성적 관리
- 직관적인 인터페이스 제공

---

## 🔧 개발 우선순위

### 1단계: 핵심 성적 관리 (2주)
- ✅ EnrollmentController 확장
- ✅ 성적 구성 설정 API
- ✅ 개별 성적 조회 API
- ✅ 자동 계산 로직 구현

### 2단계: 고급 기능 (1주)
- ✅ 전체 성적 목록 API
- ✅ 최종 등급 배정 API
- ✅ 백분위 계산 로직

### 3단계: 최적화 (1주)
- ✅ 성능 최적화
- ✅ 오류 처리 강화
- ✅ 테스트 코드 작성

---

## 📋 체크리스트

### 백엔드 구현
- [ ] EnrollmentController 확장
- [ ] EnrollmentService 구현  
- [ ] JSON 데이터 처리 로직
- [ ] 성적 계산 알고리즘
- [ ] 백분위 등급 배정 로직
- [ ] 오류 처리 및 검증

### 데이터베이스
- [ ] ENROLLMENT_EXTENDED_TBL 활용
- [ ] JSON 스키마 정의
- [ ] 인덱스 최적화
- [ ] 성능 튜닝

### 테스트
- [ ] 단위 테스트 작성
- [ ] 통합 테스트 작성  
- [ ] 브라우저 콘솔 테스트 스크립트
- [ ] 성능 테스트

---

## 🎯 결론

JSON 기반 성적 관리 시스템을 통해:

✅ **유연성**: 동적 성적 구성 및 확장 가능  
✅ **효율성**: 실시간 자동 계산으로 관리 부담 감소  
✅ **공정성**: 백분위 기준 객관적 등급 배정  
✅ **일관성**: 기존 POST 방식과 통합된 설계  

**다음 단계**: EnrollmentController 확장 개발 시작

---

> **참고 문서**  
> - [성적관리시스템_설계안_수정.drawio](./성적관리시스템_설계안_수정.drawio)  
> - [미구현기능_POST방식_통일가이드.md](../미구현기능_POST방식_통일가이드.md)