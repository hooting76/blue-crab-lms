# 03. ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§

> **ì‘ì„±ì¼**: 2025-10-10
> **ë²„ì „**: 2.1 (ëª…ëª… ê·œì¹™ í†µì¼ ë²„ì „)
> **ë³€ê²½ì‚¬í•­**: ëª¨ë“  í•„ë“œëª…ì„ ëŒ€ë¬¸ì + ì–¸ë”ìŠ¤ì½”ì–´ ê·œì¹™ìœ¼ë¡œ í†µì¼

---

## ğŸ¯ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ê°œìš”

ê°•ì˜ ê´€ë¦¬ ì‹œìŠ¤í…œì˜ í•µì‹¬ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ ì •ì˜í•©ë‹ˆë‹¤. ê° ê¸°ëŠ¥ë³„ë¡œ ì²˜ë¦¬ íë¦„, ìœ íš¨ì„± ê²€ì¦, ì˜ˆì™¸ ì²˜ë¦¬ ë“±ì„ ìƒì„¸íˆ ê¸°ìˆ í•©ë‹ˆë‹¤.

---

## ğŸ“‹ ëª©ì°¨

1. [ìˆ˜ê°•ì‹ ì²­ ë¡œì§](#1-ìˆ˜ê°•ì‹ ì²­-ë¡œì§)
2. [ì¶œê²° ê´€ë¦¬ ë¡œì§](#2-ì¶œê²°-ê´€ë¦¬-ë¡œì§)
3. [ì„±ì  ê´€ë¦¬ ë¡œì§](#3-ì„±ì -ê´€ë¦¬-ë¡œì§)
4. [ê°•ì˜ í‰ê°€ ë¡œì§](#4-ê°•ì˜-í‰ê°€-ë¡œì§)
5. [ë³´ê²° ìˆœìœ„ ë¡œì§](#5-ë³´ê²°-ìˆœìœ„-ë¡œì§)
6. [íœ´ê°• ì²˜ë¦¬ ë¡œì§](#6-íœ´ê°•-ì²˜ë¦¬-ë¡œì§)

---

## 1. ìˆ˜ê°•ì‹ ì²­ ë¡œì§

### **1.1 ìˆ˜ê°• ê°€ëŠ¥ ê°•ì˜ ì¡°íšŒ**

```java
public List<LectureDTO> getAvailableLectures(Student student, int year, int semester) {
    // 1. ê¸°ë³¸ ì¡°ê±´ í•„í„°ë§
    List<Lecture> lectures = lectureRepository.findByYearAndSemester(year, semester);

    // 2. ìˆ˜ê°• ê°€ëŠ¥ ê°•ì˜ í•„í„°ë§
    return lectures.stream()
        .filter(lecture -> isLectureAvailableForStudent(lecture, student))
        .map(this::convertToDTO)
        .collect(Collectors.toList());
}

private boolean isLectureAvailableForStudent(Lecture lecture, Student student) {
    // ì •ì› ì²´í¬
    if (lecture.getCurrentStudents() >= lecture.getMaxStudents()) {
        return false;
    }

    // ëŒ€ìƒ í•™ë¶€/í•™ê³¼ ì²´í¬
    if (!isEligibleDepartment(lecture, student)) {
        return false;
    }

    // ëŒ€ìƒ í•™ë…„ ì²´í¬
    if (!isEligibleGrade(lecture, student)) {
        return false;
    }

    // í•„ìˆ˜/êµì–‘ ì²´í¬ (ì „ê³µë³„)
    if (!isEligibleRequirement(lecture, student)) {
        return false;
    }

    return true;
}
```

### **1.2 ìˆ˜ê°•ì‹ ì²­ ì²˜ë¦¬**

```java
@Transactional
public EnrollmentResult enrollStudent(int lectureIdx, int studentIdx) {
    // 1. ê°•ì˜ ì •ë³´ ì¡°íšŒ (ë½ íšë“)
    Lecture lecture = lectureRepository.findByIdWithLock(lectureIdx);

    // 2. ìˆ˜ê°• ê°€ëŠ¥ ì—¬ë¶€ ê²€ì¦
    validateEnrollmentEligibility(lecture, studentIdx);

    // 3. ì •ì› ì²´í¬ ë° ì¦ê°€
    if (lecture.getCurrentStudents() >= lecture.getMaxStudents()) {
        // ë³´ê²° ìˆœìœ„ ë“±ë¡
        return registerWaitlist(lectureIdx, studentIdx);
    }

    // 4. ìˆ˜ê°•ì‹ ì²­ ì²˜ë¦¬
    Enrollment enrollment = createEnrollment(lecture, studentIdx);
    enrollmentRepository.save(enrollment);

    // 5. í˜„ì¬ ìˆ˜ê°•ì¸ì› ì¦ê°€
    lecture.setCurrentStudents(lecture.getCurrentStudents() + 1);
    lectureRepository.save(lecture);

    return EnrollmentResult.success(enrollment);
}
```

### **1.3 ìˆ˜ê°•ì‹ ì²­ ì·¨ì†Œ**

```java
@Transactional
public void cancelEnrollment(int enrollmentIdx) {
    // 1. ìˆ˜ê°•ì‹ ì²­ ì •ë³´ ì¡°íšŒ
    Enrollment enrollment = enrollmentRepository.findById(enrollmentIdx);

    // 2. ì·¨ì†Œ ê°€ëŠ¥ ê¸°ê°„ ê²€ì¦
    validateCancellationPeriod(enrollment);

    // 3. ìˆ˜ê°•ì‹ ì²­ ì‚­ì œ
    enrollmentRepository.delete(enrollment);

    // 4. ê°•ì˜ í˜„ì¬ ìˆ˜ê°•ì¸ì› ê°ì†Œ
    Lecture lecture = enrollment.getLecture();
    lecture.setCurrentStudents(lecture.getCurrentStudents() - 1);
    lectureRepository.save(lecture);

    // 5. ë³´ê²° ìˆœìœ„ ìŠ¹ê³„ ì²˜ë¦¬
    processWaitlistPromotion(lecture);
}
```

---

## 2. ì¶œê²° ê´€ë¦¬ ë¡œì§

### **2.1 ì¶œì„ ìš”ì²­ ì²˜ë¦¬**

```java
public AttendanceRequestResult requestAttendance(int enrollmentIdx, LocalDate attendanceDate) {
    // 1. ìˆ˜ê°•ì‹ ì²­ ì •ë³´ ê²€ì¦
    Enrollment enrollment = enrollmentRepository.findById(enrollmentIdx);
    validateEnrollmentStatus(enrollment);

    // 2. ì¶œì„ ê°€ëŠ¥ ì‹œê°„ëŒ€ ê²€ì¦
    validateAttendanceTime(attendanceDate);

    // 3. ì´ë¯¸ ì¶œì„ ìš”ì²­í–ˆëŠ”ì§€ ì²´í¬
    if (hasExistingRequest(enrollmentIdx, attendanceDate)) {
        return AttendanceRequestResult.duplicate();
    }

    // 4. ì¶œì„ ìš”ì²­ ìƒì„±
    Attendance attendance = Attendance.builder()
        .enrollment(enrollment)
        .attendanceDate(attendanceDate)
        .status(AttendanceStatus.REQUESTED)
        .requestedAt(LocalDateTime.now())
        .build();

    attendanceRepository.save(attendance);

    // 5. êµìˆ˜ ì•Œë¦¼ ë°œì†¡
    notifyProfessor(attendance);

    return AttendanceRequestResult.success(attendance);
}
```

### **2.2 ì¶œì„ ìŠ¹ì¸ ì²˜ë¦¬**

```java
@Transactional
public void approveAttendance(int attendanceIdx, int professorIdx) {
    // 1. ì¶œì„ ì •ë³´ ì¡°íšŒ
    Attendance attendance = attendanceRepository.findById(attendanceIdx);

    // 2. ê¶Œí•œ ê²€ì¦ (ë‹´ë‹¹ êµìˆ˜ì¸ì§€)
    validateProfessorPermission(attendance, professorIdx);

    // 3. ì¶œì„ ìƒíƒœ ì—…ë°ì´íŠ¸
    attendance.setStatus(AttendanceStatus.PRESENT);
    attendance.setApprovedAt(LocalDateTime.now());
    attendance.setApprovedBy(professorIdx);

    attendanceRepository.save(attendance);

    // 4. í•™ìƒ ì•Œë¦¼ ë°œì†¡
    notifyStudent(attendance);

    // 5. ì¶œì„ë¥  ì¬ê³„ì‚°
    updateAttendanceRate(attendance.getEnrollment());
}
```

---

## 3. ì„±ì  ê´€ë¦¬ ë¡œì§

### **3.1 ì„±ì  ì…ë ¥ ê²€ì¦**

```java
public void validateGradeInput(GradeInput input) {
    // 1. ì ìˆ˜ ë²”ìœ„ ê²€ì¦
    validateScoreRange(input.getMidtermScore(), "ì¤‘ê°„ê³ ì‚¬");
    validateScoreRange(input.getFinalScore(), "ê¸°ë§ê³ ì‚¬");
    validateScoreRange(input.getAssignmentScore(), "ê³¼ì œ");
    validateScoreRange(input.getParticipationScore(), "ì°¸ì—¬ë„");

    // 2. ì´ì  ê³„ì‚° ë° ê²€ì¦
    double totalScore = calculateTotalScore(input);
    validateTotalScore(totalScore);

    // 3. í•™ì  ë³€í™˜
    String grade = convertScoreToGrade(totalScore);
    input.setGrade(grade);
}

private void validateScoreRange(Double score, String subject) {
    if (score != null && (score < 0 || score > 100)) {
        throw new InvalidScoreException(subject + " ì ìˆ˜ëŠ” 0-100 ì‚¬ì´ì—¬ì•¼ í•©ë‹ˆë‹¤.");
    }
}
```

### **3.2 ì„±ì  ì €ì¥ ë° ì—…ë°ì´íŠ¸**

```java
@Transactional
public void saveGrades(int lectureIdx, List<GradeInput> gradeInputs) {
    // 1. ê°•ì˜ ê¶Œí•œ ê²€ì¦
    validateProfessorLectureAccess(lectureIdx);

    // 2. ê° ì„±ì  ì²˜ë¦¬
    for (GradeInput input : gradeInputs) {
        Enrollment enrollment = enrollmentRepository.findByLectureAndStudent(lectureIdx, input.getStudentIdx());

        // ì„±ì  ì—…ë°ì´íŠ¸
        enrollment.setMidtermScore(input.getMidtermScore());
        enrollment.setFinalScore(input.getFinalScore());
        enrollment.setAssignmentScore(input.getAssignmentScore());
        enrollment.setParticipationScore(input.getParticipationScore());
        enrollment.setTotalScore(calculateTotalScore(input));
        enrollment.setGrade(input.getGrade());
        enrollment.setIsEvaluated(true);

        enrollmentRepository.save(enrollment);
    }

    // 3. ê°•ì˜ í‰ê°€ ìƒíƒœ ì—…ë°ì´íŠ¸
    updateLectureEvaluationStatus(lectureIdx);
}
```

---

## 4. ê°•ì˜ í‰ê°€ ë¡œì§

### **4.1 í‰ê°€ í•­ëª© ë™ì  ê´€ë¦¬**

```java
public List<EvaluationItem> getEvaluationItems(int lectureIdx) {
    // 1. ê°•ì˜ë³„ í‰ê°€ í•­ëª© ì¡°íšŒ
    List<EvaluationItem> items = evaluationItemRepository.findByLectureIdx(lectureIdx);

    // 2. ê¸°ë³¸ í•­ëª©ì´ ì—†ìœ¼ë©´ ìƒì„±
    if (items.isEmpty()) {
        items = createDefaultEvaluationItems(lectureIdx);
    }

    return items;
}

private List<EvaluationItem> createDefaultEvaluationItems(int lectureIdx) {
    List<EvaluationItem> defaultItems = Arrays.asList(
        EvaluationItem.builder().lectureIdx(lectureIdx).itemName("ê°•ì˜ ë‚´ìš©").build(),
        EvaluationItem.builder().lectureIdx(lectureIdx).itemName("ê°•ì˜ ë°©ì‹").build(),
        EvaluationItem.builder().lectureIdx(lectureIdx).itemName("í‰ê°€ ë°©ë²•").build(),
        EvaluationItem.builder().lectureIdx(lectureIdx).itemName("í•™ìŠµ íš¨ê³¼").build(),
        EvaluationItem.builder().lectureIdx(lectureIdx).itemName("ì „ë°˜ì  ë§Œì¡±ë„").build()
    );

    return evaluationItemRepository.saveAll(defaultItems);
}
```

### **4.2 í‰ê°€ ì œì¶œ ë° í†µê³„**

```java
@Transactional
public void submitEvaluation(EvaluationSubmission submission) {
    // 1. í‰ê°€ ê°€ëŠ¥ ê¸°ê°„ ê²€ì¦
    validateEvaluationPeriod(submission.getLectureIdx());

    // 2. ì¤‘ë³µ í‰ê°€ ì²´í¬
    if (hasAlreadyEvaluated(submission.getLectureIdx(), submission.getStudentIdx())) {
        throw new DuplicateEvaluationException("ì´ë¯¸ í‰ê°€ë¥¼ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤.");
    }

    // 3. í‰ê°€ ì €ì¥
    LectureEvaluation evaluation = convertToEntity(submission);
    evaluationRepository.save(evaluation);

    // 4. í‰ê°€ í†µê³„ ì—…ë°ì´íŠ¸
    updateEvaluationStatistics(submission.getLectureIdx());
}
```

---

## 5. ë³´ê²° ìˆœìœ„ ë¡œì§

### **5.1 ë³´ê²° ë“±ë¡**

```java
@Transactional
public WaitlistResult registerWaitlist(int lectureIdx, int studentIdx) {
    // 1. ì •ì› ì´ˆê³¼ í™•ì¸
    Lecture lecture = lectureRepository.findById(lectureIdx);
    if (lecture.getCurrentStudents() < lecture.getMaxStudents()) {
        throw new InvalidWaitlistException("ì •ì›ì´ ì´ˆê³¼ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
    }

    // 2. ì´ë¯¸ ìˆ˜ê°•ì‹ ì²­í–ˆëŠ”ì§€ ì²´í¬
    if (enrollmentRepository.existsByLectureAndStudent(lectureIdx, studentIdx)) {
        throw new InvalidWaitlistException("ì´ë¯¸ ìˆ˜ê°•ì‹ ì²­í–ˆìŠµë‹ˆë‹¤.");
    }

    // 3. ë³´ê²° ìˆœìœ„ ê³„ì‚° ë° ë“±ë¡
    int waitlistOrder = getNextWaitlistOrder(lectureIdx);

    Waitlist waitlist = Waitlist.builder()
        .lectureIdx(lectureIdx)
        .studentIdx(studentIdx)
        .waitlistOrder(waitlistOrder)
        .registeredAt(LocalDateTime.now())
        .build();

    waitlistRepository.save(waitlist);

    return WaitlistResult.success(waitlistOrder);
}
```

### **5.2 ë³´ê²° ìŠ¹ê³„ ì²˜ë¦¬**

```java
@Transactional
public void processWaitlistPromotion(Lecture lecture) {
    // 1. ë¹ˆ ìë¦¬ ìˆ˜ ê³„ì‚°
    int availableSlots = lecture.getMaxStudents() - lecture.getCurrentStudents();
    if (availableSlots <= 0) return;

    // 2. ìŠ¹ê³„ ëŒ€ìƒ ì¡°íšŒ
    List<Waitlist> promotableWaitlists = waitlistRepository
        .findByLectureIdxOrderByWaitlistOrder(lecture.getLectureIdx())
        .stream()
        .limit(availableSlots)
        .collect(Collectors.toList());

    // 3. ìŠ¹ê³„ ì²˜ë¦¬
    for (Waitlist waitlist : promotableWaitlists) {
        // ìˆ˜ê°•ì‹ ì²­ ìƒì„±
        Enrollment enrollment = createEnrollment(lecture, waitlist.getStudentIdx());
        enrollmentRepository.save(enrollment);

        // í˜„ì¬ ìˆ˜ê°•ì¸ì› ì¦ê°€
        lecture.setCurrentStudents(lecture.getCurrentStudents() + 1);

        // ë³´ê²° ëª©ë¡ì—ì„œ ì œê±°
        waitlistRepository.delete(waitlist);

        // í•™ìƒ ì•Œë¦¼
        notifyWaitlistPromotion(enrollment);
    }

    lectureRepository.save(lecture);
}
```

---

## 6. íœ´ê°• ì²˜ë¦¬ ë¡œì§

### **6.1 íœ´ê°• ë“±ë¡ ë° ìŠ¤ì¼€ì¤„ ì¡°ì •**

```java
@Transactional
public void registerCancellation(int lectureIdx, LocalDate cancellationDate, String reason) {
    // 1. ê°•ì˜ ê¶Œí•œ ê²€ì¦
    validateProfessorLectureAccess(lectureIdx);

    // 2. íœ´ê°• ì •ë³´ ìƒì„±
    LectureCancellation cancellation = LectureCancellation.builder()
        .lectureIdx(lectureIdx)
        .cancellationDate(cancellationDate)
        .reason(reason)
        .registeredAt(LocalDateTime.now())
        .build();

    cancellationRepository.save(cancellation);

    // 3. ìŠ¤ì¼€ì¤„ ìë™ ì¡°ì •
    adjustLectureSchedule(lectureIdx, cancellationDate);
}

private void adjustLectureSchedule(int lectureIdx, LocalDate cancellationDate) {
    Lecture lecture = lectureRepository.findById(lectureIdx);

    // ì›ë˜ ìŠ¤ì¼€ì¤„ì—ì„œ íœ´ê°•ì¼ì— í•´ë‹¹í•˜ëŠ” ì‹œê°„ ì°¾ê¸°
    List<LectureSchedule> affectedSchedules = lectureScheduleRepository
        .findByLectureIdxAndDate(lectureIdx, cancellationDate);

    // ê° ìŠ¤ì¼€ì¤„ì— ëŒ€í•´ ë‹¤ìŒ ê°€ëŠ¥í•œ ì‹œê°„ìœ¼ë¡œ ì´ë™
    for (LectureSchedule schedule : affectedSchedules) {
        LocalDateTime nextAvailableTime = findNextAvailableTime(schedule);
        schedule.setScheduledTime(nextAvailableTime);
        lectureScheduleRepository.save(schedule);
    }

    // ê°•ì˜ ì¢…ë£Œì¼ ì—°ì¥
    extendLectureEndDate(lecture);
}
```

### **6.2 íœ´ê°• ë³´ê°• ì²˜ë¦¬**

```java
public void scheduleMakeupClass(int lectureIdx, LocalDateTime makeupDateTime) {
    // 1. íœ´ê°• ì •ë³´ ì¡°íšŒ
    List<LectureCancellation> cancellations = cancellationRepository
        .findUncompensatedByLectureIdx(lectureIdx);

    if (cancellations.isEmpty()) {
        throw new NoCancellationException("ë³´ê°•í•  íœ´ê°•ì´ ì—†ìŠµë‹ˆë‹¤.");
    }

    // 2. ë³´ê°• ìˆ˜ì—… ìŠ¤ì¼€ì¤„ ìƒì„±
    LectureSchedule makeupSchedule = LectureSchedule.builder()
        .lectureIdx(lectureIdx)
        .scheduledTime(makeupDateTime)
        .isMakeupClass(true)
        .build();

    lectureScheduleRepository.save(makeupSchedule);

    // 3. íœ´ê°• ë³´ìƒ ì²˜ë¦¬
    for (LectureCancellation cancellation : cancellations) {
        cancellation.setCompensated(true);
        cancellation.setMakeupScheduleIdx(makeupSchedule.getScheduleIdx());
        cancellationRepository.save(cancellation);
    }
}
```

---

## ğŸ¯ ë‹¤ìŒ ë‹¨ê³„

ì´ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ ë°”íƒ•ìœ¼ë¡œ [ê´€ë¦¬ì í”Œë¡œìš°](./04-ê´€ë¦¬ìí”Œë¡œìš°.md)ì—ì„œ êµ¬ì²´ì ì¸ ì‚¬ìš©ì ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ì •ì˜í•©ë‹ˆë‹¤.