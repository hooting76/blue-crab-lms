# 날짜 기준 만료 처리 명세서

## 📅 개요

출석 요청의 만료 처리는 **시간이 아닌 날짜 기준**으로 처리됩니다.

---

## ⏰ 만료 기준

### 기본 원칙
- **24시간 × 7일이 아닌, 날짜 변동 카운트 방식**
- 요청 시각과 관계없이 7일 후 날짜의 00:00:00을 만료 시점으로 설정
- 스케줄러는 매일 오전 5시에 실행되어 만료 날짜가 된 요청을 즉시 처리

---

## 📊 시나리오별 처리 예시

### 시나리오 1: 오전 요청
```
요청 일시: 2025-10-23 08:00:00
만료 날짜: 2025-10-30 00:00:00 (7일 후)

처리 시점: 2025-10-30 05:00:00 (스케줄러 실행)
→ ✅ 바로 자동 승인
→ ❌ 08:00까지 기다리지 않음
```

### 시나리오 2: 오후 요청
```
요청 일시: 2025-10-23 14:30:00
만료 날짜: 2025-10-30 00:00:00 (7일 후)

처리 시점: 2025-10-30 05:00:00 (스케줄러 실행)
→ ✅ 바로 자동 승인
→ ❌ 14:30까지 기다리지 않음
```

### 시나리오 3: 심야 요청
```
요청 일시: 2025-10-23 23:50:00
만료 날짜: 2025-10-30 00:00:00 (7일 후)

처리 시점: 2025-10-30 05:00:00 (스케줄러 실행)
→ ✅ 바로 자동 승인
→ ❌ 23:50까지 기다리지 않음
```

---

## 🔄 처리 흐름

### 1. 출석 요청 시 (Service)
```java
// 요청 일시
LocalDateTime requestDate = LocalDateTime.now();  // 예: 2025-10-23 08:00:00

// 만료 날짜 설정 (시간을 00:00:00으로 초기화)
LocalDateTime expiresAt = requestDate
    .plusDays(7)                // 7일 후
    .withHour(0)                // 00시
    .withMinute(0)              // 00분
    .withSecond(0)              // 00초
    .withNano(0);               // 00나노초
// 결과: 2025-10-30 00:00:00
```

### 2. 스케줄러 실행 시 (Scheduler)
```java
// 오늘 날짜 (시간 제외)
LocalDate today = LocalDate.now();  // 예: 2025-10-30

// 만료된 요청 필터링
List<AttendancePendingRequestDto> expiredRequests = pendingRequests.stream()
    .filter(request -> {
        LocalDate expiresDate = request.getExpiresAt().toLocalDate();
        // 만료 날짜가 오늘이거나 이전이면 만료됨
        return !expiresDate.isAfter(today);
    })
    .collect(Collectors.toList());

// 결과: expiresAt이 2025-10-30 00:00:00인 요청은
//       2025-10-30 05:00:00 스케줄러에서 처리됨
```

---

## 📈 날짜 계산 예시

| 요청 일시 | 만료 날짜 (expiresAt) | 스케줄러 처리 시점 | 실제 경과 시간 |
|-----------|---------------------|-----------------|--------------|
| 10/23 08:00 | 10/30 00:00 | 10/30 05:00 | 6일 21시간 |
| 10/23 14:00 | 10/30 00:00 | 10/30 05:00 | 6일 15시간 |
| 10/23 23:00 | 10/30 00:00 | 10/30 05:00 | 6일 6시간 |

→ **공통점**: 모두 날짜 기준 7일 후 (10/30)의 첫 스케줄러(05:00)에서 처리

---

## ⚙️ 구현 코드

### AttendanceRequestServiceImpl.java (출석 요청)
```java
// pendingRequests에 추가
AttendancePendingRequestDto newRequest = new AttendancePendingRequestDto();
newRequest.setSessionNumber(sessionNumber);
newRequest.setRequestDate(LocalDateTime.now());

// 날짜 기준 7일 후 (시간 무관, 날짜만 카운트)
// 예: 10/23 08:00 요청 → 10/30 05:00 스케줄러에서 처리
newRequest.setExpiresAt(
    LocalDateTime.now()
        .plusDays(7)
        .withHour(0)
        .withMinute(0)
        .withSecond(0)
        .withNano(0)
);

newRequest.setTempApproved(true);
```

### AttendanceScheduler.java (자동 승인)
```java
@Scheduled(cron = "0 0 5 * * *")  // 매일 오전 5시
@Transactional
public void processExpiredRequests() {
    LocalDate today = LocalDate.now(); // 오늘 날짜 (시간 제외)
    
    // 만료된 요청 필터링 (날짜 기준)
    List<AttendancePendingRequestDto> expiredRequests = 
        attendanceData.getPendingRequests().stream()
            .filter(request -> {
                LocalDate expiresDate = request.getExpiresAt().toLocalDate();
                // 만료 날짜가 오늘이거나 이전이면 만료됨
                return !expiresDate.isAfter(today);
            })
            .collect(Collectors.toList());
    
    // sessions에 "출석"으로 이동
    for (AttendancePendingRequestDto expiredRequest : expiredRequests) {
        moveToSessions(attendanceData, expiredRequest);
    }
}
```

---

## ✅ 장점

1. **일관성**: 요청 시각과 무관하게 동일한 날짜에 처리
2. **예측 가능**: "7일 후"를 사용자가 직관적으로 이해 가능
3. **간단한 관리**: 스케줄러 실행 시각 고정 (매일 05:00)
4. **공정성**: 모든 요청이 동일한 날짜 기준으로 처리됨

---

## ⚠️ 주의사항

### 1. 시간 손실/이득
- 오전 요청: 약간의 시간 손실 (최대 5시간)
- 심야 요청: 약간의 시간 이득 (최대 19시간)
- **평균**: 약 7일 (날짜 기준)

### 2. 스케줄러 실행 시각
- 오전 5시로 고정
- 서버 시간대 기준 (Asia/Seoul)
- 변경 시 `cron` 표현식 수정

### 3. 시간대 설정
```properties
# application.properties
spring.jackson.time-zone=Asia/Seoul
```

---

## 🔄 처리 타임라인

```
Day 1 (10/23)
08:00 - 출석 요청
        ↓
        expiresAt = 10/30 00:00:00 설정
        ↓
        pendingRequests에 저장

Day 2-6 (10/24~10/29)
05:00 - 스케줄러 실행
        ↓
        expiresAt(10/30) > today(10/24~10/29)
        ↓
        아직 만료 안 됨, 대기 상태 유지

Day 7 (10/30)
05:00 - 스케줄러 실행 ✅
        ↓
        expiresAt(10/30) == today(10/30)
        ↓
        만료됨! 자동 승인 처리
        ↓
        sessions에 "출석" 추가
        ↓
        pendingRequests에서 제거
```

---

## 📝 요약

| 항목 | 내용 |
|------|------|
| **만료 기준** | 날짜 기준 7일 후 (시간 무관) |
| **만료 시점** | 요청일 + 7일의 00:00:00 |
| **처리 시점** | 만료 날짜의 오전 5시 스케줄러 |
| **처리 방식** | sessions에 "출석" 추가 |
| **시간 경과** | 약 6일 ~ 7일 (평균 6.5일) |
| **장점** | 일관성, 예측 가능, 공정성 |

---

## 참고 문서
- `AttendanceRequestServiceImpl.java` - 출석 요청 로직
- `AttendanceScheduler.java` - 자동 승인 스케줄러
- `AttendancePendingRequestDto.java` - 대기 요청 DTO
