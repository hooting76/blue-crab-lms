# 출석 요청/승인 기능 구현 작업 순서

## 📋 전체 작업 개요

출석 요청/승인 기능을 구현하기 위한 단계별 작업 계획입니다.

---

## Phase 1: 기반 작업 (데이터 구조 및 엔티티)

### 1. DB 스키마 확인 및 Entity 수정 ✅ **완료**
- [x] `ENROLLMENT_EXTENDED_TBL` 엔티티 확인
- [x] JSON 필드 구조 확인 (ENROLLMENT_DATA: LONGTEXT)
- [x] attendance 필드 구조 설계 (summary, sessions, pendingRequests)
- [x] JSON 구조 명세서 작성 (`전체가이드/데이터구조/ENROLLMENT_DATA_JSON_명세서.md`)
- [x] 용량 분석 완료 (24KB vs 4GB 여유 확인)
- [x] 브라우저 콘솔 테스트 스크립트 작성

**실제 소요 시간:** 1시간

**산출물:**
- Entity 클래스 검증 완료 (`EnrollmentExtendedTbl.java`)
- JSON 구조 문서화 및 용량 분석
- 브라우저 테스트 스크립트 (prompt 기반)

---

### 2. DTO 클래스 생성 ✅ **완료**
- [x] `AttendanceRequestRequestDto` (출석 요청 Request)
- [x] `AttendanceApproveRequestDto` (출석 승인 Request)
- [x] `AttendanceApprovalRecordDto` (승인 레코드 배열 요소)
- [x] `AttendanceResponseDto<T>` (공통 응답, 제네릭)
- [x] `AttendanceDataDto` (전체 출석 데이터)
- [x] `AttendanceSessionDto` (세션 정보)
- [x] `AttendancePendingRequestDto` (대기 중인 요청)
- [x] `AttendanceSummaryDto` (출석 통계)
- [x] `StudentAttendanceDto` (교수용 학생 출석 정보)
- [x] Jackson JSON 어노테이션 적용 (`@JsonFormat`)
- [x] Validation 어노테이션 적용 (`@NotNull`, `@Min`, `@Max`, `@Pattern`)

**실제 소요 시간:** 1시간

**산출물:**
- `dto/Lecture/attendance/` 패키지 내 DTO 클래스 9개
- `README.md` (패키지 구조 및 사용법 문서화)

---

## Phase 2: Repository 및 Service Layer

### 3. Repository 계층 ✅ **완료**
- [x] `EnrollmentExtendedRepository` 메서드 추가
- [x] JSON 필드 조회/업데이트 쿼리 작성
- [x] 학생의 수강 강의 조회 메서드
- [x] 교수의 담당 강의 조회 메서드
- [x] Custom Query 작성 (JOIN FETCH)

**실제 소요 시간:** 2시간

**산출물:**
- Repository 인터페이스 메서드 3개 추가
- `findByLecSerialWithDetails()` - 강의별 수강생 조회
- `findByLecSerialAndStudentIdx()` - 학생별 수강 정보 조회
- `findByLecSerialAndProfessorIdx()` - 교수 권한 검증용 조회

---

### 4. Service 계층 구현 ✅ **완료**
- [x] `AttendanceRequestService` 인터페이스 생성
- [x] `AttendanceRequestServiceImpl` 구현 클래스 생성
- [x] 출석 요청 로직 (`requestAttendance`)
- [x] 출석 승인 로직 (`approveAttendance`)
- [x] JSON 데이터 파싱/업데이트 유틸리티
- [x] 출석율 계산 로직 (`calculateSummary`)
- [x] 권한 검증 로직
- [x] 중복 요청 처리 로직
- [x] 에러 핸들링

**실제 소요 시간:** 4시간

**산출물:**
- `AttendanceRequestService` 인터페이스
- `AttendanceRequestServiceImpl` 구현 클래스 (500줄)
- JSON 파싱/직렬화 유틸리티 메서드
- 패키지 구조: `service/Lecture/Attendance/`

---

## Phase 3: Controller 및 API

### 5. Controller 생성 ✅ **완료**
- [x] `AttendanceController` 클래스 생성
- [x] `POST /api/attendance/request` 엔드포인트 구현
- [x] `POST /api/attendance/approve` 엔드포인트 구현
- [x] `POST /api/attendance/student/view` 엔드포인트 구현
- [x] `POST /api/attendance/professor/view` 엔드포인트 구현
- [x] 요청 데이터 검증 (`@Valid` 어노테이션)
- [x] 에러 핸들링 및 응답 포맷팅
- [x] 로깅 추가

**실제 소요 시간:** 2시간

**산출물:**
- `AttendanceController` 클래스 (296줄)
- API 엔드포인트 4개 (모두 POST 방식)
- 패키지 구조: `controller/Lecture/Attendance/`

---

### 6. Security 설정 ✅ **완료**
- [x] `SecurityConfig`에 출석 API 권한 설정 추가
- [x] 학생용 API: `authenticated()`
- [x] 교수용 API: `hasAnyRole("PROFESSOR", "ADMIN")`
- [x] OPTIONS 요청 허용 (CORS)

**실제 소요 시간:** 0.5시간

**산출물:**
- `SecurityConfig.java` 수정 완료
- CORS 설정 확인 (기존 /api/* 패턴 적용)

---

## Phase 4: 자동 승인 스케줄러 ✅ **완료**

### 7. 스케줄러 구현 ✅ **완료**
- [x] `AttendanceScheduler` 클래스 생성
- [x] `@Scheduled` 어노테이션 설정 (매일 오전 5시)
- [x] 날짜 기준 만료 처리 로직 (시간 무관, LocalDate 비교)
- [x] `moveToSessions` 메서드 구현
- [x] `recalculateSummary` 메서드 구현
- [x] 로깅 및 모니터링
- [x] 예외 처리 (개별 실패 시 계속 진행)
- [x] 만료 날짜 계산: 요청일 + 7일의 00:00:00

**실제 소요 시간:** 2시간

**산출물:**
- `AttendanceScheduler` 클래스 (320줄)
- 날짜 기준 만료 처리 로직 (`!expiresDate.isAfter(today)`)
- 패키지 구조: `scheduler/`

---

### 8. 스케줄러 활성화 ✅ **완료**
- [x] `@EnableScheduling` 설정 추가 (BlueCrabApplication)
- [x] 스케줄러 테스트 환경 구성
- [x] 수동 실행 메서드 추가 (`manualTrigger`)

**실제 소요 시간:** 0.5시간

**산출물:**
- Spring Boot Application 설정 수정
- 스케줄러 수동 실행 기능

---

## Phase 5: 테스트 및 검증 🔄 **진행 중 (68% 완료, 17/25h)**

### 9. 단위 테스트 🔄 **대기 (선택사항)**
- [ ] `AttendanceServiceTest` 작성
- [ ] JSON 파싱/업데이트 로직 테스트
- [ ] 출석율 계산 로직 테스트
- [ ] 권한 검증 로직 테스트
- [ ] Mock 객체 활용

**예상 소요 시간:** 3시간

**산출물:**
- JUnit 테스트 클래스

---

### 10. 통합 테스트 및 API 테스트 ✅ **완료**
- [x] 브라우저 콘솔 테스트 스크립트 작성 (4개 파일)
- [x] 로그인 API 테스트 (JWT 토큰 발급)
- [x] 출석 요청 API 테스트 (학생) ✅
- [x] 출석 승인 API 테스트 (교수) ✅
- [x] 학생 출석 조회 API 테스트 ✅
- [x] 교수 출석 조회 API 테스트 ✅
- [x] 엔드-투-엔드 시나리오 테스트 (요청→승인→조회) ✅
- [x] 토큰 인증 우선순위 수정 (window.authToken 우선)
- [x] Repository 쿼리 최적화 (교수 검증: LEC_PROF = CAST(professorIdx))
- [x] 응답 필드 매핑 수정 (attendanceData 중첩 구조)
- [x] 필드명 수정 (recordedAt → approvedDate, requestedAt → requestDate)
- [x] 권한 검증 테스트 (교수 검증, JWT 토큰 인증) ✅
- [ ] API 엔드포인트 테스트 (`@SpringBootTest`) - 선택사항
- [ ] 스케줄러 동작 테스트 (다음 단계)

**실제 소요 시간:** 4시간 (예상 2시간)

**테스트 완료 항목:**
- ✅ 4개 API 엔드포인트 모두 정상 작동 확인
  - `POST /api/attendance/request` (학생 출석 요청)
  - `POST /api/attendance/approve` (교수 출석 승인)
  - `POST /api/attendance/student/view` (학생 출석 조회)
  - `POST /api/attendance/professor/view` (교수 출석 조회)
- ✅ JWT 토큰 인증 정상 작동
- ✅ 교수 권한 검증 정상 작동 (LEC_PROF 비교)
- ✅ JSON 데이터 파싱/직렬화 정상 작동
- ✅ 출석율 계산 정확성 확인
- ✅ pendingRequests ↔ sessions 이동 로직 정상

**산출물:**
- 브라우저 콘솔 테스트 스크립트 (`docs/강의관련기능/브라우저콘솔테스트/06-attendance/`)
  - `01-attendance-request.js` (학생 출석 요청)
  - `02-attendance-approve.js` (교수 출석 승인, 학생 목록 조회 포함)
  - `03-student-view.js` (학생 출석 조회)
  - `04-professor-view.js` (교수 출석 조회)
- 실제 백엔드 API 검증 완료
- 버그 수정:
  - 토큰 우선순위: `window.authToken` > localStorage > sessionStorage
  - Repository 쿼리: `l.lecProf = CAST(:professorIdx AS string)`
  - 응답 구조: 교수용 API는 `attendanceData` 중첩, 학생용 API는 최상위
  - 필드명: `approvedDate`, `requestDate` 사용

---

### 11. 데이터 마이그레이션
- [ ] 기존 데이터 백업
- [ ] 마이그레이션 스크립트 실행
- [ ] 새 구조로 데이터 변환
- [ ] 데이터 검증
- [ ] 롤백 계획 수립

**예상 소요 시간:** 2시간

**산출물:**
- 마이그레이션 스크립트
- 백업 파일
- 검증 리포트

---

## Phase 6: 문서화 및 배포

### 12. API 문서화
- [ ] Swagger/OpenAPI 어노테이션 추가
- [ ] API 명세서 작성
- [ ] 요청/응답 예시 추가
- [ ] 에러 코드 정의 문서
- [ ] README 업데이트

**예상 소요 시간:** 1.5시간

**산출물:**
- Swagger UI 문서
- API 명세서 마크다운

---

### 13. 배포 준비
- [ ] 프론트엔드 팀과 API 스펙 공유
- [ ] 테스트 서버 빌드 및 배포
- [ ] 테스트 서버 검증
- [ ] 운영 서버 배포 계획 수립
- [ ] 모니터링 설정

**예상 소요 시간:** 2시간

**산출물:**
- 배포 체크리스트
- 모니터링 대시보드

---

## 📊 전체 예상 소요 시간

| Phase | 예상 시간 | 실제 시간 | 상태 |
|-------|----------|----------|------|
| Phase 1 | 3.5시간 | 2시간 | ✅ 완료 |
| Phase 2 | 6시간 | 6시간 | ✅ 완료 |
| Phase 3 | 2.5시간 | 2.5시간 | ✅ 완료 |
| Phase 4 | 2.5시간 | 2.5시간 | ✅ 완료 |
| Phase 5 | 7시간 | - | 🟡 대기 |
| Phase 6 | 3.5시간 | - | 🟡 대기 |
| **총계** | **25시간** | **13시간** | **52% 완료** |

---

## 🎯 우선순위 순서

1. ✅ DTO 클래스 생성 (Phase 1-2) - **완료**
2. ✅ Repository 계층 구현 (Phase 2-3) - **완료**
3. ✅ Service 계층 구현 (Phase 2-4) - **완료**
4. ✅ Controller 구현 (Phase 3-5) - **완료**
5. ✅ Security 설정 (Phase 3-6) - **완료**
6. ✅ 스케줄러 구현 (Phase 4-7,8) - **완료**
7. 🟡 테스트 및 검증 (Phase 5) - **진행 예정**
8. 🟡 문서화 및 배포 (Phase 6) - **대기**

---

## 📝 참고사항

- 각 단계별로 Git 커밋 권장
- 코드 리뷰 후 다음 단계 진행
- 테스트는 각 단계마다 병행
- 문서는 작업과 동시에 업데이트

---

## ✅ 진행 상황 체크

작업 시작일: **2025-10-23**

현재 진행률: **52% (13/25 시간)**

현재 Phase: **Phase 5 (테스트 및 검증) 준비 중**

담당자: BlueCrab Development Team

완료된 작업:
- ✅ Phase 1: Entity 검증, DTO 생성 (2시간)
- ✅ Phase 2: Repository, Service 구현 (6시간)
- ✅ Phase 3: Controller, Security 설정 (2.5시간)
- ✅ Phase 4: 스케줄러 구현 및 활성화 (2.5시간)

다음 작업:
- 🟡 Phase 5: 단위 테스트, 통합 테스트, 데이터 마이그레이션 (7시간 예상)
