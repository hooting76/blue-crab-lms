# 01. 개요

> 📚 출석 요청/승인 시스템의 전체 개요

---

## 시스템 개요

**출석 요청/승인 시스템**은 학생과 교수 간의 출석 관리를 디지털화하여 효율적으로 처리하는 시스템입니다.

### 핵심 목표

- ✅ **학생**: 간편한 출석 요청 및 본인 출석 현황 조회
- ✅ **교수**: 효율적인 출석 승인 및 전체 학생 출석 관리
- ✅ **자동화**: 7일 후 미처리 요청 자동 승인으로 업무 부담 감소

---

## 주요 기능

### 1. 학생 기능 👨‍🎓

| 기능 | 설명 | API |
|------|------|-----|
| **출석 요청** | 수강 중인 강의의 특정 회차 출석 요청 | `POST /api/attendance/request` |
| **출석 조회** | 본인의 출석 현황 조회 (summary, sessions, pendingRequests) | `POST /api/attendance/student/view` |

**특징:**
- 수강 중인 강의에만 요청 가능
- 회차별 요청 (1~80회차)
- 요청 사유 입력 가능 (선택사항)
- 실시간 출석율 확인

### 2. 교수 기능 👨‍🏫

| 기능 | 설명 | API |
|------|------|-----|
| **출석 승인** | 학생 출석 요청을 승인/지각/결석 처리 | `POST /api/attendance/approve` |
| **출석 조회** | 담당 강의 전체 학생의 출석 현황 조회 | `POST /api/attendance/professor/view` |

**특징:**
- 담당 강의만 접근 가능 (권한 검증)
- 일괄 승인 처리 (여러 학생 동시 처리)
- 승인 옵션: 출석(출), 지각(지), 결석(결)
- 학생별 상세 출석 기록 확인

### 3. 자동 승인 기능 ⏰

| 기능 | 설명 |
|------|------|
| **임시 승인** | 출석 요청 즉시 `pendingRequests`에 추가 |
| **자동 확정** | 7일 후 미처리 요청을 자동으로 "출석" 처리 |
| **스케줄러** | 매일 오전 5시 자동 실행 |

**특징:**
- 날짜 기준 만료 (시간 무관)
- 교수 업무 부담 감소
- 유연한 승인 기간 (7일)

---

## 구성 요소

### 아키텍처

```
[클라이언트]
    ↓ HTTP POST (JWT 토큰)
[Controller] - 요청 검증, 권한 확인
    ↓
[Service] - 비즈니스 로직, JSON 파싱
    ↓
[Repository] - DB 조회/업데이트
    ↓
[Database] - ENROLLMENT_EXTENDED_TBL (JSON)
```

### 주요 컴포넌트

#### 1. **Controller** (`AttendanceController`)
- 4개 API 엔드포인트
- JWT 토큰 검증
- 요청 데이터 유효성 검사

#### 2. **Service** (`AttendanceRequestServiceImpl`)
- 출석 요청 처리
- 출석 승인 처리
- JSON 데이터 파싱/직렬화
- 출석율 계산

#### 3. **Repository** (`EnrollmentExtendedTblRepository`)
- 학생 수강 정보 조회
- 교수 권한 검증
- JSON 데이터 업데이트

#### 4. **Scheduler** (`AttendanceScheduler`)
- 매일 오전 5시 실행
- 만료된 요청 자동 처리
- pendingRequests → sessions 이동

---

## 핵심 개념

### 1. JWT 토큰 인증 🔐

**모든 API는 JWT 토큰 필수**

```http
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

**토큰에서 자동 추출:**
- `studentIdx` (학생 API)
- `professorIdx` (교수 API)

**브라우저에서의 우선순위:**
1. `window.authToken` (최우선)
2. `localStorage.getItem('accessToken')`
3. `sessionStorage.getItem('accessToken')`

### 2. 교수 권한 검증 🔒

**LEC_PROF 필드 구조:**
- `LEC_TBL.LEC_PROF` = `USER_IDX` (문자열)
- 예: `'25'` (USER_IDX=25인 교수)

**검증 쿼리:**
```sql
WHERE lecSerial = 'ETH201' 
AND lecProf = CAST(25 AS string)
```

**장점:**
- 직접 비교로 성능 향상
- USER_TBL JOIN 불필요

### 3. 데이터 구조 (JSON) 📦

**ENROLLMENT_DATA 필드 확장:**

```json
{
  "attendance": {
    "summary": {
      "attended": 30,
      "late": 5,
      "absent": 5,
      "totalSessions": 40,
      "attendanceRate": 75.0
    },
    "sessions": [...],
    "pendingRequests": [...]
  }
}
```

**3가지 주요 필드:**
1. **summary**: 출석 통계 (출석, 지각, 결석, 출석율)
2. **sessions**: 확정된 출석 기록 (회차별)
3. **pendingRequests**: 대기 중인 요청 (7일 만료)

### 4. 출석율 계산 📊

**공식:**
```
출석율 = (출석 횟수 / 전체 회차) × 100
```

**예시:**
- 출석: 30회
- 전체: 40회
- 출석율: 75.0%

**자동 재계산:**
- 출석 승인 시
- 자동 확정 시
- sessions 배열 변경 시

### 5. 7일 자동 승인 ⏰

**만료 날짜 계산:**
```java
// 요청 시각: 2025-10-23 14:30:00
// 만료 날짜: 2025-10-30 00:00:00 (7일 후 자정)
LocalDateTime expiresAt = LocalDateTime.now()
    .plusDays(7)
    .withHour(0).withMinute(0).withSecond(0).withNano(0);
```

**스케줄러 처리:**
```java
// 매일 오전 5시 실행
@Scheduled(cron = "0 0 5 * * *")

// 날짜 비교 (시간 무관)
LocalDate today = LocalDate.now();
if (!expiresDate.isAfter(today)) {
    // 자동 출석 처리
}
```

---

## 처리 흐름

### 전체 플로우

```
1️⃣ 학생 출석 요청
   ↓ (pendingRequests에 추가, tempApproved=true)
   
2️⃣ 7일 대기
   ↓
   
3️⃣ 교수 승인 OR 자동 승인
   ↓ (sessions로 이동, pendingRequests에서 제거)
   
4️⃣ 출석율 재계산
   ↓ (summary 업데이트)
   
5️⃣ 조회 API로 확인
```

### 상태 전이

```
[요청 전]
    ↓ 학생 요청
[pendingRequests] (tempApproved=true, expiresAt=7일 후)
    ↓ 교수 승인 OR 7일 경과
[sessions] (status=출/지/결, approvedBy=교수 USER_IDX)
    ↓
[summary] (출석율 재계산)
```

---

## 데이터 흐름

### 입력 → 처리 → 출력

#### 학생 출석 요청
```
[입력]
- lecSerial: "ETH201"
- sessionNumber: 1
- requestReason: "교통체증" (선택)
- studentIdx: JWT 토큰에서 추출

[처리]
1. 수강 여부 확인
2. pendingRequests에 추가
3. expiresAt 계산 (7일 후 00:00:00)
4. JSON 직렬화 및 DB 저장

[출력]
- summary: 출석 통계
- sessions: 확정된 출석 기록
- pendingRequests: 방금 추가된 요청 포함
```

#### 교수 출석 승인
```
[입력]
- lecSerial: "ETH201"
- sessionNumber: 1
- attendanceRecords: [{studentIdx: 6, status: "출"}]
- professorIdx: JWT 토큰에서 추출

[처리]
1. 교수 권한 검증 (LEC_PROF = professorIdx)
2. pendingRequests에서 해당 요청 찾기
3. sessions로 이동 (status, approvedBy, approvedDate 설정)
4. pendingRequests에서 제거
5. summary 재계산
6. JSON 직렬화 및 DB 저장

[출력]
- success: true
- message: "출석 승인이 완료되었습니다. (1/1)"
```

---

## 기술 스택

### 백엔드
- **Spring Boot 3.x**
- **Spring Security** (JWT 인증)
- **Spring Scheduler** (자동 승인)
- **JPA / Hibernate**
- **Jackson** (JSON 파싱)

### 데이터베이스
- **MySQL / MariaDB**
- **ENROLLMENT_EXTENDED_TBL** (JSON 필드 활용)

### 프론트엔드 연동
- **RESTful API** (모두 POST 방식)
- **JWT 토큰** (Bearer 인증)
- **JSON 응답**

---

## 다음 단계

- **[02. API 엔드포인트](./02_API_엔드포인트.md)**: 4개 API의 상세 명세 확인
- **[03. 학생 출석 요청](./03_학생_출석_요청.md)**: 학생 API 구현 가이드
- **[04. 교수 출석 승인](./04_교수_출석_승인.md)**: 교수 API 구현 가이드
- **[08. 시퀀스 다이어그램](./08_시퀀스_다이어그램.md)**: 전체 흐름 시각화

---

**📚 [목차로 돌아가기](./README.md)**
