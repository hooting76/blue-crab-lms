# 07. 데이터 구조

> 📊 출결 관리 시스템의 JSON 데이터 구조 상세 가이드

---

## 개요

### ENROLLMENT_DATA 필드

출결 데이터는 `ENROLLMENT_EXTENDED_TBL.ENROLLMENT_DATA` 필드에 **JSON 형식**으로 저장됩니다.

```sql
-- 테이블 구조
CREATE TABLE ENROLLMENT_EXTENDED_TBL (
    ENR_NO INT PRIMARY KEY AUTO_INCREMENT,
    LEC_SERIAL VARCHAR(20),
    USER_IDX INT,
    ENROLLMENT_DATA TEXT, -- JSON 데이터
    FOREIGN KEY (LEC_SERIAL) REFERENCES LEC_TBL(LEC_SERIAL),
    FOREIGN KEY (USER_IDX) REFERENCES USER_TBL(USER_IDX)
);
```

### JSON 최상위 구조

```json
{
  "summary": { ... },
  "sessions": [ ... ],
  "pendingRequests": [ ... ]
}
```

---

## 전체 데이터 구조

### 완전한 예시

```json
{
  "summary": {
    "attended": 2,
    "late": 1,
    "absent": 0,
    "totalSessions": 4,
    "attendanceRate": 75.0,
    "updatedAt": "2025-10-23T15:45:00"
  },
  "sessions": [
    {
      "sessionNumber": 1,
      "status": "출",
      "requestDate": "2025-10-16T14:30:00",
      "approvedDate": "2025-10-20T10:00:00",
      "approvedBy": 25,
      "tempApproved": false
    },
    {
      "sessionNumber": 2,
      "status": "지",
      "requestDate": "2025-10-18T09:15:00",
      "approvedDate": "2025-10-23T00:00:00",
      "approvedBy": null,
      "tempApproved": true
    }
  ],
  "pendingRequests": [
    {
      "sessionNumber": 3,
      "requestDate": "2025-10-23T14:00:00",
      "expiresAt": "2025-10-30T00:00:00",
      "requestReason": "병원 진료"
    },
    {
      "sessionNumber": 4,
      "requestDate": "2025-10-23T15:00:00",
      "expiresAt": "2025-10-30T00:00:00",
      "requestReason": null
    }
  ]
}
```

---

## summary (요약 정보)

### 구조

```json
{
  "attended": 2,
  "late": 1,
  "absent": 0,
  "totalSessions": 4,
  "attendanceRate": 75.0,
  "updatedAt": "2025-10-23T15:45:00"
}
```

### 필드 상세

| 필드 | 타입 | 설명 | 계산 방식 |
|-----|------|------|----------|
| `attended` | Integer | 출석 횟수 | sessions에서 status="출" 카운트 |
| `late` | Integer | 지각 횟수 | sessions에서 status="지" 카운트 |
| `absent` | Integer | 결석 횟수 | sessions에서 status="결" 카운트 |
| `totalSessions` | Integer | 전체 회차 수 | sessions.size() + pendingRequests.size() |
| `attendanceRate` | Double | 출석율 (%) | (attended / totalSessions) × 100 |
| `updatedAt` | String | 최종 갱신 시각 | ISO 8601 형식 |

### 계산 로직

```java
private void recalculateSummary(AttendanceDataDto attendanceData) {
    // 1. sessions 배열 순회
    int attended = 0;
    int late = 0;
    int absent = 0;
    
    for (AttendanceSessionDto session : attendanceData.getSessions()) {
        switch (session.getStatus()) {
            case "출": attended++; break;
            case "지": late++; break;
            case "결": absent++; break;
        }
    }
    
    // 2. totalSessions 계산
    int totalSessions = attendanceData.getSessions().size() 
                      + attendanceData.getPendingRequests().size();
    
    // 3. 출석율 계산
    double attendanceRate = totalSessions > 0 
        ? (attended * 100.0) / totalSessions 
        : 0.0;
    
    // 4. summary 업데이트
    AttendanceSummaryDto summary = attendanceData.getSummary();
    summary.setAttended(attended);
    summary.setLate(late);
    summary.setAbsent(absent);
    summary.setTotalSessions(totalSessions);
    summary.setAttendanceRate(attendanceRate);
    summary.setUpdatedAt(LocalDateTime.now());
}
```

### 예시

#### 케이스 1: 모두 출석

```json
{
  "sessions": [
    { "sessionNumber": 1, "status": "출" },
    { "sessionNumber": 2, "status": "출" },
    { "sessionNumber": 3, "status": "출" }
  ],
  "pendingRequests": [],
  "summary": {
    "attended": 3,
    "late": 0,
    "absent": 0,
    "totalSessions": 3,
    "attendanceRate": 100.0
  }
}
```

#### 케이스 2: 혼합 + 대기 중

```json
{
  "sessions": [
    { "sessionNumber": 1, "status": "출" },
    { "sessionNumber": 2, "status": "지" },
    { "sessionNumber": 3, "status": "결" }
  ],
  "pendingRequests": [
    { "sessionNumber": 4 },
    { "sessionNumber": 5 }
  ],
  "summary": {
    "attended": 1,
    "late": 1,
    "absent": 1,
    "totalSessions": 5,
    "attendanceRate": 20.0
  }
}
```

**계산**:
- `attended`: 1 (회차 1만 "출")
- `totalSessions`: 3 (sessions) + 2 (pendingRequests) = 5
- `attendanceRate`: (1 / 5) × 100 = 20.0%

---

## sessions (승인된 출석 기록)

### 구조

```json
{
  "sessionNumber": 1,
  "status": "출",
  "requestDate": "2025-10-16T14:30:00",
  "approvedDate": "2025-10-20T10:00:00",
  "approvedBy": 25,
  "tempApproved": false
}
```

### 필드 상세

| 필드 | 타입 | 필수 | 설명 | 예시 |
|-----|------|------|------|------|
| `sessionNumber` | Integer | ✅ | 회차 번호 | 1, 2, 3, ... |
| `status` | String | ✅ | 출석 상태 | "출", "지", "결" |
| `requestDate` | String | ✅ | 학생 요청 일시 | "2025-10-16T14:30:00" |
| `approvedDate` | String | ✅ | 승인 일시 | "2025-10-20T10:00:00" |
| `approvedBy` | Integer | ❌ | 승인한 교수 USER_IDX | 25 (교수), null (자동) |
| `tempApproved` | Boolean | ✅ | 자동 승인 여부 | false (교수), true (자동) |

### 필드별 설명

#### 1. sessionNumber (회차 번호)

```json
"sessionNumber": 1
```

- **범위**: 1 ~ 80
- **의미**: 강의의 몇 번째 회차인지
- **제약**: 같은 학생의 같은 회차는 sessions에 1개만 존재

#### 2. status (출석 상태)

```json
"status": "출"
```

- **가능한 값**:
  - `"출"`: 출석 (Attended)
  - `"지"`: 지각 (Late)
  - `"결"`: 결석 (Absent)

**교수 승인 vs 자동 승인**:
- **교수 승인**: "출", "지", "결" 모두 가능
- **자동 승인**: "출"만 가능 (고정)

#### 3. requestDate (요청 일시)

```json
"requestDate": "2025-10-16T14:30:00"
```

- **형식**: ISO 8601 (yyyy-MM-ddTHH:mm:ss)
- **의미**: 학생이 출석 요청을 보낸 시각
- **용도**: 출석 요청 이력 추적

#### 4. approvedDate (승인 일시)

```json
"approvedDate": "2025-10-20T10:00:00"
```

- **형식**: ISO 8601
- **의미**: 교수 또는 시스템이 승인한 시각
- **용도**: 승인 이력 추적

#### 5. approvedBy (승인자)

```json
"approvedBy": 25
```

- **교수 승인**: professorIdx (예: 25)
- **자동 승인**: null

**예시**:
```json
// 교수 승인
{
  "approvedBy": 25,
  "tempApproved": false
}

// 자동 승인
{
  "approvedBy": null,
  "tempApproved": true
}
```

#### 6. tempApproved (자동 승인 여부)

```json
"tempApproved": true
```

- **false**: 교수가 수동으로 승인
- **true**: 시스템이 자동으로 승인

**판단 기준**:
| tempApproved | approvedBy | status | 의미 |
|--------------|-----------|--------|------|
| false | 25 | "출" | 교수 25가 출석 승인 |
| false | 25 | "지" | 교수 25가 지각 승인 |
| false | 25 | "결" | 교수 25가 결석 승인 |
| true | null | "출" | 시스템이 자동 승인 |

### 배열 예시

```json
"sessions": [
  {
    "sessionNumber": 1,
    "status": "출",
    "requestDate": "2025-10-16T14:30:00",
    "approvedDate": "2025-10-20T10:00:00",
    "approvedBy": 25,
    "tempApproved": false
  },
  {
    "sessionNumber": 2,
    "status": "지",
    "requestDate": "2025-10-18T09:15:00",
    "approvedDate": "2025-10-22T14:30:00",
    "approvedBy": 25,
    "tempApproved": false
  },
  {
    "sessionNumber": 3,
    "status": "출",
    "requestDate": "2025-10-20T11:00:00",
    "approvedDate": "2025-10-27T00:00:00",
    "approvedBy": null,
    "tempApproved": true
  }
]
```

---

## pendingRequests (대기 중인 요청)

### 구조

```json
{
  "sessionNumber": 3,
  "requestDate": "2025-10-23T14:00:00",
  "expiresAt": "2025-10-30T00:00:00",
  "requestReason": "병원 진료"
}
```

### 필드 상세

| 필드 | 타입 | 필수 | 설명 | 예시 |
|-----|------|------|------|------|
| `sessionNumber` | Integer | ✅ | 회차 번호 | 3 |
| `requestDate` | String | ✅ | 요청 일시 | "2025-10-23T14:00:00" |
| `expiresAt` | String | ✅ | 만료 일시 | "2025-10-30T00:00:00" |
| `requestReason` | String | ❌ | 요청 사유 | "병원 진료", null |

### 필드별 설명

#### 1. sessionNumber (회차 번호)

```json
"sessionNumber": 3
```

- **범위**: 1 ~ 80
- **의미**: 출석 요청한 회차
- **제약**: 같은 학생의 같은 회차는 pendingRequests에 1개만 존재

#### 2. requestDate (요청 일시)

```json
"requestDate": "2025-10-23T14:00:00"
```

- **형식**: ISO 8601
- **의미**: 학생이 출석 요청을 보낸 시각
- **계산**: `LocalDateTime.now()`

#### 3. expiresAt (만료 일시)

```json
"expiresAt": "2025-10-30T00:00:00"
```

- **형식**: ISO 8601
- **의미**: 자동 승인 기준 일시
- **계산**:
  ```java
  LocalDateTime expiresAt = LocalDateTime.now()
      .plusDays(7)
      .withHour(0)
      .withMinute(0)
      .withSecond(0)
      .withNano(0);
  ```

**예시**:
| requestDate | expiresAt | 설명 |
|------------|-----------|------|
| 2025-10-23T14:30:00 | 2025-10-30T00:00:00 | 7일 후 자정 |
| 2025-10-23T09:00:00 | 2025-10-30T00:00:00 | 동일 |
| 2025-10-23T23:59:59 | 2025-10-30T00:00:00 | 동일 |

#### 4. requestReason (요청 사유)

```json
"requestReason": "병원 진료"
```

- **선택 필드**: null 가능
- **최대 길이**: 200자
- **용도**: 교수가 승인 시 참고

**예시**:
```json
// 사유 있음
{
  "sessionNumber": 3,
  "requestDate": "2025-10-23T14:00:00",
  "expiresAt": "2025-10-30T00:00:00",
  "requestReason": "병원 진료로 인한 결석"
}

// 사유 없음
{
  "sessionNumber": 4,
  "requestDate": "2025-10-23T15:00:00",
  "expiresAt": "2025-10-30T00:00:00",
  "requestReason": null
}
```

### 배열 예시

```json
"pendingRequests": [
  {
    "sessionNumber": 3,
    "requestDate": "2025-10-23T14:00:00",
    "expiresAt": "2025-10-30T00:00:00",
    "requestReason": "병원 진료"
  },
  {
    "sessionNumber": 4,
    "requestDate": "2025-10-23T15:00:00",
    "expiresAt": "2025-10-30T00:00:00",
    "requestReason": null
  },
  {
    "sessionNumber": 5,
    "requestDate": "2025-10-23T16:00:00",
    "expiresAt": "2025-10-30T00:00:00",
    "requestReason": "가족 행사"
  }
]
```

---

## 데이터 라이프사이클

### 1. 초기 상태 (수강 신청 직후)

```json
{
  "summary": {
    "attended": 0,
    "late": 0,
    "absent": 0,
    "totalSessions": 0,
    "attendanceRate": 0.0,
    "updatedAt": "2025-09-01T10:00:00"
  },
  "sessions": [],
  "pendingRequests": []
}
```

### 2. 학생 출석 요청 (회차 1)

```json
{
  "summary": {
    "attended": 0,
    "late": 0,
    "absent": 0,
    "totalSessions": 1,
    "attendanceRate": 0.0,
    "updatedAt": "2025-10-16T14:30:00"
  },
  "sessions": [],
  "pendingRequests": [
    {
      "sessionNumber": 1,
      "requestDate": "2025-10-16T14:30:00",
      "expiresAt": "2025-10-23T00:00:00",
      "requestReason": "병원 진료"
    }
  ]
}
```

### 3. 교수 승인 (회차 1 → "출석")

```json
{
  "summary": {
    "attended": 1,
    "late": 0,
    "absent": 0,
    "totalSessions": 1,
    "attendanceRate": 100.0,
    "updatedAt": "2025-10-20T10:00:00"
  },
  "sessions": [
    {
      "sessionNumber": 1,
      "status": "출",
      "requestDate": "2025-10-16T14:30:00",
      "approvedDate": "2025-10-20T10:00:00",
      "approvedBy": 25,
      "tempApproved": false
    }
  ],
  "pendingRequests": []
}
```

### 4. 학생 추가 요청 (회차 2, 3)

```json
{
  "summary": {
    "attended": 1,
    "late": 0,
    "absent": 0,
    "totalSessions": 3,
    "attendanceRate": 33.33,
    "updatedAt": "2025-10-23T15:00:00"
  },
  "sessions": [
    {
      "sessionNumber": 1,
      "status": "출",
      "requestDate": "2025-10-16T14:30:00",
      "approvedDate": "2025-10-20T10:00:00",
      "approvedBy": 25,
      "tempApproved": false
    }
  ],
  "pendingRequests": [
    {
      "sessionNumber": 2,
      "requestDate": "2025-10-23T14:00:00",
      "expiresAt": "2025-10-30T00:00:00",
      "requestReason": null
    },
    {
      "sessionNumber": 3,
      "requestDate": "2025-10-23T15:00:00",
      "expiresAt": "2025-10-30T00:00:00",
      "requestReason": "가족 행사"
    }
  ]
}
```

### 5. 자동 승인 (회차 2 → "출석")

```json
{
  "summary": {
    "attended": 2,
    "late": 0,
    "absent": 0,
    "totalSessions": 3,
    "attendanceRate": 66.67,
    "updatedAt": "2025-10-30T00:00:00"
  },
  "sessions": [
    {
      "sessionNumber": 1,
      "status": "출",
      "requestDate": "2025-10-16T14:30:00",
      "approvedDate": "2025-10-20T10:00:00",
      "approvedBy": 25,
      "tempApproved": false
    },
    {
      "sessionNumber": 2,
      "status": "출",
      "requestDate": "2025-10-23T14:00:00",
      "approvedDate": "2025-10-30T00:00:00",
      "approvedBy": null,
      "tempApproved": true
    }
  ],
  "pendingRequests": [
    {
      "sessionNumber": 3,
      "requestDate": "2025-10-23T15:00:00",
      "expiresAt": "2025-10-30T00:00:00",
      "requestReason": "가족 행사"
    }
  ]
}
```

---

## DTO 클래스

### AttendanceDataDto

```java
@Data
@NoArgsConstructor
@AllArgsConstructor
@Builder
public class AttendanceDataDto {
    private AttendanceSummaryDto summary;
    private List<AttendanceSessionDto> sessions;
    private List<AttendancePendingRequestDto> pendingRequests;
}
```

### AttendanceSummaryDto

```java
@Data
@NoArgsConstructor
@AllArgsConstructor
@Builder
public class AttendanceSummaryDto {
    private Integer attended;        // 출석 횟수
    private Integer late;            // 지각 횟수
    private Integer absent;          // 결석 횟수
    private Integer totalSessions;   // 전체 회차
    private Double attendanceRate;   // 출석율
    private LocalDateTime updatedAt; // 갱신 시각
}
```

### AttendanceSessionDto

```java
@Data
@NoArgsConstructor
@AllArgsConstructor
@Builder
public class AttendanceSessionDto {
    private Integer sessionNumber;      // 회차 번호
    private String status;              // "출", "지", "결"
    private LocalDateTime requestDate;  // 요청 일시
    private LocalDateTime approvedDate; // 승인 일시
    private Integer approvedBy;         // 승인자 (null=자동)
    private Boolean tempApproved;       // 자동 승인 여부
}
```

### AttendancePendingRequestDto

```java
@Data
@NoArgsConstructor
@AllArgsConstructor
@Builder
public class AttendancePendingRequestDto {
    private Integer sessionNumber;      // 회차 번호
    private LocalDateTime requestDate;  // 요청 일시
    private LocalDateTime expiresAt;    // 만료 일시
    private String requestReason;       // 요청 사유 (optional)
}
```

---

## JSON 직렬화/역직렬화

### ObjectMapper 설정

```java
@Configuration
public class JacksonConfig {
    
    @Bean
    public ObjectMapper objectMapper() {
        ObjectMapper mapper = new ObjectMapper();
        
        // Java 8 날짜/시간 지원
        mapper.registerModule(new JavaTimeModule());
        
        // ISO 8601 형식으로 직렬화
        mapper.disable(SerializationFeature.WRITE_DATES_AS_TIMESTAMPS);
        
        // null 필드 포함
        mapper.setSerializationInclusion(JsonInclude.Include.ALWAYS);
        
        return mapper;
    }
}
```

### 직렬화 (Java → JSON)

```java
@Autowired
private ObjectMapper objectMapper;

public void saveAttendanceData(
    EnrollmentExtendedTbl enrollment,
    AttendanceDataDto attendanceData
) throws JsonProcessingException {
    
    // Java 객체 → JSON 문자열
    String json = objectMapper.writeValueAsString(attendanceData);
    
    // DB 저장
    enrollment.setEnrollmentData(json);
    enrollmentRepository.save(enrollment);
}
```

### 역직렬화 (JSON → Java)

```java
public AttendanceDataDto parseAttendanceData(String json) 
        throws JsonProcessingException {
    
    if (json == null || json.isEmpty()) {
        // 기본 구조 반환
        return AttendanceDataDto.builder()
            .summary(AttendanceSummaryDto.builder()
                .attended(0)
                .late(0)
                .absent(0)
                .totalSessions(0)
                .attendanceRate(0.0)
                .updatedAt(LocalDateTime.now())
                .build())
            .sessions(new ArrayList<>())
            .pendingRequests(new ArrayList<>())
            .build();
    }
    
    // JSON 문자열 → Java 객체
    return objectMapper.readValue(json, AttendanceDataDto.class);
}
```

---

## 제약 조건

### 1. 회차 중복 방지

**규칙**: 같은 학생의 같은 회차는 sessions + pendingRequests에 총 1개만 존재

```java
// ❌ 잘못된 데이터
{
  "sessions": [
    { "sessionNumber": 1, "status": "출" }
  ],
  "pendingRequests": [
    { "sessionNumber": 1 } // 중복!
  ]
}

// ✅ 올바른 데이터
{
  "sessions": [
    { "sessionNumber": 1, "status": "출" }
  ],
  "pendingRequests": [
    { "sessionNumber": 2 } // 다른 회차
  ]
}
```

### 2. status 값 제한

**규칙**: "출", "지", "결" 중 하나만 허용

```java
@Pattern(regexp = "^(출|지|결)$", message = "출석 상태는 '출', '지', '결' 중 하나여야 합니다.")
private String status;
```

### 3. sessionNumber 범위

**규칙**: 1 ~ 80 사이의 정수

```java
@Min(1)
@Max(80)
private Integer sessionNumber;
```

### 4. requestReason 길이

**규칙**: 최대 200자

```java
@Size(max = 200, message = "요청 사유는 최대 200자까지 입력 가능합니다.")
private String requestReason;
```

---

## 데이터 검증

### Service 레벨 검증

```java
private void validateAttendanceData(AttendanceDataDto attendanceData) {
    // 1. 회차 중복 검사
    Set<Integer> allSessionNumbers = new HashSet<>();
    
    for (AttendanceSessionDto session : attendanceData.getSessions()) {
        if (!allSessionNumbers.add(session.getSessionNumber())) {
            throw new IllegalStateException(
                "중복된 회차 번호: " + session.getSessionNumber()
            );
        }
    }
    
    for (AttendancePendingRequestDto request : attendanceData.getPendingRequests()) {
        if (!allSessionNumbers.add(request.getSessionNumber())) {
            throw new IllegalStateException(
                "중복된 회차 번호: " + request.getSessionNumber()
            );
        }
    }
    
    // 2. status 값 검증
    for (AttendanceSessionDto session : attendanceData.getSessions()) {
        if (!Arrays.asList("출", "지", "결").contains(session.getStatus())) {
            throw new IllegalArgumentException(
                "잘못된 출석 상태: " + session.getStatus()
            );
        }
    }
    
    // 3. summary 일관성 검증
    recalculateSummary(attendanceData);
}
```

---

## 프론트엔드 처리

### React 예시

```jsx
function AttendanceDashboard({ attendanceData }) {
    const { summary, sessions, pendingRequests } = attendanceData;
    
    return (
        <div>
            {/* 요약 정보 */}
            <div className="summary">
                <h3>출석율: {summary.attendanceRate.toFixed(1)}%</h3>
                <p>출석: {summary.attended}회</p>
                <p>지각: {summary.late}회</p>
                <p>결석: {summary.absent}회</p>
                <p>전체: {summary.totalSessions}회</p>
            </div>
            
            {/* 승인된 출석 기록 */}
            <div className="sessions">
                <h3>출석 기록</h3>
                <table>
                    <thead>
                        <tr>
                            <th>회차</th>
                            <th>상태</th>
                            <th>요청일</th>
                            <th>승인일</th>
                            <th>승인자</th>
                        </tr>
                    </thead>
                    <tbody>
                        {sessions.map(session => (
                            <tr key={session.sessionNumber}>
                                <td>{session.sessionNumber}</td>
                                <td>{session.status}</td>
                                <td>{formatDate(session.requestDate)}</td>
                                <td>{formatDate(session.approvedDate)}</td>
                                <td>
                                    {session.tempApproved 
                                        ? '자동 승인' 
                                        : `교수 ${session.approvedBy}`}
                                </td>
                            </tr>
                        ))}
                    </tbody>
                </table>
            </div>
            
            {/* 대기 중인 요청 */}
            <div className="pending">
                <h3>대기 중 ({pendingRequests.length})</h3>
                <ul>
                    {pendingRequests.map(request => (
                        <li key={request.sessionNumber}>
                            회차 {request.sessionNumber} - 
                            만료: {formatDate(request.expiresAt)}
                            {request.requestReason && ` (${request.requestReason})`}
                        </li>
                    ))}
                </ul>
            </div>
        </div>
    );
}
```

---

## 주의사항

### 백엔드 개발자

1. **summary 재계산 필수**
   - sessions 또는 pendingRequests 변경 시 반드시 재계산
   - `recalculateSummary()` 호출

2. **JSON 파싱 예외 처리**
   - 잘못된 JSON 형식 대비
   - 기본 구조 반환

3. **트랜잭션 관리**
   - JSON 업데이트는 원자적으로 처리
   - 롤백 시 데이터 일관성 유지

### 프론트엔드 개발자

1. **출석율 소수점 표시**
   - `toFixed(1)` 또는 `toFixed(2)` 사용
   - 0으로 나누기 방지

2. **날짜 포맷팅**
   - ISO 8601 → 사용자 친화적 형식 변환
   - 로케일 고려

3. **대기 중인 요청 표시**
   - 만료일까지 남은 일수 계산
   - 만료 임박 시 경고 표시

---

## 다음 단계

- **[03. 학생 출석 요청](./03_학생_출석_요청.md)**: JSON 생성 및 업데이트
- **[04. 교수 출석 승인](./04_교수_출석_승인.md)**: pendingRequests → sessions 이동
- **[06. 자동 승인 메커니즘](./06_자동_승인_메커니즘.md)**: sessions 배열 업데이트

---

**📚 [목차로 돌아가기](./README.md)**
