# 08. 시퀀스 다이어그램

> 📊 출결 관리 시스템의 전체 흐름을 시각화한 다이어그램

---

## 개요

출결 관리 시스템의 주요 플로우를 Mermaid 시퀀스 다이어그램으로 표현합니다.

### 다이어그램 목록

1. **학생 출석 요청 플로우**: 학생이 출석 요청을 보내는 과정
2. **교수 출석 승인 플로우**: 교수가 출석을 승인하는 과정
3. **자동 승인 플로우**: 스케줄러가 만료된 요청을 자동 승인
4. **출석 조회 플로우**: 학생/교수가 출석 기록을 조회

---

## 1. 학생 출석 요청 플로우

### 시퀀스 다이어그램

```mermaid
sequenceDiagram
    autonumber
    actor Student as 👨‍🎓 학생
    participant Frontend as 🖥️ 프론트엔드
    participant Controller as 🎮 Controller
    participant Service as ⚙️ Service
    participant Repository as 💾 Repository
    participant DB as 🗄️ Database

    Student->>Frontend: 출석 요청 (회차 1, 사유)
    Frontend->>Frontend: JWT 토큰 확인
    Frontend->>Controller: POST /api/attendance/request
    Note over Frontend,Controller: Body: {lecSerial, sessionNumber, requestReason}
    
    Controller->>Controller: JWT에서 studentIdx 추출
    Controller->>Service: requestAttendance(studentIdx, lecSerial, sessionNumber, reason)
    
    Service->>Repository: findByLecSerialAndStudentIdx(lecSerial, studentIdx)
    Repository->>DB: SELECT ... WHERE LEC_SERIAL=? AND USER_IDX=?
    DB-->>Repository: EnrollmentExtendedTbl
    Repository-->>Service: Optional<EnrollmentExtendedTbl>
    
    alt 수강생이 아닌 경우
        Service-->>Controller: NotFoundException
        Controller-->>Frontend: 404 Not Found
        Frontend-->>Student: ❌ 수강생이 아닙니다
    end
    
    Service->>Service: JSON 파싱 (ENROLLMENT_DATA)
    Service->>Service: 중복 요청 검사
    
    alt 이미 sessions에 존재
        Service-->>Controller: ConflictException
        Controller-->>Frontend: 409 Conflict
        Frontend-->>Student: ❌ 이미 승인된 회차입니다
    end
    
    Service->>Service: expiresAt 계산 (now + 7일)
    Service->>Service: pendingRequests에 추가
    Service->>Service: summary 재계산
    Service->>Service: JSON 직렬화
    
    Service->>Repository: save(enrollment)
    Repository->>DB: UPDATE ... SET ENROLLMENT_DATA=?
    DB-->>Repository: 저장 완료
    Repository-->>Service: 저장 완료
    
    Service-->>Controller: AttendanceResponseDto (success)
    Controller-->>Frontend: 200 OK
    Frontend-->>Student: ✅ 출석 요청이 완료되었습니다
```

### 주요 단계 설명

| 단계 | 설명 | 비고 |
|-----|------|------|
| 1-3 | 학생이 출석 요청 전송 | JWT 토큰 필수 |
| 4 | JWT에서 studentIdx 추출 | 인증 단계 |
| 5-8 | 수강생 여부 확인 | DB 조회 |
| 9-10 | JSON 파싱 및 검증 | ENROLLMENT_DATA 파싱 |
| 11-12 | 중복 요청 검사 | sessions 배열 확인 |
| 13-15 | 요청 데이터 생성 | expiresAt = now + 7일 |
| 16-19 | DB 저장 | JSON 직렬화 후 UPDATE |
| 20-21 | 성공 응답 | 200 OK |

---

## 2. 교수 출석 승인 플로우

### 시퀀스 다이어그램

```mermaid
sequenceDiagram
    autonumber
    actor Professor as 👨‍🏫 교수
    participant Frontend as 🖥️ 프론트엔드
    participant Controller as 🎮 Controller
    participant Service as ⚙️ Service
    participant Repository as 💾 Repository
    participant DB as 🗄️ Database

    Professor->>Frontend: 출석 승인 (회차 1, 학생 6, "출")
    Frontend->>Frontend: JWT 토큰 확인
    Frontend->>Controller: POST /api/attendance/approve
    Note over Frontend,Controller: Body: {lecSerial, sessionNumber, attendanceRecords}
    
    Controller->>Controller: JWT에서 professorIdx 추출
    Controller->>Service: approveAttendance(professorIdx, lecSerial, sessionNumber, records)
    
    Service->>Repository: findByLecSerialAndProfessorIdx(lecSerial, professorIdx)
    Repository->>DB: SELECT ... WHERE LEC_SERIAL=? AND LEC_PROF=CAST(? AS string)
    DB-->>Repository: EnrollmentExtendedTbl
    Repository-->>Service: Optional<EnrollmentExtendedTbl>
    
    alt 담당 교수가 아닌 경우
        Service-->>Controller: ForbiddenException
        Controller-->>Frontend: 403 Forbidden
        Frontend-->>Professor: ❌ 해당 강의의 담당 교수가 아닙니다
    end
    
    Service->>Service: 권한 확인 완료
    
    loop 각 학생별 처리
        Service->>Repository: findByLecSerialAndStudentIdx(lecSerial, studentIdx)
        Repository->>DB: SELECT ... WHERE LEC_SERIAL=? AND USER_IDX=?
        DB-->>Repository: EnrollmentExtendedTbl
        Repository-->>Service: Optional<EnrollmentExtendedTbl>
        
        Service->>Service: JSON 파싱
        Service->>Service: pendingRequests에서 회차 찾기
        
        alt pendingRequests에 없음
            Service->>Service: 로그 기록 후 스킵
        else pendingRequests에 있음
            Service->>Service: sessions로 이동 (status, approvedBy 설정)
            Service->>Service: pendingRequests에서 제거
            Service->>Service: summary 재계산
            Service->>Service: JSON 직렬화
            Service->>Repository: save(enrollment)
            Repository->>DB: UPDATE ... SET ENROLLMENT_DATA=?
            DB-->>Repository: 저장 완료
            Repository-->>Service: 저장 완료
        end
    end
    
    Service-->>Controller: successCount 반환
    Controller-->>Frontend: 200 OK (승인 완료 3/3)
    Frontend-->>Professor: ✅ 출석 승인이 완료되었습니다 (3/3)
```

### 주요 단계 설명

| 단계 | 설명 | 비고 |
|-----|------|------|
| 1-3 | 교수가 승인 요청 전송 | attendanceRecords 배열 |
| 4 | JWT에서 professorIdx 추출 | 인증 단계 |
| 5-8 | 교수 권한 검증 | LEC_PROF = professorIdx |
| 9-10 | 권한 확인 완료 | ForbiddenException 방지 |
| 11-22 | 각 학생별 반복 처리 | 일괄 승인 지원 |
| 15-16 | pendingRequests 확인 | 없으면 스킵 |
| 17-21 | sessions로 이동 | approvedBy, tempApproved 설정 |
| 23-24 | 성공 응답 | (3/3) 형식 |

---

## 3. 자동 승인 플로우 (스케줄러)

### 시퀀스 다이어그램

```mermaid
sequenceDiagram
    autonumber
    participant Scheduler as ⏰ Scheduler
    participant Service as ⚙️ Service
    participant Repository as 💾 Repository
    participant DB as 🗄️ Database

    Note over Scheduler: 매일 자정 00:00:00 실행
    
    Scheduler->>Scheduler: @Scheduled(cron = "0 0 0 * * *")
    Scheduler->>Repository: findAll()
    Repository->>DB: SELECT * FROM ENROLLMENT_EXTENDED_TBL
    DB-->>Repository: List<EnrollmentExtendedTbl>
    Repository-->>Scheduler: 전체 수강생 목록
    
    Scheduler->>Scheduler: 현재 날짜 가져오기 (today)
    
    loop 각 수강생별 처리
        Scheduler->>Scheduler: JSON 파싱 (ENROLLMENT_DATA)
        Scheduler->>Scheduler: pendingRequests 가져오기
        
        alt pendingRequests가 비어있음
            Scheduler->>Scheduler: 스킵 (처리할 요청 없음)
        else pendingRequests가 있음
            Scheduler->>Scheduler: 만료된 요청 필터링
            Note over Scheduler: expiryDate ≤ today
            
            alt 만료된 요청이 없음
                Scheduler->>Scheduler: 스킵 (만료 요청 없음)
            else 만료된 요청이 있음
                Scheduler->>Scheduler: 로그 출력 (만료 요청 발견)
                
                loop 각 만료 요청별
                    Scheduler->>Scheduler: sessions로 이동
                    Note over Scheduler: status="출", approvedBy=null, tempApproved=true
                end
                
                Scheduler->>Scheduler: pendingRequests에서 제거
                Scheduler->>Scheduler: summary 재계산
                Scheduler->>Scheduler: JSON 직렬화
                
                Scheduler->>Repository: save(enrollment)
                Repository->>DB: UPDATE ... SET ENROLLMENT_DATA=?
                DB-->>Repository: 저장 완료
                Repository-->>Scheduler: 저장 완료
            end
        end
    end
    
    Scheduler->>Scheduler: 로그 출력 (전체 처리 결과)
    Note over Scheduler: 처리 학생=2, 승인 건수=3
```

### 주요 단계 설명

| 단계 | 설명 | 비고 |
|-----|------|------|
| 1 | 매일 자정 실행 | Cron: 0 0 0 * * * |
| 2-5 | 전체 수강생 조회 | findAll() |
| 6 | 현재 날짜 가져오기 | LocalDate.now() |
| 7-9 | JSON 파싱 | pendingRequests 확인 |
| 10-12 | 만료된 요청 필터링 | expiryDate ≤ today |
| 14-16 | sessions로 이동 | 자동 승인 플래그 설정 |
| 17-20 | DB 저장 | JSON 직렬화 후 UPDATE |
| 21 | 로그 출력 | 처리 결과 요약 |

---

## 4. 출석 조회 플로우

### 4-1. 학생 출석 조회

```mermaid
sequenceDiagram
    autonumber
    actor Student as 👨‍🎓 학생
    participant Frontend as 🖥️ 프론트엔드
    participant Controller as 🎮 Controller
    participant Service as ⚙️ Service
    participant Repository as 💾 Repository
    participant DB as 🗄️ Database

    Student->>Frontend: 출석 조회 요청
    Frontend->>Frontend: JWT 토큰 확인
    Frontend->>Controller: POST /api/attendance/student/view
    Note over Frontend,Controller: Body: {lecSerial}
    
    Controller->>Controller: JWT에서 studentIdx 추출
    Controller->>Service: getStudentAttendance(lecSerial, studentIdx)
    
    Service->>Repository: findByLecSerialAndStudentIdx(lecSerial, studentIdx)
    Repository->>DB: SELECT ... WHERE LEC_SERIAL=? AND USER_IDX=?
    DB-->>Repository: EnrollmentExtendedTbl
    Repository-->>Service: Optional<EnrollmentExtendedTbl>
    
    alt 수강생이 아닌 경우
        Service-->>Controller: NotFoundException
        Controller-->>Frontend: 404 Not Found
        Frontend-->>Student: ❌ 수강 정보를 찾을 수 없습니다
    end
    
    Service->>Service: JSON 파싱 (ENROLLMENT_DATA)
    Service->>Service: AttendanceDataDto 생성
    
    Service-->>Controller: AttendanceResponseDto (data)
    Controller-->>Frontend: 200 OK
    Note over Controller,Frontend: {summary, sessions, pendingRequests}
    Frontend-->>Student: ✅ 출석 정보 표시
```

### 4-2. 교수 출석 조회

```mermaid
sequenceDiagram
    autonumber
    actor Professor as 👨‍🏫 교수
    participant Frontend as 🖥️ 프론트엔드
    participant Controller as 🎮 Controller
    participant Service as ⚙️ Service
    participant Repository as 💾 Repository
    participant DB as 🗄️ Database

    Professor->>Frontend: 강의 출석 조회 요청
    Frontend->>Frontend: JWT 토큰 확인
    Frontend->>Controller: POST /api/attendance/professor/view
    Note over Frontend,Controller: Body: {lecSerial}
    
    Controller->>Controller: JWT에서 professorIdx 추출
    Controller->>Service: getProfessorAttendanceView(lecSerial, professorIdx)
    
    Service->>Repository: findByLecSerialAndProfessorIdx(lecSerial, professorIdx)
    Repository->>DB: SELECT ... WHERE LEC_SERIAL=? AND LEC_PROF=CAST(? AS string)
    DB-->>Repository: EnrollmentExtendedTbl (1명이라도 있으면 OK)
    Repository-->>Service: Optional<EnrollmentExtendedTbl>
    
    alt 담당 교수가 아닌 경우
        Service-->>Controller: ForbiddenException
        Controller-->>Frontend: 403 Forbidden
        Frontend-->>Professor: ❌ 해당 강의의 담당 교수가 아닙니다
    end
    
    Service->>Service: 권한 확인 완료
    Service->>Repository: findAllByLecSerial(lecSerial)
    Repository->>DB: SELECT ... WHERE LEC_SERIAL=?
    DB-->>Repository: List<EnrollmentExtendedTbl>
    Repository-->>Service: 전체 수강생 목록
    
    loop 각 수강생별
        Service->>Service: JSON 파싱 (ENROLLMENT_DATA)
        Service->>Service: StudentAttendanceDto 생성
        Note over Service: studentIdx, studentName, attendanceData
    end
    
    Service-->>Controller: List<StudentAttendanceDto>
    Controller-->>Frontend: 200 OK
    Note over Controller,Frontend: [{studentIdx, studentName, attendanceData}, ...]
    Frontend-->>Professor: ✅ 전체 학생 출석 정보 표시
```

### 주요 차이점

| 구분 | 학생 조회 | 교수 조회 |
|-----|----------|----------|
| **권한 검증** | studentIdx 일치 확인 | professorIdx = LEC_PROF |
| **조회 범위** | 본인 1명 | 전체 수강생 |
| **반환 데이터** | AttendanceDataDto | List<StudentAttendanceDto> |
| **에러 케이스** | 404 Not Found | 403 Forbidden |

---

## 5. 전체 통합 플로우

### 종합 시퀀스 다이어그램

```mermaid
sequenceDiagram
    autonumber
    actor Student as 👨‍🎓 학생
    actor Professor as 👨‍🏫 교수
    participant System as 🖥️ 시스템
    participant Scheduler as ⏰ 스케줄러
    participant DB as 🗄️ Database

    Note over Student,DB: 📅 10월 16일: 학생 출석 요청
    Student->>System: 회차 1 출석 요청 (병원 진료)
    System->>DB: pendingRequests에 추가
    Note over DB: expiresAt = 10월 23일 00:00:00
    System-->>Student: ✅ 요청 완료

    Note over Student,DB: 📅 10월 17일 ~ 10월 22일: 대기 중
    Student->>System: 출석 조회
    System-->>Student: 📊 대기 중 1건 (만료 6일 남음)

    Note over Student,DB: 📅 10월 20일: 교수 승인
    Professor->>System: 회차 1 승인 (출석)
    System->>DB: pendingRequests → sessions 이동
    Note over DB: approvedBy=25, tempApproved=false
    System-->>Professor: ✅ 승인 완료 (1/1)

    Note over Student,DB: 📅 10월 23일 14:00: 새 출석 요청
    Student->>System: 회차 2 출석 요청
    System->>DB: pendingRequests에 추가
    Note over DB: expiresAt = 10월 30일 00:00:00
    System-->>Student: ✅ 요청 완료

    Note over Student,DB: 📅 10월 30일 00:00: 자동 승인
    Scheduler->>DB: 만료된 요청 확인
    Note over DB: expiryDate = 10월 30일 ≤ today
    Scheduler->>DB: pendingRequests → sessions 이동
    Note over DB: approvedBy=null, tempApproved=true, status="출"
    Scheduler-->>Scheduler: 로그: 자동 승인 1건

    Note over Student,DB: 📅 10월 31일: 학생 조회
    Student->>System: 출석 조회
    System-->>Student: 📊 출석 2회 (출석율 100%)
```

### 전체 플로우 요약

| 날짜 | 이벤트 | 액션 | 결과 |
|-----|--------|------|------|
| 10/16 14:30 | 학생 요청 | 회차 1 요청 | pendingRequests 추가 |
| 10/20 10:00 | 교수 승인 | 회차 1 승인 | sessions 이동 (교수) |
| 10/23 14:00 | 학생 요청 | 회차 2 요청 | pendingRequests 추가 |
| 10/30 00:00 | 자동 승인 | 회차 2 만료 | sessions 이동 (자동) |
| 10/31 09:00 | 학생 조회 | 출석 조회 | 2회 출석, 100% |

---

## 6. 에러 플로우

### 권한 오류 플로우

```mermaid
sequenceDiagram
    autonumber
    actor User as 👤 사용자
    participant System as 🖥️ 시스템
    participant DB as 🗄️ Database

    Note over User,DB: ❌ 케이스 1: 인증 실패
    User->>System: API 호출 (토큰 없음)
    System->>System: Authorization 헤더 확인
    System-->>User: 401 Unauthorized

    Note over User,DB: ❌ 케이스 2: 수강생 아님
    User->>System: 출석 요청 (미수강 강의)
    System->>DB: 수강생 확인
    DB-->>System: 없음
    System-->>User: 404 Not Found

    Note over User,DB: ❌ 케이스 3: 담당 교수 아님
    User->>System: 출석 승인 (타 교수 강의)
    System->>DB: LEC_PROF 확인
    DB-->>System: 불일치
    System-->>User: 403 Forbidden

    Note over User,DB: ❌ 케이스 4: 중복 요청
    User->>System: 출석 요청 (이미 승인된 회차)
    System->>System: sessions 배열 확인
    System-->>User: 409 Conflict
```

---

## 다이어그램 사용 가이드

### Mermaid 렌더링

이 다이어그램들은 Mermaid 문법으로 작성되었습니다. 다음 도구들에서 렌더링 가능합니다:

1. **GitHub**: 마크다운 파일에서 자동 렌더링
2. **VS Code**: Mermaid Preview 확장 설치
3. **Mermaid Live Editor**: https://mermaid.live
4. **Notion, Confluence**: Mermaid 블록 지원

### 다이어그램 수정

```markdown
# 참여자 추가
participant NewService as 🆕 새로운 서비스

# 노트 추가
Note over Service: 추가 설명

# 조건문
alt 조건
    Service->>DB: 동작
else 다른 조건
    Service->>DB: 다른 동작
end

# 반복문
loop 반복
    Service->>DB: 반복 동작
end
```

---

## 주의사항

### 프론트엔드 개발자

1. **비동기 처리**
   - API 호출은 async/await 사용
   - 로딩 상태 표시 필수

2. **에러 처리**
   - HTTP 상태 코드별 메시지 표시
   - 401/403/404/409 구분

3. **실시간 업데이트**
   - 자동 승인 후 출석율 변경 가능
   - 주기적 새로고침 또는 WebSocket 고려

### 백엔드 개발자

1. **트랜잭션**
   - JSON 업데이트는 원자적 처리
   - 롤백 시 데이터 일관성 유지

2. **동시성**
   - 같은 회차에 대한 동시 요청 처리
   - 낙관적 잠금 고려

3. **성능**
   - 대량 수강생 조회 시 페이징
   - 인덱스 활용 (LEC_SERIAL, USER_IDX)

---

## 다음 단계

- **[09. 예외 처리 및 확장](./09_예외_처리_및_확장.md)**: 전체 에러 처리 전략
- **[03. 학생 출석 요청](./03_학생_출석_요청.md)**: 요청 플로우 상세
- **[04. 교수 출석 승인](./04_교수_출석_승인.md)**: 승인 플로우 상세
- **[06. 자동 승인 메커니즘](./06_자동_승인_메커니즘.md)**: 스케줄러 플로우 상세

---

**📚 [목차로 돌아가기](./README.md)**
