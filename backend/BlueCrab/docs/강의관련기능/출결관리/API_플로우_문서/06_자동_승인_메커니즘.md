# 06. ìë™ ìŠ¹ì¸ ë©”ì»¤ë‹ˆì¦˜

> â° 7ì¼ ê²½ê³¼ ì‹œ í•™ìƒ ì¶œì„ ìš”ì²­ì„ ìë™ìœ¼ë¡œ ìŠ¹ì¸í•˜ëŠ” ìŠ¤ì¼€ì¤„ëŸ¬ ì‹œìŠ¤í…œ

---

## ê°œìš”

### ëª©ì 

êµìˆ˜ê°€ 7ì¼ ë™ì•ˆ ìŠ¹ì¸í•˜ì§€ ì•Šì€ í•™ìƒì˜ ì¶œì„ ìš”ì²­ì„ **ìë™ìœ¼ë¡œ "ì¶œì„"ìœ¼ë¡œ ìŠ¹ì¸**í•˜ëŠ” ë©”ì»¤ë‹ˆì¦˜ì…ë‹ˆë‹¤.

### í•µì‹¬ ì›ë¦¬

```
expiresAt â‰¤ í˜„ì¬ ë‚ ì§œ â†’ ìë™ ìŠ¹ì¸
```

- **expiresAt**: ìš”ì²­ì¼ + 7ì¼ (ì‹œê°„ì€ 00:00:00ìœ¼ë¡œ ì •ê·œí™”)
- **í˜„ì¬ ë‚ ì§œ**: ìŠ¤ì¼€ì¤„ëŸ¬ ì‹¤í–‰ ì‹œì  (ë‚ ì§œë§Œ ë¹„êµ, ì‹œê°„ ë¬´ì‹œ)

### ì£¼ìš” íŠ¹ì§•

- âœ… **ë‚ ì§œ ê¸°ë°˜ ë¹„êµ**: ì‹œê°„ì€ ë¬´ì‹œí•˜ê³  ë‚ ì§œë§Œ ë¹„êµ
- âœ… **ìë™ "ì¶œì„" ì²˜ë¦¬**: status = "ì¶œ"ë¡œ ê³ ì •
- âœ… **tempApproved í”Œë˜ê·¸**: êµìˆ˜ ìŠ¹ì¸(false)ê³¼ êµ¬ë¶„(true)
- âœ… **ë§¤ì¼ ìì • ì‹¤í–‰**: 00:00:00ì— ìŠ¤ì¼€ì¤„ëŸ¬ ì‘ë™
- âœ… **ì¼ê´„ ì²˜ë¦¬**: ëª¨ë“  ê°•ì˜ì˜ ëª¨ë“  í•™ìƒ ì¼ê´„ í™•ì¸

---

## expiresAt ê³„ì‚°

### ìš”ì²­ ì‹œì  ê³„ì‚°

```java
// í•™ìƒì´ ì¶œì„ ìš”ì²­ì„ ë³´ë‚¼ ë•Œ
LocalDateTime requestDate = LocalDateTime.now();
// ì˜ˆ: 2025-10-23T14:30:15

LocalDateTime expiresAt = requestDate
    .plusDays(7)              // 7ì¼ ì¶”ê°€
    .withHour(0)              // ì‹œê°„ 0ì‹œ
    .withMinute(0)            // ë¶„ 0ë¶„
    .withSecond(0)            // ì´ˆ 0ì´ˆ
    .withNano(0);             // ë‚˜ë…¸ì´ˆ 0

// ê²°ê³¼: 2025-10-30T00:00:00
```

### ì˜ˆì‹œ

| ìš”ì²­ ì¼ì‹œ | expiresAt | ì„¤ëª… |
|----------|-----------|------|
| 2025-10-23T14:30:15 | 2025-10-30T00:00:00 | 7ì¼ í›„ ìì • |
| 2025-10-23T23:59:59 | 2025-10-30T00:00:00 | ê°™ì€ ë‚ ì´ì–´ë„ ë™ì¼ |
| 2025-10-23T00:00:01 | 2025-10-30T00:00:00 | ì‹œê°„ ë¬´ê´€ |

### ì¤‘ìš” í¬ì¸íŠ¸

#### 1. ì‹œê°„ ì •ê·œí™”

```java
.withHour(0).withMinute(0).withSecond(0).withNano(0)
```

- **ëª©ì **: ë‚ ì§œë§Œ ë¹„êµí•˜ê¸° ìœ„í•´ ì‹œê°„ ì œê±°
- **íš¨ê³¼**: ê°™ì€ ë‚ ì€ í•­ìƒ ê°™ì€ expiresAt

#### 2. 7ì¼ ì¶”ê°€

```java
.plusDays(7)
```

- **ì˜ë¯¸**: ìš”ì²­ì¼ + 7ì¼
- **ì˜ˆì‹œ**: 10ì›” 23ì¼ ìš”ì²­ â†’ 10ì›” 30ì¼ ë§Œë£Œ

---

## ìŠ¤ì¼€ì¤„ëŸ¬ êµ¬í˜„

### AutoApprovalScheduler

```java
@Component
@Slf4j
public class AutoApprovalScheduler {
    
    @Autowired
    private EnrollmentExtendedRepository enrollmentRepository;
    
    @Autowired
    private ObjectMapper objectMapper;
    
    // ë§¤ì¼ ìì • 00:00:00ì— ì‹¤í–‰
    @Scheduled(cron = "0 0 0 * * *")
    public void autoApproveExpiredRequests() {
        log.info("========================================");
        log.info("ìë™ ìŠ¹ì¸ ìŠ¤ì¼€ì¤„ëŸ¬ ì‹œì‘: {}", LocalDateTime.now());
        log.info("========================================");
        
        try {
            // 1. ëª¨ë“  ìˆ˜ê°•ìƒ ì¡°íšŒ
            List<EnrollmentExtendedTbl> allEnrollments = 
                enrollmentRepository.findAll();
            
            log.info("ì „ì²´ ìˆ˜ê°•ìƒ ìˆ˜: {}", allEnrollments.size());
            
            int totalProcessed = 0;
            int totalApproved = 0;
            
            // 2. ê° ìˆ˜ê°•ìƒë³„ ì²˜ë¦¬
            for (EnrollmentExtendedTbl enrollment : allEnrollments) {
                try {
                    int approvedCount = processEnrollment(enrollment);
                    if (approvedCount > 0) {
                        totalProcessed++;
                        totalApproved += approvedCount;
                    }
                } catch (Exception e) {
                    log.error("ìˆ˜ê°•ìƒ ì²˜ë¦¬ ì‹¤íŒ¨: ENR_NO={}", 
                              enrollment.getEnrNo(), e);
                }
            }
            
            log.info("========================================");
            log.info("ìë™ ìŠ¹ì¸ ì™„ë£Œ: ì²˜ë¦¬ í•™ìƒ={}, ìŠ¹ì¸ ê±´ìˆ˜={}", 
                     totalProcessed, totalApproved);
            log.info("========================================");
            
        } catch (Exception e) {
            log.error("ìë™ ìŠ¹ì¸ ìŠ¤ì¼€ì¤„ëŸ¬ ì˜¤ë¥˜", e);
        }
    }
    
    private int processEnrollment(EnrollmentExtendedTbl enrollment) 
            throws Exception {
        
        String enrollmentData = enrollment.getEnrollmentData();
        
        if (enrollmentData == null || enrollmentData.isEmpty()) {
            return 0;
        }
        
        // JSON íŒŒì‹±
        AttendanceDataDto attendanceData = 
            objectMapper.readValue(enrollmentData, AttendanceDataDto.class);
        
        List<AttendancePendingRequestDto> pendingRequests = 
            attendanceData.getPendingRequests();
        
        if (pendingRequests.isEmpty()) {
            return 0; // ëŒ€ê¸° ì¤‘ì¸ ìš”ì²­ ì—†ìŒ
        }
        
        // ë§Œë£Œëœ ìš”ì²­ í•„í„°ë§
        LocalDate today = LocalDate.now();
        List<AttendancePendingRequestDto> expiredRequests = 
            pendingRequests.stream()
                .filter(req -> isExpired(req.getExpiresAt(), today))
                .collect(Collectors.toList());
        
        if (expiredRequests.isEmpty()) {
            return 0; // ë§Œë£Œëœ ìš”ì²­ ì—†ìŒ
        }
        
        log.info("ë§Œë£Œëœ ìš”ì²­ ë°œê²¬: ENR_NO={}, ê°•ì˜={}, í•™ìƒ={}, ê±´ìˆ˜={}", 
                 enrollment.getEnrNo(),
                 enrollment.getLecTbl().getLecSerial(),
                 enrollment.getUserTbl().getUserIdx(),
                 expiredRequests.size());
        
        // ë§Œë£Œëœ ìš”ì²­ ìë™ ìŠ¹ì¸
        for (AttendancePendingRequestDto request : expiredRequests) {
            autoApproveRequest(attendanceData, request);
        }
        
        // ë§Œë£Œëœ ìš”ì²­ ì œê±°
        pendingRequests.removeAll(expiredRequests);
        
        // summary ì¬ê³„ì‚°
        recalculateSummary(attendanceData);
        
        // JSON ì§ë ¬í™” ë° ì €ì¥
        String updatedJson = objectMapper.writeValueAsString(attendanceData);
        enrollment.setEnrollmentData(updatedJson);
        enrollmentRepository.save(enrollment);
        
        return expiredRequests.size();
    }
    
    private boolean isExpired(LocalDateTime expiresAt, LocalDate today) {
        // ë‚ ì§œë§Œ ë¹„êµ (ì‹œê°„ ë¬´ì‹œ)
        LocalDate expiryDate = expiresAt.toLocalDate();
        return !expiryDate.isAfter(today); // expiryDate â‰¤ today
    }
    
    private void autoApproveRequest(
        AttendanceDataDto attendanceData,
        AttendancePendingRequestDto request
    ) {
        // sessionsë¡œ ì´ë™
        AttendanceSessionDto session = AttendanceSessionDto.builder()
            .sessionNumber(request.getSessionNumber())
            .status("ì¶œ") // ìë™ ìŠ¹ì¸ì€ í•­ìƒ "ì¶œì„"
            .requestDate(request.getRequestDate())
            .approvedDate(LocalDateTime.now())
            .approvedBy(null) // êµìˆ˜ê°€ ì•„ë‹Œ ì‹œìŠ¤í…œ ìŠ¹ì¸
            .tempApproved(true) // ìë™ ìŠ¹ì¸ í”Œë˜ê·¸
            .build();
        
        attendanceData.getSessions().add(session);
    }
    
    private void recalculateSummary(AttendanceDataDto attendanceData) {
        int attended = 0;
        int late = 0;
        int absent = 0;
        
        for (AttendanceSessionDto session : attendanceData.getSessions()) {
            switch (session.getStatus()) {
                case "ì¶œ": attended++; break;
                case "ì§€": late++; break;
                case "ê²°": absent++; break;
            }
        }
        
        int totalSessions = attendanceData.getSessions().size() 
                          + attendanceData.getPendingRequests().size();
        
        double attendanceRate = totalSessions > 0 
            ? (attended * 100.0) / totalSessions 
            : 0.0;
        
        AttendanceSummaryDto summary = attendanceData.getSummary();
        summary.setAttended(attended);
        summary.setLate(late);
        summary.setAbsent(absent);
        summary.setTotalSessions(totalSessions);
        summary.setAttendanceRate(attendanceRate);
        summary.setUpdatedAt(LocalDateTime.now());
    }
}
```

---

## ë‚ ì§œ ë¹„êµ ë¡œì§

### isExpired ë©”ì„œë“œ

```java
private boolean isExpired(LocalDateTime expiresAt, LocalDate today) {
    // 1. expiresAtì—ì„œ ë‚ ì§œë§Œ ì¶”ì¶œ
    LocalDate expiryDate = expiresAt.toLocalDate();
    // ì˜ˆ: 2025-10-30T00:00:00 â†’ 2025-10-30
    
    // 2. ë‚ ì§œ ë¹„êµ (ì‹œê°„ ë¬´ì‹œ)
    return !expiryDate.isAfter(today);
    // expiryDate â‰¤ today â†’ true (ë§Œë£Œë¨)
    // expiryDate > today â†’ false (ì•„ì§ ìœ íš¨)
}
```

### ë¹„êµ ì˜ˆì‹œ

| expiresAt | today | expiryDate | isAfter? | isExpired? | ê²°ê³¼ |
|----------|-------|------------|---------|-----------|------|
| 2025-10-30T00:00:00 | 2025-10-29 | 2025-10-30 | true | false | ì•„ì§ ìœ íš¨ |
| 2025-10-30T00:00:00 | 2025-10-30 | 2025-10-30 | false | true | âœ… ë§Œë£Œ |
| 2025-10-30T00:00:00 | 2025-10-31 | 2025-10-30 | false | true | âœ… ë§Œë£Œ |
| 2025-10-30T00:00:00 | 2025-11-01 | 2025-10-30 | false | true | âœ… ë§Œë£Œ |

### í•µì‹¬ ë¡œì§

```java
!expiryDate.isAfter(today)
```

**ë¶„í•´**:
- `expiryDate.isAfter(today)`: expiryDate > today
- `!`: ë¶€ì • (NOT)
- ê²°ê³¼: `expiryDate â‰¤ today`

**ì˜ë¯¸**:
- ë§Œë£Œì¼ì´ ì˜¤ëŠ˜ ì´ì „ì´ê±°ë‚˜ ì˜¤ëŠ˜ì´ë©´ â†’ ë§Œë£Œë¨ (true)
- ë§Œë£Œì¼ì´ ì˜¤ëŠ˜ ì´í›„ë©´ â†’ ì•„ì§ ìœ íš¨ (false)

---

## ì‹¤í–‰ ì‹œë‚˜ë¦¬ì˜¤

### ì‹œë‚˜ë¦¬ì˜¤ 1: ì •ìƒ ìë™ ìŠ¹ì¸

#### ì´ˆê¸° ìƒíƒœ (10ì›” 23ì¼)

**í•™ìƒ Aì˜ pendingRequests**:
```json
{
  "pendingRequests": [
    {
      "sessionNumber": 1,
      "requestDate": "2025-10-16T14:30:00",
      "expiresAt": "2025-10-23T00:00:00",
      "requestReason": "ë³‘ì› ì§„ë£Œ"
    }
  ],
  "sessions": []
}
```

#### ìŠ¤ì¼€ì¤„ëŸ¬ ì‹¤í–‰ (10ì›” 23ì¼ 00:00:00)

1. **ë‚ ì§œ ë¹„êµ**
   ```java
   expiryDate = 2025-10-23
   today = 2025-10-23
   
   expiryDate.isAfter(today)? â†’ false
   !false â†’ true (ë§Œë£Œë¨)
   ```

2. **ìë™ ìŠ¹ì¸**
   ```json
   {
     "sessionNumber": 1,
     "status": "ì¶œ",
     "requestDate": "2025-10-16T14:30:00",
     "approvedDate": "2025-10-23T00:00:00",
     "approvedBy": null,
     "tempApproved": true
   }
   ```

3. **ìµœì¢… ìƒíƒœ**
   ```json
   {
     "pendingRequests": [],
     "sessions": [
       {
         "sessionNumber": 1,
         "status": "ì¶œ",
         "requestDate": "2025-10-16T14:30:00",
         "approvedDate": "2025-10-23T00:00:00",
         "approvedBy": null,
         "tempApproved": true
       }
     ],
     "summary": {
       "attended": 1,
       "late": 0,
       "absent": 0,
       "totalSessions": 1,
       "attendanceRate": 100.0
     }
   }
   ```

### ì‹œë‚˜ë¦¬ì˜¤ 2: ë¶€ë¶„ ìë™ ìŠ¹ì¸

#### ì´ˆê¸° ìƒíƒœ (10ì›” 25ì¼)

**í•™ìƒ Bì˜ pendingRequests**:
```json
{
  "pendingRequests": [
    {
      "sessionNumber": 1,
      "requestDate": "2025-10-18T10:00:00",
      "expiresAt": "2025-10-25T00:00:00",
      "requestReason": null
    },
    {
      "sessionNumber": 2,
      "requestDate": "2025-10-23T15:00:00",
      "expiresAt": "2025-10-30T00:00:00",
      "requestReason": "ê°€ì¡± í–‰ì‚¬"
    }
  ],
  "sessions": []
}
```

#### ìŠ¤ì¼€ì¤„ëŸ¬ ì‹¤í–‰ (10ì›” 25ì¼ 00:00:00)

1. **íšŒì°¨ 1 ê²€ì‚¬**
   ```java
   expiryDate = 2025-10-25
   today = 2025-10-25
   isExpired? â†’ true âœ… (ìë™ ìŠ¹ì¸)
   ```

2. **íšŒì°¨ 2 ê²€ì‚¬**
   ```java
   expiryDate = 2025-10-30
   today = 2025-10-25
   isExpired? â†’ false âŒ (ì•„ì§ ìœ íš¨)
   ```

3. **ìµœì¢… ìƒíƒœ**
   ```json
   {
     "pendingRequests": [
       {
         "sessionNumber": 2,
         "requestDate": "2025-10-23T15:00:00",
         "expiresAt": "2025-10-30T00:00:00",
         "requestReason": "ê°€ì¡± í–‰ì‚¬"
       }
     ],
     "sessions": [
       {
         "sessionNumber": 1,
         "status": "ì¶œ",
         "requestDate": "2025-10-18T10:00:00",
         "approvedDate": "2025-10-25T00:00:00",
         "approvedBy": null,
         "tempApproved": true
       }
     ],
     "summary": {
       "attended": 1,
       "late": 0,
       "absent": 0,
       "totalSessions": 2,
       "attendanceRate": 50.0
     }
   }
   ```

### ì‹œë‚˜ë¦¬ì˜¤ 3: êµìˆ˜ ìŠ¹ì¸ í›„ ìë™ ìŠ¹ì¸ ì—†ìŒ

#### ì´ˆê¸° ìƒíƒœ (10ì›” 20ì¼)

**í•™ìƒ Cì˜ pendingRequests**:
```json
{
  "pendingRequests": [
    {
      "sessionNumber": 1,
      "requestDate": "2025-10-16T09:00:00",
      "expiresAt": "2025-10-23T00:00:00",
      "requestReason": null
    }
  ],
  "sessions": []
}
```

#### êµìˆ˜ ìŠ¹ì¸ (10ì›” 20ì¼ 14:00:00)

êµìˆ˜ê°€ ìˆ˜ë™ìœ¼ë¡œ "ì§€ê°" ìŠ¹ì¸:
```json
{
  "pendingRequests": [],
  "sessions": [
    {
      "sessionNumber": 1,
      "status": "ì§€",
      "requestDate": "2025-10-16T09:00:00",
      "approvedDate": "2025-10-20T14:00:00",
      "approvedBy": 25,
      "tempApproved": false
    }
  ]
}
```

#### ìŠ¤ì¼€ì¤„ëŸ¬ ì‹¤í–‰ (10ì›” 23ì¼ 00:00:00)

- `pendingRequests`ê°€ ë¹„ì–´ìˆìŒ â†’ ì²˜ë¦¬í•  ìš”ì²­ ì—†ìŒ
- êµìˆ˜ê°€ ì´ë¯¸ ìŠ¹ì¸í•œ ë°ì´í„°ëŠ” ìœ ì§€

---

## tempApproved í”Œë˜ê·¸

### ëª©ì 

êµìˆ˜ì˜ ìˆ˜ë™ ìŠ¹ì¸ê³¼ ì‹œìŠ¤í…œì˜ ìë™ ìŠ¹ì¸ì„ êµ¬ë¶„í•˜ê¸° ìœ„í•œ í”Œë˜ê·¸ì…ë‹ˆë‹¤.

### ê°’ì˜ ì˜ë¯¸

| tempApproved | ì˜ë¯¸ | approvedBy | status |
|--------------|------|-----------|--------|
| `false` | êµìˆ˜ ìˆ˜ë™ ìŠ¹ì¸ | professorIdx (ì˜ˆ: 25) | "ì¶œ", "ì§€", "ê²°" |
| `true` | ì‹œìŠ¤í…œ ìë™ ìŠ¹ì¸ | null | "ì¶œ" (ê³ ì •) |

### ì‚¬ìš© ì˜ˆì‹œ

#### 1. êµìˆ˜ ìˆ˜ë™ ìŠ¹ì¸

```json
{
  "sessionNumber": 1,
  "status": "ì§€",
  "requestDate": "2025-10-16T14:30:00",
  "approvedDate": "2025-10-20T10:00:00",
  "approvedBy": 25,
  "tempApproved": false
}
```

- **í•´ì„**: êµìˆ˜ 25ê°€ 10ì›” 20ì¼ì— "ì§€ê°"ìœ¼ë¡œ ìŠ¹ì¸

#### 2. ì‹œìŠ¤í…œ ìë™ ìŠ¹ì¸

```json
{
  "sessionNumber": 1,
  "status": "ì¶œ",
  "requestDate": "2025-10-16T14:30:00",
  "approvedDate": "2025-10-23T00:00:00",
  "approvedBy": null,
  "tempApproved": true
}
```

- **í•´ì„**: ì‹œìŠ¤í…œì´ 10ì›” 23ì¼ì— ìë™ìœ¼ë¡œ "ì¶œì„" ìŠ¹ì¸

### í”„ë¡ íŠ¸ì—”ë“œ í‘œì‹œ

```jsx
function AttendanceStatusBadge({ session }) {
    if (session.tempApproved) {
        return (
            <span className="badge badge-warning">
                ìë™ ìŠ¹ì¸ (ì¶œì„)
            </span>
        );
    } else {
        const statusLabel = {
            'ì¶œ': 'ì¶œì„',
            'ì§€': 'ì§€ê°',
            'ê²°': 'ê²°ì„'
        };
        
        return (
            <span className="badge badge-success">
                êµìˆ˜ ìŠ¹ì¸ ({statusLabel[session.status]})
            </span>
        );
    }
}
```

---

## ìŠ¤ì¼€ì¤„ëŸ¬ ì„¤ì •

### Cron í‘œí˜„ì‹

```java
@Scheduled(cron = "0 0 0 * * *")
```

**ì˜ë¯¸**:
```
ì´ˆ ë¶„ ì‹œ ì¼ ì›” ìš”ì¼
0  0  0  *  *  *

ì´ˆ: 0ì´ˆ
ë¶„: 0ë¶„
ì‹œ: 0ì‹œ (ìì •)
ì¼: ë§¤ì¼
ì›”: ë§¤ì›”
ìš”ì¼: ë§¤ì£¼ ëª¨ë“  ìš”ì¼
```

**ê²°ê³¼**: ë§¤ì¼ ìì • 00:00:00ì— ì‹¤í–‰

### ë‹¤ë¥¸ Cron ì˜ˆì‹œ

```java
// ë§¤ì¼ ì˜¤ì „ 1ì‹œ
@Scheduled(cron = "0 0 1 * * *")

// ë§¤ì£¼ ì›”ìš”ì¼ ìì •
@Scheduled(cron = "0 0 0 * * MON")

// ë§¤ì›” 1ì¼ ìì •
@Scheduled(cron = "0 0 0 1 * *")

// 30ë¶„ë§ˆë‹¤
@Scheduled(cron = "0 */30 * * * *")
```

### ìŠ¤ì¼€ì¤„ëŸ¬ í™œì„±í™”

```java
@Configuration
@EnableScheduling
public class SchedulerConfig {
    // ìŠ¤ì¼€ì¤„ëŸ¬ í™œì„±í™”
}
```

---

## ë¡œê·¸ ì¶œë ¥

### ì‹¤í–‰ ë¡œê·¸ ì˜ˆì‹œ

```
2025-10-23 00:00:00.001 [pool-1-thread-1] INFO  AutoApprovalScheduler
========================================
ìë™ ìŠ¹ì¸ ìŠ¤ì¼€ì¤„ëŸ¬ ì‹œì‘: 2025-10-23T00:00:00.001
========================================

2025-10-23 00:00:00.123 [pool-1-thread-1] INFO  AutoApprovalScheduler
ì „ì²´ ìˆ˜ê°•ìƒ ìˆ˜: 150

2025-10-23 00:00:00.234 [pool-1-thread-1] INFO  AutoApprovalScheduler
ë§Œë£Œëœ ìš”ì²­ ë°œê²¬: ENR_NO=1, ê°•ì˜=ETH201, í•™ìƒ=6, ê±´ìˆ˜=1

2025-10-23 00:00:00.245 [pool-1-thread-1] INFO  AutoApprovalScheduler
ë§Œë£Œëœ ìš”ì²­ ë°œê²¬: ENR_NO=5, ê°•ì˜=ETH201, í•™ìƒ=7, ê±´ìˆ˜=2

2025-10-23 00:00:00.789 [pool-1-thread-1] INFO  AutoApprovalScheduler
========================================
ìë™ ìŠ¹ì¸ ì™„ë£Œ: ì²˜ë¦¬ í•™ìƒ=2, ìŠ¹ì¸ ê±´ìˆ˜=3
========================================
```

### ë¡œê·¸ ë ˆë²¨ ì„¤ì •

```properties
# application.properties
logging.level.com.bluecrab.scheduler=INFO
logging.level.com.bluecrab.scheduler.AutoApprovalScheduler=DEBUG
```

---

## ì„±ëŠ¥ ìµœì í™”

### 1. ë°°ì¹˜ ì²˜ë¦¬

```java
@Transactional
public void autoApproveExpiredRequests() {
    // ëª¨ë“  ìˆ˜ê°•ìƒ í•œ ë²ˆì— ì¡°íšŒ
    List<EnrollmentExtendedTbl> allEnrollments = 
        enrollmentRepository.findAll();
    
    // ë©”ëª¨ë¦¬ì—ì„œ ì¼ê´„ ì²˜ë¦¬
    List<EnrollmentExtendedTbl> updatedEnrollments = 
        new ArrayList<>();
    
    for (EnrollmentExtendedTbl enrollment : allEnrollments) {
        if (processEnrollment(enrollment) > 0) {
            updatedEnrollments.add(enrollment);
        }
    }
    
    // í•œ ë²ˆì— ì €ì¥
    enrollmentRepository.saveAll(updatedEnrollments);
}
```

### 2. ì¿¼ë¦¬ ìµœì í™”

```java
// ë§Œë£Œëœ ìš”ì²­ì´ ìˆëŠ” ìˆ˜ê°•ìƒë§Œ ì¡°íšŒ
@Query("SELECT e FROM EnrollmentExtendedTbl e " +
       "WHERE e.enrollmentData LIKE '%expiresAt%' " +
       "AND e.enrollmentData LIKE '%pendingRequests%'")
List<EnrollmentExtendedTbl> findEnrollmentsWithPendingRequests();
```

### 3. ë¹„ë™ê¸° ì²˜ë¦¬

```java
@Async
@Scheduled(cron = "0 0 0 * * *")
public void autoApproveExpiredRequests() {
    // ë¹„ë™ê¸° ì‹¤í–‰ (ë©”ì¸ ìŠ¤ë ˆë“œ ë¸”ë¡ ë°©ì§€)
}
```

---

## ì˜ˆì™¸ ì²˜ë¦¬

### try-catch êµ¬ì¡°

```java
for (EnrollmentExtendedTbl enrollment : allEnrollments) {
    try {
        int approvedCount = processEnrollment(enrollment);
        if (approvedCount > 0) {
            totalProcessed++;
            totalApproved += approvedCount;
        }
    } catch (Exception e) {
        // í•œ í•™ìƒ ì‹¤íŒ¨í•´ë„ ë‹¤ë¥¸ í•™ìƒ ê³„ì† ì²˜ë¦¬
        log.error("ìˆ˜ê°•ìƒ ì²˜ë¦¬ ì‹¤íŒ¨: ENR_NO={}", 
                  enrollment.getEnrNo(), e);
    }
}
```

**ì›ì¹™**:
- í•œ í•™ìƒì˜ ì²˜ë¦¬ ì‹¤íŒ¨ê°€ ì „ì²´ ìŠ¤ì¼€ì¤„ëŸ¬ë¥¼ ì¤‘ë‹¨ì‹œí‚¤ì§€ ì•ŠìŒ
- ì‹¤íŒ¨í•œ í•™ìƒì€ ë¡œê·¸ì— ê¸°ë¡ í›„ ë‹¤ìŒ í•™ìƒ ì²˜ë¦¬
- ë‹¤ìŒ ë‚  ìŠ¤ì¼€ì¤„ëŸ¬ ì‹¤í–‰ ì‹œ ì¬ì‹œë„

---

## í…ŒìŠ¤íŠ¸

### ìˆ˜ë™ í…ŒìŠ¤íŠ¸ (ê°œë°œ í™˜ê²½)

```java
@SpringBootTest
public class AutoApprovalSchedulerTest {
    
    @Autowired
    private AutoApprovalScheduler scheduler;
    
    @Test
    public void testAutoApproval() {
        // ìŠ¤ì¼€ì¤„ëŸ¬ ìˆ˜ë™ ì‹¤í–‰
        scheduler.autoApproveExpiredRequests();
        
        // ê²°ê³¼ í™•ì¸
        // ë¡œê·¸ ì¶œë ¥ í™•ì¸
    }
}
```

### Cron í‘œí˜„ì‹ í…ŒìŠ¤íŠ¸

```java
@Test
public void testCronExpression() {
    CronExpression cron = new CronExpression("0 0 0 * * *");
    
    LocalDateTime now = LocalDateTime.of(2025, 10, 23, 0, 0, 0);
    LocalDateTime next = cron.next(now);
    
    assertEquals(LocalDateTime.of(2025, 10, 24, 0, 0, 0), next);
}
```

---

## ì£¼ì˜ì‚¬í•­

### ë°±ì—”ë“œ ê°œë°œì

1. **ë‚ ì§œë§Œ ë¹„êµ**
   - ì‹œê°„ì€ ë¬´ì‹œí•˜ê³  ë‚ ì§œë§Œ ë¹„êµ
   - `toLocalDate()`ë¡œ ë‚ ì§œ ì¶”ì¶œ

2. **íŠ¸ëœì­ì…˜ ë²”ìœ„**
   - ì „ì²´ ìŠ¤ì¼€ì¤„ëŸ¬ë¥¼ í•˜ë‚˜ì˜ íŠ¸ëœì­ì…˜ìœ¼ë¡œ ì²˜ë¦¬
   - ë˜ëŠ” ê° í•™ìƒë³„ë¡œ ë…ë¦½ íŠ¸ëœì­ì…˜

3. **ì˜ˆì™¸ ì²˜ë¦¬**
   - í•œ í•™ìƒ ì‹¤íŒ¨ ì‹œ ë‹¤ë¥¸ í•™ìƒ ê³„ì† ì²˜ë¦¬
   - ì‹¤íŒ¨ ë¡œê·¸ ëª…í™•íˆ ê¸°ë¡

4. **ì„±ëŠ¥**
   - ìˆ˜ê°•ìƒ ìˆ˜ê°€ ë§ì„ ê²½ìš° ë°°ì¹˜ ì²˜ë¦¬
   - ë¹„ë™ê¸° ì‹¤í–‰ ê³ ë ¤

### í”„ë¡ íŠ¸ì—”ë“œ ê°œë°œì

1. **tempApproved í‘œì‹œ**
   - ìë™ ìŠ¹ì¸ê³¼ êµìˆ˜ ìŠ¹ì¸ êµ¬ë¶„ í‘œì‹œ
   - UIì—ì„œ "ìë™ ìŠ¹ì¸" ë°°ì§€ ì¶”ê°€

2. **ì¶œì„ìœ¨ ì—…ë°ì´íŠ¸**
   - ìì • ì´í›„ ì¶œì„ìœ¨ ë³€ê²½ ê°€ëŠ¥
   - í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ ìœ ë„

---

## ë‹¤ìŒ ë‹¨ê³„

- **[03. í•™ìƒ ì¶œì„ ìš”ì²­](./03_í•™ìƒ_ì¶œì„_ìš”ì²­.md)**: expiresAt ê³„ì‚° ë¡œì§
- **[04. êµìˆ˜ ì¶œì„ ìŠ¹ì¸](./04_êµìˆ˜_ì¶œì„_ìŠ¹ì¸.md)**: êµìˆ˜ ìˆ˜ë™ ìŠ¹ì¸ vs ìë™ ìŠ¹ì¸
- **[07. ë°ì´í„° êµ¬ì¡°](./07_ë°ì´í„°_êµ¬ì¡°.md)**: pendingRequests, sessions êµ¬ì¡°

---

**ğŸ“š [ëª©ì°¨ë¡œ ëŒì•„ê°€ê¸°](./README.md)**
