# ğŸ” ë°±ì—”ë“œ ìë™ í•„í„°ë§ ë™ì‘ ì›ë¦¬

Phase 9 ì™„ë£Œ - í•™ìƒ ì¸ì¦ ë° ìë™ í•„í„°ë§ ì‹œìŠ¤í…œ

---

## ğŸ¯ í•µì‹¬ ê°œë…

**í”„ë¡ íŠ¸ì—”ë“œëŠ” ë‹¨ìˆœíˆ APIë§Œ í˜¸ì¶œí•˜ë©´ ë©ë‹ˆë‹¤.**

ë°±ì—”ë“œê°€ ëª¨ë“  ê²ƒì„ ìë™ìœ¼ë¡œ ì²˜ë¦¬í•©ë‹ˆë‹¤:
- âœ… JWT í† í°ìœ¼ë¡œ í•™ìƒ ìë™ ì‹ë³„
- âœ… í•™ìƒì˜ í•™ë¶€/í•™ê³¼ ìë™ ì¡°íšŒ
- âœ… 0-value rule ìë™ ì ìš©
- âœ… ì „ê³µ/ë¶€ì „ê³µ ìë™ ë§¤ì¹­
- âœ… ìˆ˜ê°• ê°€ëŠ¥ ì—¬ë¶€ ìë™ íŒë‹¨

---

## ğŸ”„ ì „ì²´ ë™ì‘ íë¦„

### 1ë‹¨ê³„: í”„ë¡ íŠ¸ì—”ë“œ ìš”ì²­

```javascript
// í”„ë¡ íŠ¸ì—”ë“œëŠ” ì´ê²ƒë§Œ ë³´ë‚´ë©´ ë¨
fetch('/api/lectures/eligible', {
  method: 'POST',
  headers: {
    'Authorization': `Bearer ${token}`  // â† JWT í† í°
  },
  body: JSON.stringify({
    studentId: 15,  // â† í•™ìƒ IDë§Œ ì „ì†¡
    page: 0,
    size: 10
  })
});
```

### 2ë‹¨ê³„: ë°±ì—”ë“œ ìë™ ì²˜ë¦¬

```java
// ë°±ì—”ë“œì—ì„œ ìë™ìœ¼ë¡œ ì²˜ë¦¬í•˜ëŠ” ë‚´ìš©

// 1. JWT í† í° ê²€ì¦ ë° ì‚¬ìš©ì ì‹ë³„
String userEmail = jwtUtils.getEmailFromToken(token);
User user = userRepository.findByUserEmail(userEmail);

// 2. í•™ìƒ ì •ë³´ ìë™ ì¡°íšŒ
// studentIdë¡œ USER_TBLì—ì„œ í•™ìƒì˜ í•™ë¶€/í•™ê³¼ ì½”ë“œ ì¡°íšŒ
String studentMajorFaculty = user.getMajorFacultyCode();  // ì˜ˆ: "01"
String studentMajorDept = user.getMajorDeptCode();        // ì˜ˆ: "001"
String studentMinorFaculty = user.getMinorFacultyCode();  // ì˜ˆ: "02"
String studentMinorDept = user.getMinorDeptCode();        // ì˜ˆ: "002"

// 3. ìˆ˜ê°• ê°€ëŠ¥í•œ ê°•ì˜ ìë™ í•„í„°ë§
List<Lecture> eligibleLectures = lectureRepository.findAll().stream()
    .filter(lecture -> {
        String lecMcode = lecture.getLecMcode();
        String lecMcodeDep = lecture.getLecMcodeDep();
        
        // 3-1. 0-value rule (ëª¨ë“  í•™ìƒ í—ˆìš©)
        if ("0".equals(lecMcode) && "0".equals(lecMcodeDep)) {
            return true;  // êµì–‘ ê³¼ëª© - ëª¨ë“  í•™ìƒ ìˆ˜ê°• ê°€ëŠ¥
        }
        
        // 3-2. í•™ë¶€ë§Œ ì¼ì¹˜ (í•™ê³¼ëŠ” 0)
        if ("0".equals(lecMcodeDep)) {
            return lecMcode.equals(studentMajorFaculty) 
                || lecMcode.equals(studentMinorFaculty);
        }
        
        // 3-3. ì „ê³µ ë§¤ì¹­
        boolean majorMatch = lecMcode.equals(studentMajorFaculty) 
                          && lecMcodeDep.equals(studentMajorDept);
        
        // 3-4. ë¶€ì „ê³µ ë§¤ì¹­
        boolean minorMatch = lecMcode.equals(studentMinorFaculty) 
                          && lecMcodeDep.equals(studentMinorDept);
        
        return majorMatch || minorMatch;
    })
    .collect(Collectors.toList());

// 4. ì‘ë‹µ ë°˜í™˜
return ResponseEntity.ok(eligibleLectures);
```

### 3ë‹¨ê³„: í”„ë¡ íŠ¸ì—”ë“œ ì‘ë‹µ ìˆ˜ì‹ 

```javascript
// ì´ë¯¸ í•„í„°ë§ëœ ê°•ì˜ë§Œ ë°›ìŒ
const data = await response.json();
console.log(data.eligibleLectures);
// â†’ í•´ë‹¹ í•™ìƒì´ ìˆ˜ê°• ê°€ëŠ¥í•œ ê°•ì˜ë§Œ í¬í•¨ë¨!
```

---

## ğŸ” JWT í† í° ìë™ ì²˜ë¦¬

### ë°±ì—”ë“œê°€ ìë™ìœ¼ë¡œ í•˜ëŠ” ì¼

```java
// Spring Security + JWT Filterì—ì„œ ìë™ ì²˜ë¦¬

@Component
public class JwtAuthenticationFilter extends OncePerRequestFilter {
    
    @Override
    protected void doFilterInternal(HttpServletRequest request, ...) {
        // 1. Authorization í—¤ë”ì—ì„œ í† í° ì¶”ì¶œ
        String token = request.getHeader("Authorization").substring(7);
        
        // 2. í† í° ê²€ì¦
        if (jwtUtils.validateToken(token)) {
            // 3. í† í°ì—ì„œ ì‚¬ìš©ì ì •ë³´ ì¶”ì¶œ
            String userEmail = jwtUtils.getEmailFromToken(token);
            
            // 4. ì‚¬ìš©ì ì¡°íšŒ ë° ì¸ì¦ ì„¤ì •
            UserDetails userDetails = userService.loadUserByUsername(userEmail);
            Authentication auth = new UsernamePasswordAuthenticationToken(
                userDetails, null, userDetails.getAuthorities()
            );
            SecurityContextHolder.getContext().setAuthentication(auth);
            // â†’ ì´ì œ ëª¨ë“  Controllerì—ì„œ í˜„ì¬ ì‚¬ìš©ì ì •ë³´ ì‚¬ìš© ê°€ëŠ¥
        }
    }
}
```

### í”„ë¡ íŠ¸ì—”ë“œ ì…ì¥

```javascript
// í”„ë¡ íŠ¸ì—”ë“œëŠ” ê·¸ëƒ¥ í† í°ë§Œ ë³´ë‚´ë©´ ë¨
const token = localStorage.getItem('authToken');

fetch('/api/lectures/eligible', {
  method: 'POST',
  headers: {
    'Authorization': `Bearer ${token}`  // â† ì´ê²ƒë§Œ!
  },
  body: JSON.stringify({
    studentId: 15,
    page: 0,
    size: 10
  })
});

// ë°±ì—”ë“œê°€ ì•Œì•„ì„œ:
// - í† í° ê²€ì¦
// - ì‚¬ìš©ì ì‹ë³„
// - ê¶Œí•œ í™•ì¸
// - í•™ìƒ ì •ë³´ ì¡°íšŒ
// - í•„í„°ë§ ì²˜ë¦¬
```

---

## ğŸ“Š ìë™ í•„í„°ë§ ì˜ˆì‹œ

### ì‹œë‚˜ë¦¬ì˜¤: ì»´í“¨í„°ê³µí•™ê³¼ 2í•™ë…„ í•™ìƒ

**í•™ìƒ ì •ë³´** (ë°±ì—”ë“œê°€ ìë™ ì¡°íšŒ):
```json
{
  "userIdx": 15,
  "userName": "í™ê¸¸ë™",
  "majorFacultyCode": "01",      // ê³µí•™ë¶€
  "majorDeptCode": "001",         // ì»´í“¨í„°ê³µí•™ê³¼
  "minorFacultyCode": "02",      // ìì—°ê³¼í•™ëŒ€í•™
  "minorDeptCode": "003"          // ìˆ˜í•™ê³¼
}
```

**ê°•ì˜ ë°ì´í„°** (DBì— ìˆëŠ” ì „ì²´ ê°•ì˜):
```json
[
  {
    "lecSerial": "CS101",
    "lecTit": "ìë£Œêµ¬ì¡°",
    "lecMcode": "01",      // ê³µí•™ë¶€
    "lecMcodeDep": "001"   // ì»´í“¨í„°ê³µí•™ê³¼
  },
  {
    "lecSerial": "MATH201",
    "lecTit": "ì„ í˜•ëŒ€ìˆ˜í•™",
    "lecMcode": "02",      // ìì—°ê³¼í•™ëŒ€í•™
    "lecMcodeDep": "003"   // ìˆ˜í•™ê³¼
  },
  {
    "lecSerial": "ENG101",
    "lecTit": "ëŒ€í•™ì˜ì–´",
    "lecMcode": "0",       // êµì–‘
    "lecMcodeDep": "0"
  },
  {
    "lecSerial": "MECH201",
    "lecTit": "ê¸°ê³„ê³µí•™ê°œë¡ ",
    "lecMcode": "01",      // ê³µí•™ë¶€
    "lecMcodeDep": "002"   // ê¸°ê³„ê³µí•™ê³¼ (í•™ìƒê³¼ ì•ˆ ë§ìŒ)
  }
]
```

**ë°±ì—”ë“œ ìë™ í•„í„°ë§ ê²°ê³¼**:
```json
{
  "eligibleLectures": [
    {
      "lecSerial": "CS101",
      "lecTit": "ìë£Œêµ¬ì¡°",
      "isEligible": true,
      "eligibilityReason": "ì „ê³µ ì¼ì¹˜ (01-001)"
    },
    {
      "lecSerial": "MATH201",
      "lecTit": "ì„ í˜•ëŒ€ìˆ˜í•™",
      "isEligible": true,
      "eligibilityReason": "ë¶€ì „ê³µ ì¼ì¹˜ (02-003)"
    },
    {
      "lecSerial": "ENG101",
      "lecTit": "ëŒ€í•™ì˜ì–´",
      "isEligible": true,
      "eligibilityReason": "êµì–‘ (0-0 ì „ì²´ í—ˆìš©)"
    }
    // MECH201ì€ ìë™ìœ¼ë¡œ ì œì™¸ë¨ (ê¸°ê³„ê³µí•™ê³¼)
  ]
}
```

---

## â• ì¶”ê°€ í•„í„°ë§ (ì„ íƒì‚¬í•­)

### í”„ë¡ íŠ¸ì—”ë“œì—ì„œ ì¶”ê°€ í•„í„° ê°€ëŠ¥

ê¸°ë³¸ í•„í„°ë§ì€ ë°±ì—”ë“œê°€ ìë™ ì²˜ë¦¬í•˜ê³ ,  
**ì¶”ê°€ ê²€ìƒ‰ ì¡°ê±´ì€ í”„ë¡ íŠ¸ì—”ë“œê°€ ì„ íƒ**:

```javascript
// ê¸°ë³¸ (ë°±ì—”ë“œ ìë™ í•„í„°ë§ë§Œ)
fetch('/api/lectures/eligible', {
  method: 'POST',
  headers: { 'Authorization': `Bearer ${token}` },
  body: JSON.stringify({
    studentId: 15,
    page: 0,
    size: 10
  })
});
// â†’ í•™ë¶€/í•™ê³¼ ê¸°ë°˜ í•„í„°ë§ëœ ê²°ê³¼

// ì¶”ê°€ ê²€ìƒ‰ ì˜µì…˜ ì‚¬ìš©
fetch('/api/lectures/eligible', {
  method: 'POST',
  headers: { 'Authorization': `Bearer ${token}` },
  body: JSON.stringify({
    studentId: 15,
    lecYear: 2,        // â† ì¶”ê°€: 2í•™ë…„ ëŒ€ìƒë§Œ
    lecSemester: 2,    // â† ì¶”ê°€: 2í•™ê¸°ë§Œ
    lecMajor: 1,       // â† ì¶”ê°€: ì „ê³µë§Œ
    name: "ì•Œê³ ë¦¬ì¦˜",   // â† ì¶”ê°€: ê³¼ëª©ëª… ê²€ìƒ‰
    page: 0,
    size: 10
  })
});
// â†’ ê¸°ë³¸ í•„í„°ë§ + ì¶”ê°€ ê²€ìƒ‰ ì¡°ê±´ ì ìš©
```

---

## ğŸ”’ ë³´ì•ˆ ë° ê²€ì¦

### ë°±ì—”ë“œ ìë™ ë³´ì•ˆ ì²˜ë¦¬

```java
@PostMapping("/lectures/eligible")
@PreAuthorize("hasRole('STUDENT')")  // â† í•™ìƒë§Œ ì ‘ê·¼ ê°€ëŠ¥
public ResponseEntity<?> getEligibleLectures(
        @RequestBody EligibleLecturesRequest request,
        Authentication authentication) {  // â† Springì´ ìë™ ì£¼ì…
    
    // 1. JWTì—ì„œ ì¶”ì¶œí•œ í˜„ì¬ ì‚¬ìš©ì ì •ë³´
    String currentUserEmail = authentication.getName();
    User currentUser = userRepository.findByUserEmail(currentUserEmail);
    
    // 2. ìš”ì²­í•œ studentIdì™€ í˜„ì¬ ì‚¬ìš©ì ì¼ì¹˜ ì—¬ë¶€ í™•ì¸
    if (!currentUser.getUserIdx().equals(request.getStudentId())) {
        throw new ForbiddenException("ë³¸ì¸ì˜ ê°•ì˜ë§Œ ì¡°íšŒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
    }
    
    // 3. í•„í„°ë§ ì²˜ë¦¬
    List<Lecture> lectures = filterLecturesForStudent(currentUser);
    
    return ResponseEntity.ok(lectures);
}
```

### í”„ë¡ íŠ¸ì—”ë“œëŠ” ì‹ ê²½ ì“¸ í•„ìš” ì—†ìŒ

```javascript
// ê·¸ëƒ¥ API í˜¸ì¶œë§Œ í•˜ë©´ ë¨
// ë°±ì—”ë“œê°€ ì•Œì•„ì„œ:
// - í† í° ê²€ì¦
// - ê¶Œí•œ í™•ì¸
// - studentId ì¼ì¹˜ ì—¬ë¶€ í™•ì¸
// - í•„í„°ë§ ì²˜ë¦¬
fetch('/api/lectures/eligible', {
  method: 'POST',
  headers: { 'Authorization': `Bearer ${token}` },
  body: JSON.stringify({ studentId: 15, page: 0, size: 10 })
});
```

---

## ğŸ’¡ í•µì‹¬ ì •ë¦¬

### í”„ë¡ íŠ¸ì—”ë“œê°€ í•´ì•¼ í•  ì¼

```javascript
// 1. í† í° ì €ì¥ (ë¡œê·¸ì¸ ì‹œ)
localStorage.setItem('authToken', token);

// 2. API í˜¸ì¶œ ì‹œ í† í° í¬í•¨
fetch('/api/lectures/eligible', {
  method: 'POST',
  headers: { 'Authorization': `Bearer ${localStorage.getItem('authToken')}` },
  body: JSON.stringify({ studentId: 15, page: 0, size: 10 })
});

// 3. ì‘ë‹µ ì²˜ë¦¬
const data = await response.json();
displayLectures(data.eligibleLectures);  // ì´ë¯¸ í•„í„°ë§ë¨!
```

### ë°±ì—”ë“œê°€ ìë™ìœ¼ë¡œ í•˜ëŠ” ì¼

1. âœ… JWT í† í° ê²€ì¦
2. âœ… ì‚¬ìš©ì ì‹ë³„ ë° ì¸ì¦
3. âœ… í•™ìƒ ì •ë³´ ì¡°íšŒ (í•™ë¶€/í•™ê³¼)
4. âœ… 0-value rule ì ìš©
5. âœ… ì „ê³µ/ë¶€ì „ê³µ ë§¤ì¹­
6. âœ… ìˆ˜ê°• ê°€ëŠ¥ ê°•ì˜ë§Œ í•„í„°ë§
7. âœ… ê¶Œí•œ ê²€ì¦ (ë³¸ì¸ ì—¬ë¶€)

---

## ğŸ“ ìš”ì•½

**Phase 9 ì™„ë£Œ ìƒíƒœ**:
- ë°±ì—”ë“œê°€ ëª¨ë“  í•„í„°ë§ì„ ìë™ ì²˜ë¦¬
- í”„ë¡ íŠ¸ì—”ë“œëŠ” APIë§Œ í˜¸ì¶œí•˜ë©´ ë¨
- JWT í† í°ìœ¼ë¡œ í•™ìƒ ìë™ ì‹ë³„
- í•™ë¶€/í•™ê³¼ ê¸°ë°˜ ìë™ í•„í„°ë§
- ì¶”ê°€ ê²€ìƒ‰ ì¡°ê±´ì€ ì„ íƒì‚¬í•­ (í”„ë¡ íŠ¸ê°€ ì›í•˜ë©´ ì¶”ê°€)

**í”„ë¡ íŠ¸ì—”ë“œ ì…ì¥**:
```javascript
// ì´ê²ƒë§Œ í•˜ë©´ ë!
fetch('/api/lectures/eligible', {
  method: 'POST',
  headers: { 'Authorization': `Bearer ${token}` },
  body: JSON.stringify({ studentId: 15, page: 0, size: 10 })
});
// â†’ ìˆ˜ê°• ê°€ëŠ¥í•œ ê°•ì˜ë§Œ ë°›ìŒ (ìë™ í•„í„°ë§ ì™„ë£Œ)
```

---

> **í…ŒìŠ¤íŠ¸ ê²€ì¦**: `lecture-test-2a-student-enrollment.js` (Phase 9)
