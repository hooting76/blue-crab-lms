# ì²¨ë¶€íŒŒì¼-ê²Œì‹œê¸€ ì—°ë™ êµ¬í˜„ ê°€ì´ë“œ

## ğŸ“‹ ê°œìš”

BlueCrab LMSì—ì„œ ê²Œì‹œê¸€ ì‘ì„± ì‹œ ì²¨ë¶€íŒŒì¼ì„ ì—°ë™í•˜ëŠ” ê¸°ëŠ¥ì„ ë‹¨ê³„ë³„ë¡œ êµ¬í˜„í•˜ëŠ” ê°€ì´ë“œì…ë‹ˆë‹¤.

**êµ¬í˜„ ë°©ì‹**: JSON API ìœ ì§€ + ê¸°ì¡´ ì²¨ë¶€íŒŒì¼ ì—…ë¡œë“œ API í™œìš©

## ğŸ¯ ìµœì¢… ëª©í‘œ

ê²Œì‹œê¸€ ì‘ì„± ì‹œ ì²¨ë¶€íŒŒì¼ì„ í•¨ê»˜ ì²˜ë¦¬í•˜ì—¬ `BOARD_TBL.BOARD_FILE` ì»¬ëŸ¼ì— ì²¨ë¶€íŒŒì¼ IDë“¤ì„ ì‰¼í‘œ êµ¬ë¶„ìœ¼ë¡œ ì €ì¥
- ì˜ˆ: `BOARD_FILE = "123,124,125"`

## ğŸ“Š ì „ì²´ í”Œë¡œìš°

```
1. ê²Œì‹œê¸€ ìƒì„± (JSON) â†’ boardIdx íšë“
2. ì²¨ë¶€íŒŒì¼ ì—…ë¡œë“œ (FormData) â†’ attachment IDs íšë“  
3. ì²¨ë¶€íŒŒì¼ ì—°ê²° (JSON) â†’ BOARD_FILE ì—…ë°ì´íŠ¸
```

---

## 1ë‹¨ê³„: BoardTbl ì—”í‹°í‹°ì— ìœ í‹¸ë¦¬í‹° ë©”ì„œë“œ ì¶”ê°€

### ğŸ“ ëª©ì 
`BOARD_FILE` ì»¬ëŸ¼ì— ì²¨ë¶€íŒŒì¼ ID ëª©ë¡ì„ ì‰¼í‘œ êµ¬ë¶„ìœ¼ë¡œ ì €ì¥/ì¡°íšŒí•˜ëŠ” ë©”ì„œë“œ ì¶”ê°€

### ğŸ”§ êµ¬í˜„

**íŒŒì¼**: `BoardTbl.java`

```java
// ========== ì²¨ë¶€íŒŒì¼ ID ê´€ë¦¬ ìœ í‹¸ë¦¬í‹° ë©”ì„œë“œ ì¶”ê°€ ==========

/**
 * ì²¨ë¶€íŒŒì¼ ID ëª©ë¡ì„ BOARD_FILE ì»¬ëŸ¼ì— ì‰¼í‘œ êµ¬ë¶„ìœ¼ë¡œ ì €ì¥
 * @param attachmentIds ì²¨ë¶€íŒŒì¼ ID ëª©ë¡
 */
public void setAttachmentIds(List<Integer> attachmentIds) {
    if (attachmentIds != null && !attachmentIds.isEmpty()) {
        this.boardFile = attachmentIds.stream()
            .map(String::valueOf)
            .collect(Collectors.joining(","));
    } else {
        this.boardFile = null;
    }
}

/**
 * BOARD_FILE ì»¬ëŸ¼ì—ì„œ ì²¨ë¶€íŒŒì¼ ID ëª©ë¡ì„ íŒŒì‹±í•˜ì—¬ ë°˜í™˜
 * @return ì²¨ë¶€íŒŒì¼ ID ëª©ë¡
 */
public List<Integer> getAttachmentIds() {
    if (boardFile == null || boardFile.trim().isEmpty()) {
        return new ArrayList<>();
    }
    
    return Arrays.stream(boardFile.split(","))
        .filter(id -> !id.trim().isEmpty())
        .map(id -> Integer.parseInt(id.trim()))
        .collect(Collectors.toList());
}

/**
 * ì²¨ë¶€íŒŒì¼ì´ ìˆëŠ”ì§€ í™•ì¸
 * @return ì²¨ë¶€íŒŒì¼ ì¡´ì¬ ì—¬ë¶€
 */
public boolean hasAttachments() {
    return boardFile != null && !boardFile.trim().isEmpty();
}
```

### ğŸ“¦ Import ì¶”ê°€

```java
import java.util.Arrays;
import java.util.List;
import java.util.ArrayList;
import java.util.stream.Collectors;
```

---

## 2ë‹¨ê³„: ì²¨ë¶€íŒŒì¼ ì—°ê²° DTO í´ë˜ìŠ¤ ìƒì„±

### ğŸ“ ëª©ì 
ì²¨ë¶€íŒŒì¼ ID ëª©ë¡ì„ ë°›ê¸° ìœ„í•œ ìš”ì²­ DTO ìƒì„±

### ğŸ”§ êµ¬í˜„

**íŒŒì¼**: `AttachmentLinkRequest.java`

```java
// filepath: f:\main_project\team_work\blue-crab-lms\backend\BlueCrab\src\main\java\BlueCrab\com\example\dto\AttachmentLinkRequest.java
// ì‘ì„±ì : ì„±íƒœì¤€
// ì²¨ë¶€íŒŒì¼ ì—°ê²° ìš”ì²­ DTO

package BlueCrab.com.example.dto;

import javax.validation.constraints.NotNull;
import javax.validation.constraints.Size;
import java.util.List;

public class AttachmentLinkRequest {
    
    @NotNull(message = "ì²¨ë¶€íŒŒì¼ ID ëª©ë¡ì€ í•„ìˆ˜ì…ë‹ˆë‹¤")
    @Size(max = 5, message = "ì²¨ë¶€íŒŒì¼ì€ ìµœëŒ€ 5ê°œê¹Œì§€ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤")
    private List<Integer> attachmentIds;
    
    // ========== ìƒì„±ì ==========
    
    public AttachmentLinkRequest() {}
    
    public AttachmentLinkRequest(List<Integer> attachmentIds) {
        this.attachmentIds = attachmentIds;
    }
    
    // ========== Getter/Setter ==========
    
    public List<Integer> getAttachmentIds() {
        return attachmentIds;
    }
    
    public void setAttachmentIds(List<Integer> attachmentIds) {
        this.attachmentIds = attachmentIds;
    }
    
    // ========== ìœ í‹¸ë¦¬í‹° ë©”ì„œë“œ ==========
    
    @Override
    public String toString() {
        return "AttachmentLinkRequest{" +
                "attachmentIds=" + attachmentIds +
                '}';
    }
}
```

---

## 3ë‹¨ê³„: BoardControllerì— ì²¨ë¶€íŒŒì¼ ì—°ê²° API ì¶”ê°€

### ğŸ“ ëª©ì 
ê²Œì‹œê¸€ì— ì²¨ë¶€íŒŒì¼ IDë“¤ì„ ì—°ê²°í•˜ëŠ” API ì¶”ê°€

### ğŸ”§ êµ¬í˜„

**íŒŒì¼**: `BoardController.java`

```java
// ========== ì²¨ë¶€íŒŒì¼ ì—°ê²° API ì¶”ê°€ ==========

/**
 * ê²Œì‹œê¸€ì— ì²¨ë¶€íŒŒì¼ ì—°ê²°
 * @param boardIdx ê²Œì‹œê¸€ IDX
 * @param request ì²¨ë¶€íŒŒì¼ ID ëª©ë¡
 * @return ì„±ê³µ ì‘ë‹µ
 */
@PostMapping("/{boardIdx}/link-attachments")
public ResponseEntity<Map<String, Object>> linkAttachments(
        @PathVariable Integer boardIdx,
        @Valid @RequestBody AttachmentLinkRequest request,
        HttpServletRequest httpRequest) {

    log.info("ì²¨ë¶€íŒŒì¼ ì—°ê²° ìš”ì²­: boardIdx={}, attachmentIds={}", 
             boardIdx, request.getAttachmentIds());

    try {
        // JWT í† í° ê²€ì¦
        String token = jwtUtil.extractTokenFromRequest(httpRequest);
        if (!jwtUtil.validateToken(token)) {
            log.warn("ìœ íš¨í•˜ì§€ ì•Šì€ JWT í† í°: {}", token);
            return ResponseEntity.status(401)
                .body(Map.of("success", false, "message", "ìœ íš¨í•˜ì§€ ì•Šì€ í† í°ì…ë‹ˆë‹¤."));
        }

        // ê²Œì‹œê¸€ ì¡´ì¬ í™•ì¸
        BoardTbl board = boardService.findById(boardIdx);
        if (board == null) {
            log.warn("ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ê²Œì‹œê¸€: boardIdx={}", boardIdx);
            return ResponseEntity.status(404)
                .body(Map.of("success", false, "message", "ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ê²Œì‹œê¸€ì…ë‹ˆë‹¤."));
        }

        // ì²¨ë¶€íŒŒì¼ ID ì—°ê²°
        board.setAttachmentIds(request.getAttachmentIds());
        BoardTbl updatedBoard = boardService.updateBoard(board);

        log.info("ì²¨ë¶€íŒŒì¼ ì—°ê²° ì™„ë£Œ: boardIdx={}, boardFile={}", 
                 boardIdx, updatedBoard.getBoardFile());

        return ResponseEntity.ok(Map.of(
            "success", true,
            "message", "ì²¨ë¶€íŒŒì¼ì´ ì„±ê³µì ìœ¼ë¡œ ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤.",
            "data", Map.of(
                "boardIdx", boardIdx,
                "attachmentIds", request.getAttachmentIds(),
                "boardFile", updatedBoard.getBoardFile()
            )
        ));

    } catch (NumberFormatException e) {
        log.error("ì˜ëª»ëœ ì²¨ë¶€íŒŒì¼ ID í˜•ì‹: {}", e.getMessage());
        return ResponseEntity.status(400)
            .body(Map.of("success", false, "message", "ì˜ëª»ëœ ì²¨ë¶€íŒŒì¼ ID í˜•ì‹ì…ë‹ˆë‹¤."));
    } catch (Exception e) {
        log.error("ì²¨ë¶€íŒŒì¼ ì—°ê²° ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {}", e.getMessage(), e);
        return ResponseEntity.status(500)
            .body(Map.of("success", false, "message", "ì„œë²„ ë‚´ë¶€ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."));
    }
}
```

### ğŸ“¦ Import ì¶”ê°€

```java
import BlueCrab.com.example.dto.AttachmentLinkRequest;
import javax.validation.Valid;
```

---

## 4ë‹¨ê³„: BoardServiceì— findById ë©”ì„œë“œ í™•ì¸/ì¶”ê°€

### ğŸ“ ëª©ì 
ê²Œì‹œê¸€ ì¡´ì¬ í™•ì¸ì„ ìœ„í•œ ë©”ì„œë“œê°€ ìˆëŠ”ì§€ í™•ì¸í•˜ê³ , ì—†ìœ¼ë©´ ì¶”ê°€

### ğŸ”§ êµ¬í˜„ í™•ì¸

**íŒŒì¼**: `BoardService.java`

```java
// ê²Œì‹œê¸€ ì¡°íšŒ ë©”ì„œë“œê°€ ìˆëŠ”ì§€ í™•ì¸í•˜ê³ , ì—†ìœ¼ë©´ ì¶”ê°€
public BoardTbl findById(Integer boardIdx) {
    return boardRepository.findById(boardIdx).orElse(null);
}

public BoardTbl updateBoard(BoardTbl board) {
    return boardRepository.save(board);
}
```

---

## 5ë‹¨ê³„: í”„ë¡ íŠ¸ì—”ë“œ êµ¬í˜„

### ğŸ“ ëª©ì 
3ë‹¨ê³„ API í˜¸ì¶œì„ ìˆœì°¨ì ìœ¼ë¡œ ì²˜ë¦¬í•˜ëŠ” í”„ë¡ íŠ¸ì—”ë“œ ë¡œì§

### ğŸ”§ êµ¬í˜„

**JavaScript ì˜ˆì‹œ**:

```javascript
/**
 * ì²¨ë¶€íŒŒì¼ì´ í¬í•¨ëœ ê²Œì‹œê¸€ ìƒì„±
 * @param {Object} boardData - ê²Œì‹œê¸€ ë°ì´í„°
 * @param {File[]} files - ì²¨ë¶€íŒŒì¼ ëª©ë¡
 */
const createBoardWithAttachments = async (boardData, files) => {
    try {
        // 1ë‹¨ê³„: ê²Œì‹œê¸€ ìƒì„± (JSON)
        console.log('1ë‹¨ê³„: ê²Œì‹œê¸€ ìƒì„± ì¤‘...');
        const boardResponse = await fetch('/api/boards/create', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${getAuthToken()}`
            },
            body: JSON.stringify(boardData)
        });

        if (!boardResponse.ok) {
            throw new Error('ê²Œì‹œê¸€ ìƒì„± ì‹¤íŒ¨');
        }

        const boardResult = await boardResponse.json();
        const boardIdx = boardResult.boardIdx || boardResult.data?.boardIdx;
        
        console.log(`ê²Œì‹œê¸€ ìƒì„± ì™„ë£Œ: boardIdx=${boardIdx}`);

        // 2ë‹¨ê³„: ì²¨ë¶€íŒŒì¼ ì—…ë¡œë“œ (FormData) - íŒŒì¼ì´ ìˆëŠ” ê²½ìš°ë§Œ
        let attachmentIds = [];
        if (files && files.length > 0) {
            console.log(`2ë‹¨ê³„: ì²¨ë¶€íŒŒì¼ ì—…ë¡œë“œ ì¤‘... (${files.length}ê°œ)`);
            
            const formData = new FormData();
            files.forEach(file => formData.append('files', file));

            const attachmentResponse = await fetch(`/api/board-attachments/upload/${boardIdx}`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${getAuthToken()}`
                },
                body: formData
            });

            if (!attachmentResponse.ok) {
                throw new Error('ì²¨ë¶€íŒŒì¼ ì—…ë¡œë“œ ì‹¤íŒ¨');
            }

            const attachmentResult = await attachmentResponse.json();
            attachmentIds = attachmentResult.map(att => att.attachmentIdx);
            
            console.log(`ì²¨ë¶€íŒŒì¼ ì—…ë¡œë“œ ì™„ë£Œ: attachmentIds=${attachmentIds}`);

            // 3ë‹¨ê³„: ì²¨ë¶€íŒŒì¼ ì—°ê²° (JSON)
            console.log('3ë‹¨ê³„: ì²¨ë¶€íŒŒì¼ ì—°ê²° ì¤‘...');
            const linkResponse = await fetch(`/api/boards/${boardIdx}/link-attachments`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${getAuthToken()}`
                },
                body: JSON.stringify({ attachmentIds })
            });

            if (!linkResponse.ok) {
                throw new Error('ì²¨ë¶€íŒŒì¼ ì—°ê²° ì‹¤íŒ¨');
            }

            const linkResult = await linkResponse.json();
            console.log(`ì²¨ë¶€íŒŒì¼ ì—°ê²° ì™„ë£Œ: boardFile=${linkResult.data.boardFile}`);
        }

        return {
            success: true,
            boardIdx: boardIdx,
            attachmentIds: attachmentIds,
            message: 'ê²Œì‹œê¸€ì´ ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.'
        };

    } catch (error) {
        console.error('ê²Œì‹œê¸€ ìƒì„± ì¤‘ ì˜¤ë¥˜:', error);
        return {
            success: false,
            message: error.message || 'ê²Œì‹œê¸€ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'
        };
    }
};

// ì‚¬ìš© ì˜ˆì‹œ
const handleSubmit = async () => {
    const boardData = {
        boardCode: 1,
        boardWriter: "í™ê¸¸ë™",
        boardTitle: "ì œëª©",
        boardContent: "ë‚´ìš©"
    };
    
    const files = document.getElementById('fileInput').files;
    const result = await createBoardWithAttachments(boardData, Array.from(files));
    
    if (result.success) {
        alert('ê²Œì‹œê¸€ì´ ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!');
        location.href = `/board/view/${result.boardIdx}`;
    } else {
        alert(`ì˜¤ë¥˜: ${result.message}`);
    }
};
```

---

## 6ë‹¨ê³„: í…ŒìŠ¤íŠ¸

### ğŸ“ í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤

#### **ì‹œë‚˜ë¦¬ì˜¤ 1: ì²¨ë¶€íŒŒì¼ ì—†ëŠ” ê²Œì‹œê¸€**
```javascript
const result = await createBoardWithAttachments({
    boardCode: 1,
    boardWriter: "í…ŒìŠ¤í„°",
    boardTitle: "ì²¨ë¶€íŒŒì¼ ì—†ëŠ” ê²Œì‹œê¸€",
    boardContent: "ë‚´ìš©ì…ë‹ˆë‹¤."
}, []);

// ì˜ˆìƒ ê²°ê³¼: BOARD_FILE = null
```

#### **ì‹œë‚˜ë¦¬ì˜¤ 2: ì²¨ë¶€íŒŒì¼ 1ê°œ**
```javascript
const files = [new File(['test'], 'test.txt', {type: 'text/plain'})];
const result = await createBoardWithAttachments(boardData, files);

// ì˜ˆìƒ ê²°ê³¼: BOARD_FILE = "123"
```

#### **ì‹œë‚˜ë¦¬ì˜¤ 3: ì²¨ë¶€íŒŒì¼ 3ê°œ**
```javascript
const files = [
    new File(['test1'], 'test1.txt'),
    new File(['test2'], 'test2.txt'), 
    new File(['test3'], 'test3.txt')
];
const result = await createBoardWithAttachments(boardData, files);

// ì˜ˆìƒ ê²°ê³¼: BOARD_FILE = "123,124,125"
```

---

## 7ë‹¨ê³„: ê²€ì¦ ë° í™•ì¸

### ğŸ“ í™•ì¸ ì‚¬í•­

1. **ë°ì´í„°ë² ì´ìŠ¤ í™•ì¸**
   ```sql
   SELECT BOARD_IDX, BOARD_TITLE, BOARD_FILE 
   FROM BOARD_TBL 
   WHERE BOARD_IDX = [ìƒì„±ëœ_ê²Œì‹œê¸€_ID];
   
   SELECT ATTACHMENT_IDX, BOARD_IDX, ORIGINAL_FILE_NAME 
   FROM BOARD_ATTACHMENT_TBL 
   WHERE BOARD_IDX = [ìƒì„±ëœ_ê²Œì‹œê¸€_ID];
   ```

2. **ë¡œê·¸ í™•ì¸**
   - ê° ë‹¨ê³„ë³„ ë¡œê·¸ ë©”ì‹œì§€ í™•ì¸
   - ì—ëŸ¬ ë¡œê·¸ ì—†ìŒ í™•ì¸

3. **ì‘ë‹µ ë°ì´í„° í™•ì¸**
   - ê° API ì‘ë‹µ êµ¬ì¡° ì •í™•ì„±
   - attachmentIds ë°°ì—´ ì •í™•ì„±

---

## ğŸ¯ êµ¬í˜„ ì™„ë£Œ ì²´í¬ë¦¬ìŠ¤íŠ¸

- [ ] 1ë‹¨ê³„: BoardTbl ìœ í‹¸ë¦¬í‹° ë©”ì„œë“œ ì¶”ê°€
- [ ] 2ë‹¨ê³„: AttachmentLinkRequest DTO ìƒì„±
- [ ] 3ë‹¨ê³„: BoardController API ì¶”ê°€
- [ ] 4ë‹¨ê³„: BoardService ë©”ì„œë“œ í™•ì¸
- [ ] 5ë‹¨ê³„: í”„ë¡ íŠ¸ì—”ë“œ ë¡œì§ êµ¬í˜„
- [ ] 6ë‹¨ê³„: í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤ ì‹¤í–‰
- [ ] 7ë‹¨ê³„: ê²€ì¦ ì™„ë£Œ

## ğŸš€ ì˜ˆìƒ êµ¬í˜„ ì‹œê°„

- **ë°±ì—”ë“œ**: 30ë¶„
- **í”„ë¡ íŠ¸ì—”ë“œ**: 30ë¶„
- **í…ŒìŠ¤íŠ¸**: 15ë¶„
- **ì´ ì‹œê°„**: 1ì‹œê°„ 15ë¶„

---

## ğŸ“‹ ìµœì¢… ê²°ê³¼

êµ¬í˜„ ì™„ë£Œ í›„ ë‹¤ìŒê³¼ ê°™ì€ ê²°ê³¼ë¥¼ ì–»ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤:

1. **JSON API ì™„ì „ ìœ ì§€**: ê¸°ì¡´ ì¸í„°í˜ì´ìŠ¤ ë³€ê²½ ì—†ìŒ
2. **ê¸°ì¡´ ì½”ë“œ ì¬ì‚¬ìš©**: ê²€ì¦ëœ ì²¨ë¶€íŒŒì¼ ì—…ë¡œë“œ ë¡œì§ í™œìš©
3. **ì„±ëŠ¥ ìµœì í™”**: BOARD_FILEì—ì„œ ì§ì ‘ ì²¨ë¶€íŒŒì¼ ì¡°íšŒ
4. **í™•ì¥ì„±**: ìµœëŒ€ 5ê°œ ì²¨ë¶€íŒŒì¼ ì§€ì›
5. **ì•ˆì •ì„±**: ë‹¨ê³„ë³„ ì—ëŸ¬ ì²˜ë¦¬ ë° ë¡¤ë°±

ê²Œì‹œê¸€ê³¼ ì²¨ë¶€íŒŒì¼ì´ ì™„ë²½í•˜ê²Œ ì—°ë™ëœ ì‹œìŠ¤í…œì´ ì™„ì„±ë©ë‹ˆë‹¤! ğŸ‰