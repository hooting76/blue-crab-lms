# 성적 기능 테스트 현황 보고

**작성일**: 2025-10-27  
**목적**: 성적 기능(출석+과제 연산) 테스트 전 현황 파악

---

## 📊 현재 DB 상태 분석

### 1. ENROLLMENT_EXTENDED_TBL 데이터
```sql
-- 샘플 데이터 (ENROLLMENT_IDX=1)
{
  "attendance": {
    "summary": {
      "attended": 0,
      "late": 0,
      "absent": 0,
      "totalSessions": 0,
      "attendanceRate": 0.0,
      "updatedAt": "2025-10-27 09:52:39"
    },
    "sessions": [],
    "pendingRequests": [
      {
        "sessionNumber": 1,
        "requestDate": "2025-10-27 09:52:39",
        "expiresAt": "2025-11-03 00:00:00",
        "tempApproved": true
      }
    ]
  }
}
```

**문제점**:
- `grade` 필드가 없음 (성적 계산 결과가 저장되지 않음)
- `gradeConfig` 필드가 없음 (성적 구성 설정이 없음)
- 대부분의 레코드가 빈 JSON `{}` 또는 출석 데이터만 존재

### 2. ASSIGNMENT_EXTENDED_TBL 데이터
```json
{
  "assignment": {
    "description": "300자 이상",
    "maxScore": 25,
    "title": "식인대게의 생태조사",
    "dueDate": "2025-12-31"
  },
  "submissions": []
}
```

**상태**: 과제는 생성되어 있으나 제출물(`submissions`)이 대부분 비어있음

---

## 🔧 성적 계산 로직 분석

### GradeCalculationService.java

#### 주요 메서드:
1. **calculateStudentGrade(lecIdx, studentIdx)**
   - 출석 점수 계산 (`calculateAttendanceScore`)
   - 과제 점수 집계 (`calculateAssignmentScores`)
   - 총점 계산 (`calculateTotalScore`)
   - ENROLLMENT_DATA JSON 업데이트

2. **calculateTotalScore(attendanceData, assignmentScores)**
   ```java
   // 출석 점수 + 과제 점수 합계
   double totalScore = attendanceScore + assignmentScore;
   double totalMax = attendanceMax + assignmentMax;
   
   // 백분율 계산 (0-100, 소수점 둘째자리)
   double percentage = (totalScore / totalMax) * 100.0;
   percentage = Math.round(percentage * 100.0) / 100.0;
   ```

3. **지각 감점 적용**
   ```java
   if (latePenaltyPerSession > 0.0) {
       int lateCount = ((Number) attendanceData.get("lateCount")).intValue();
       double penalty = lateCount * latePenaltyPerSession;
       double adjustedScore = Math.max(0.0, currentScore - penalty);
   }
   ```

#### JSON 구조:
```json
{
  "attendance": { /* 출석 원본 데이터 */ },
  "grade": {
    "attendanceScore": {
      "currentScore": 18.5,
      "maxScore": 20,
      "percentage": 92.5,
      "lateCount": 1,
      "latePenalty": 0.5
    },
    "assignments": [
      {
        "assignIdx": 1,
        "score": 20,
        "maxScore": 25
      }
    ],
    "total": {
      "score": 38.5,
      "maxScore": 45,
      "percentage": 85.56
    }
  },
  "gradeConfig": {
    "attendanceMaxScore": 20,
    "assignmentTotalScore": 50,
    "latePenaltyPerSession": 0.5,
    "gradeDistribution": { "A": 30, "B": 40, "C": 20, "D": 10 }
  }
}
```

---

## 🧪 테스트 시나리오

### 시나리오 1: 성적 구성 설정
**API**: `POST /api/enrollments/grade-config`

```json
{
  "action": "set-config",
  "lecSerial": "CS284",
  "attendanceMaxScore": 20,
  "assignmentTotalScore": 50,
  "latePenaltyPerSession": 0.5,
  "gradeDistribution": {
    "A": 30,
    "B": 40,
    "C": 20,
    "D": 10
  }
}
```

**예상 결과**:
- 모든 수강생의 ENROLLMENT_DATA에 `gradeConfig` 추가
- `totalMaxScore` = 70 계산

---

### 시나리오 2: 개별 학생 성적 조회
**API**: `POST /api/enrollments/grade-info`

```json
{
  "action": "get-grade",
  "lecSerial": "CS284",
  "studentIdx": 6
}
```

**테스트 케이스**:
1. **출석 데이터가 있는 경우**
   - `attendance.summary` 기반으로 점수 계산
   - 지각 감점 적용 확인

2. **과제 제출이 있는 경우**
   - `submissions` 배열에서 점수 합산
   - 백분율 계산 확인

3. **출석+과제 모두 있는 경우**
   - 총점 계산 정확성
   - 소수점 반올림 확인

4. **데이터가 없는 경우**
   - 0점 처리
   - 예외 발생하지 않음

---

### 시나리오 3: 전체 수강생 성적 목록
**API**: `POST /api/enrollments/grade-list`

```json
{
  "action": "list-all",
  "lecSerial": "CS284",
  "professorIdx": 6
}
```

**확인 사항**:
- 모든 수강생 성적 일괄 계산
- 순위 계산 (내림차순 정렬)
- 평균 계산

---

## ⚠️ 주요 확인 사항

### 1. ENROLLMENT_DATA 초기화 여부
**현재 상황**:
- 대부분의 레코드가 `{}` 또는 `attendance`만 있음
- `grade`, `gradeConfig` 필드 없음

**선택지**:
- **A안**: DB 초기화 (모든 ENROLLMENT_DATA를 `{}`로)
  - 장점: 깨끗한 테스트 환경
  - 단점: 기존 출석 데이터 손실

- **B안**: 기존 데이터 유지, 점진적 업데이트
  - 장점: 출석 데이터 보존
  - 단점: 혼합된 상태에서 테스트

**권장**: **B안** (기존 attendance 데이터 유지하면서 grade 필드 추가)

---

### 2. 출석 점수 계산 의존성
**확인 필요**:
- `AttendanceService.calculateAttendanceScoreForGrade()` 메서드 존재 여부
- 출석 데이터 → 점수 변환 로직 검증

### 3. 과제 점수 계산 의존성
**확인 필요**:
- `AssignmentService.getStudentAssignmentScoresForGrade()` 메서드 존재 여부
- 과제 제출물 → 점수 변환 로직 검증

---

## 📋 테스트 체크리스트

- [ ] 1. DB 현재 상태 백업
- [ ] 2. 테스트용 강의 데이터 확인 (LEC_IDX=6, CS284)
- [ ] 3. 테스트용 학생 데이터 확인 (STUDENT_IDX=6)
- [ ] 4. 성적 구성 설정 API 테스트
- [ ] 5. 개별 학생 성적 조회 API 테스트
  - [ ] 출석만 있는 경우
  - [ ] 과제만 있는 경우
  - [ ] 출석+과제 있는 경우
  - [ ] 데이터 없는 경우
- [ ] 6. 전체 수강생 성적 목록 API 테스트
- [ ] 7. 지각 감점 적용 확인
- [ ] 8. 소수점 반올림 정확성 확인
- [ ] 9. ENROLLMENT_DATA JSON 업데이트 확인
- [ ] 10. 성능 테스트 (다수 수강생)

---

## 🔍 다음 단계

1. **AttendanceService, AssignmentService 확인**
   - `calculateAttendanceScoreForGrade()` 메서드 구현 확인
   - `getStudentAssignmentScoresForGrade()` 메서드 구현 확인

2. **실제 API 테스트 수행**
   - Postman/Thunder Client로 각 시나리오 테스트
   - 응답 데이터 검증
   - DB 업데이트 확인

3. **ENROLLMENT_DATA 처리 방침 결정**
   - 기존 데이터 유지 vs 초기화
   - 마이그레이션 스크립트 필요 여부

4. **에러 케이스 테스트**
   - 존재하지 않는 강의/학생
   - 권한 없는 접근
   - 잘못된 JSON 형식
