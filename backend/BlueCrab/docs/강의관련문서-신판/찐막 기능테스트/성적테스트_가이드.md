# 📊 성적 시스템 테스트 가이드 (06_성적_테스트.js)

## 🎯 테스트 목적

**성적 구성 설정이 강의 전체 수강생의 ENROLLMENT_DATA에 올바르게 자동 적용되는지** 확인

### 핵심 개념
- 성적 구성 설정은 **강의 단위**로 수행
- 설정 즉시 **해당 강의의 모든 수강생에게 자동 반영**
- 교수가 1회 설정하면 모든 학생이 동일한 성적 구성 적용받음

---

## 📋 테스트 준비

### 1️⃣ DB 백업 및 초기화

```sql
-- 1. 백업 생성
SELECT 
    ENROLLMENT_IDX,
    STUDENT_IDX,
    ENROLLMENT_DATA,
    CONCAT('UPDATE ENROLLMENT_EXTENDED_TBL SET ENROLLMENT_DATA = ''',
           REPLACE(ENROLLMENT_DATA, '''', ''''''),
           ''' WHERE ENROLLMENT_IDX = ', ENROLLMENT_IDX, ';') AS restore_query
FROM ENROLLMENT_EXTENDED_TBL
WHERE LEC_IDX = 48;  -- ETH201 강의

-- 2. 초기화 (빈 객체로)
UPDATE ENROLLMENT_EXTENDED_TBL 
SET ENROLLMENT_DATA = '{}'
WHERE LEC_IDX = 48;

-- 3. 확인
SELECT ENROLLMENT_IDX, STUDENT_IDX, ENROLLMENT_DATA
FROM ENROLLMENT_EXTENDED_TBL
WHERE LEC_IDX = 48;
```

### 2️⃣ 브라우저 로그인

- 교수 계정으로 로그인 (ETH201 강의 담당 교수)
- 예: `prof.octopus@univ.edu` / `1234`

---

## 🚀 테스트 실행 순서

### Step 1: 스크립트 로드

브라우저 콘솔에서 `06_성적_테스트.js` 파일 내용 복사 후 실행

```javascript
// 스크립트가 로드되면 다음 메시지 출력:
// ✅ 성적 API 테스트 로드 완료
```

### Step 2: 컨텍스트 설정

**성적 구성 설정 시 (강의 단위):**
```javascript
gradeTest.setContext({ 
    lecSerial: 'ETH201'  // 강의 코드만 필요 (전체 수강생 대상)
})
```

**개별 학생 성적 조회 시:**
```javascript
gradeTest.setContext({ 
    lecSerial: 'ETH201',  // 강의 코드
    studentIdx: 33        // 조회할 학생 IDX (김민준)
})
```

### Step 3: 성적 구성 설정 (최우선!)

```javascript
await gradeTest.config()
```

**프롬프트 입력값:**
```
강의 코드: ETH201 (엔터, 기본값 사용)
출석 만점: 20 (엔터)
과제 총점 참고값: 50 (엔터)
지각 감점/회: 0.3 (엔터)
A 비율: 30 (엔터)
B 비율: 40 (엔터)
C 비율: 20 (엔터)
D 비율: 10 (엔터)
```

**예상 결과:**
```javascript
✅ 성적 구성 저장 완료!
📊 설정 내용:
  - 출석 만점: 20점
  - 과제 총점(참고): 50점
  - 지각 감점: 0.3점/회
  - 등급 분포: A(30%) B(40%) C(20%) D(10%)

🎯 적용 대상: 강의 전체 수강생 (자동 적용)
💡 다음 단계: 출석 입력 → 과제 생성/채점 → 성적 조회
```

---

## ✅ 검증 체크리스트

### DB 확인 사항

**중요: 성적 구성은 강의 전체 수강생에게 자동 적용**

```sql
-- 1. 모든 수강생의 ENROLLMENT_DATA 확인
SELECT 
    ENROLLMENT_IDX,
    STUDENT_IDX,
    JSON_EXTRACT(ENROLLMENT_DATA, '$.gradeConfig') AS grade_config
FROM ENROLLMENT_EXTENDED_TBL
WHERE LEC_IDX = 48;  -- ETH201 강의의 모든 수강생
```

**확인할 내용:**

- [ ] **모든 수강생(23명, ENROLLMENT_IDX 19~41)**의 데이터에 `gradeConfig` 존재
- [ ] `attendanceMaxScore: 20` 저장됨
- [ ] `assignmentTotalScore: 50` 저장됨
- [ ] `latePenaltyPerSession: 0.3` 저장됨
- [ ] `gradeDistribution` 객체 존재 (A:30, B:40, C:20, D:10)
- [ ] `configuredAt` 타임스탬프 존재
- [ ] **신규 수강 신청 학생에게도 자동 적용되는지 확인**

**예상 JSON 구조:**
```json
{
  "gradeConfig": {
    "attendanceMaxScore": 20,
    "assignmentTotalScore": 50,
    "latePenaltyPerSession": 0.3,
    "gradeDistribution": {
      "A": 30,
      "B": 40,
      "C": 20,
      "D": 10
    },
    "configuredAt": "2025-10-28 12:34:56"
  }
}
```

---

## 🔍 추가 테스트

### 1. 학생 성적 조회

```javascript
await gradeTest.studentInfo()
```

**예상 출력:**
```
📊 학생 성적 정보:
  ⚙️  성적 구성: { attendanceMaxScore: 20, ... }
  💯 총점: 0/20 (0.00%)  // 아직 출석/과제 없음
```

### 2. 전체 성적 목록

```javascript
await gradeTest.gradeList()
```

**예상 출력:**
```
📊 총 23명 (페이지 0/1)
  1. 김민준 - 0.00% (N/A)
  2. 이서연 - 0.00% (N/A)
  ...
```

---

## 🎓 성적 계산 로직 확인

### 성적 구성 자동 계산 흐름

```
1. 교수가 config() 실행
        ↓
2. 백엔드에서 ASSIGNMENT_EXTENDED_TBL 조회
   SELECT * FROM ASSIGNMENT_EXTENDED_TBL WHERE LEC_IDX = 48
        ↓
3. 모든 과제의 maxScore 추출 및 합산
   과제1: 10점 + 과제2: 20점 + 중간고사: 40점 + 기말고사: 50점 = 120점
        ↓
4. 총 만점 계산
   totalMaxScore = attendanceMaxScore(20) + 과제합계(120) = 140점
        ↓
5. gradeConfig에 저장 (모든 수강생에게)
```

### 성적 계산 예시

```
학생 성적:
- 출석: 18/20점 (출석 10회, 지각 0회)
- 과제1: 8/10점
- 과제2: 18/20점
- 중간고사(과제): 38/40점
- 기말고사(과제): 45/50점
─────────────────────────
만점: 20 + 10 + 20 + 40 + 50 = 140점 (자동 산출)
총점: 18 + 8 + 18 + 38 + 45 = 127점
백분율: 127/140 = 90.71% → A등급
```

**중요:**
- `assignmentTotalScore`는 참고값 (초기 예상값)
- 실제 만점은 **ASSIGNMENT_EXTENDED_TBL에서 과제 만점을 합산**하여 자동 계산
- 중간/기말고사는 DB상 일반 과제와 동일 (제목만 "중간고사", "기말고사")
- **성적은 자동 계산되며 수동 수정 불필요**

---

## ⚠️ 주의사항

1. **강의 단위 설정**: 성적 구성은 강의별로 설정 → 모든 수강생에게 자동 적용
2. **1회 설정**: 한 번 설정하면 해당 강의의 모든 학생이 동일한 성적 구성 적용
3. **순서 엄수**: 반드시 `config()` → 출석/과제 → 성적 조회 순서
4. **DB 초기화**: 테스트 전 ENROLLMENT_DATA를 `{}` 또는 `''`로 초기화
5. **백업 필수**: 기존 데이터 손실 방지
6. **권한 확인**: 교수 계정으로 로그인해야 설정 가능
7. **강의 코드**: ETH201 (LEC_IDX=48) 확인
8. **신규 수강생**: 설정 후 수강 신청한 학생에게도 자동 적용되어야 함

---

## 🔄 복원 방법

백업 파일에서 생성된 `restore_query` 실행:

```sql
UPDATE ENROLLMENT_EXTENDED_TBL 
SET ENROLLMENT_DATA = '{"grade":...}' 
WHERE ENROLLMENT_IDX = 3;
```

---

## 📝 테스트 결과 기록

| 항목 | 예상 결과 | 실제 결과 | 상태 |
|------|----------|----------|------|
| 성적 구성 저장 | 성공 | | ⬜ |
| 전체 수강생 반영 | 23명 | | ⬜ |
| gradeConfig 존재 | 있음 | | ⬜ |
| 출석 만점 | 20 | | ⬜ |
| 지각 감점 | 0.3 | | ⬜ |
| 등급 분포 합계 | 100% | | ⬜ |

---

## 🎯 다음 단계

성적 구성 설정 완료 후:

1. **04_출석_테스트.js** - 출석 데이터 입력
2. **03_과제_테스트.js** - 과제 생성/제출/채점
3. **06_성적_테스트.js** - 최종 성적 조회 및 등급 배정
