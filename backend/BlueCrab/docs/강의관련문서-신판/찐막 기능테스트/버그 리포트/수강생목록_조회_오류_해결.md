# ğŸ› ìˆ˜ê°•ìƒ ëª©ë¡ ì¡°íšŒ API ë²„ê·¸ ë¦¬í¬íŠ¸

**ì‘ì„±ì¼**: 2025-10-28  
**ë²„ê·¸ ë°œê²¬**: ì„±ì  ê´€ë¦¬ ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸ ì¤‘  
**ì‹¬ê°ë„**: ğŸ”´ Critical (í•µì‹¬ ê¸°ëŠ¥ ì‘ë™ ë¶ˆê°€)  
**ìƒíƒœ**: âœ… í•´ê²°ë¨

---

## ğŸ“‹ ëª©ì°¨
1. [ë¬¸ì œ ìš”ì•½](#ë¬¸ì œ-ìš”ì•½)
2. [ì¦ìƒ](#ì¦ìƒ)
3. [ì›ì¸ ë¶„ì„](#ì›ì¸-ë¶„ì„)
4. [í•´ê²° ë°©ë²•](#í•´ê²°-ë°©ë²•)
5. [í…ŒìŠ¤íŠ¸ ê²°ê³¼](#í…ŒìŠ¤íŠ¸-ê²°ê³¼)
6. [ê´€ë ¨ íŒŒì¼](#ê´€ë ¨-íŒŒì¼)

---

## ë¬¸ì œ ìš”ì•½

**ê°•ì˜ë³„ ìˆ˜ê°•ìƒ ëª©ë¡ì„ ì¡°íšŒí•˜ëŠ” APIê°€ 0ëª…ì„ ë°˜í™˜í•˜ëŠ” ë¬¸ì œ**

- **API ì—”ë“œí¬ì¸íŠ¸**: `POST /api/enrollments/list`
- **ìš”ì²­ íŒŒë¼ë¯¸í„°**: `lecSerial: 'ETH201'`
- **ì˜ˆìƒ ê²°ê³¼**: 25ëª…ì˜ ìˆ˜ê°•ìƒ ëª©ë¡
- **ì‹¤ì œ ê²°ê³¼**: `totalElements: 0` (ë¹ˆ ëª©ë¡)
- **ë°ì´í„°ë² ì´ìŠ¤ ìƒíƒœ**: `ENROLLMENT_EXTENDED_TBL`ì— `LEC_IDX=48` (ETH201)ë¡œ ë“±ë¡ëœ í•™ìƒ 25ëª… ì¡´ì¬ í™•ì¸

---

## ì¦ìƒ

### 1. API ì‘ë‹µ
```javascript
// ìš”ì²­
await enrollmentListTest.list()
// ìš”ì²­ ë°ì´í„°: { lecSerial: 'ETH201', studentIdx: null, page: 0, size: 100 }

// ì‘ë‹µ (ë¬¸ì œ ë°œìƒ ì‹œ)
{
  content: [],
  totalElements: 0,
  totalPages: 0,
  number: 0
}
```

### 2. ë°ì´í„°ë² ì´ìŠ¤ í™•ì¸
```sql
SELECT COUNT(*) FROM ENROLLMENT_EXTENDED_TBL WHERE LEC_IDX = 48;
-- ê²°ê³¼: 25ëª… (studentIdx: 1, 6, 33-55)

SELECT LEC_SERIAL FROM LEC_TBL WHERE LEC_IDX = 48;
-- ê²°ê³¼: 'ETH201'
```

### 3. ì„œë²„ ë¡œê·¸ ë¶„ì„
```
JWTì—ì„œ studentIdx ìë™ ì¶”ì¶œ: 25
ê°•ì˜ë³„ ìˆ˜ê°•ìƒ ì¡°íšŒ ìš”ì²­ - lecSerial: ETH201, studentIdx: 25
ì¡°íšŒ ê²°ê³¼: 0ê±´
```

**í•µì‹¬ ë¬¸ì œì **: JWTì—ì„œ ìë™ ì¶”ì¶œëœ `studentIdx=25` (êµìˆ˜ ê³„ì •ì˜ userIdx)ê°€ ëª…ì‹œì ìœ¼ë¡œ ì „ë‹¬ëœ `lecSerial` íŒŒë¼ë¯¸í„°ë³´ë‹¤ ìš°ì„  ì²˜ë¦¬ë¨

---

## ì›ì¸ ë¶„ì„

### ğŸ” í˜¸ì¶œ ì²´ì¸ ì¶”ì 

1. **Controller** (`EnrollmentController.java`)
   - ìš”ì²­ ìˆ˜ì‹ : `lecSerial='ETH201'`, `studentIdx=null`
   - JWTì—ì„œ `userIdx=25` ìë™ ì¶”ì¶œ â†’ `studentIdx=25`ë¡œ ì„¤ì •
   - **ë¬¸ì œ ë°œìƒ ì§€ì **: ì¡°ê±´ ê²€ì‚¬ ìˆœì„œ ì˜¤ë¥˜

2. **Service** (`EnrollmentService.java`)
   - `getEnrollmentsByLecturePaged(lecIdx, pageable)` í˜¸ì¶œ
   - Repositoryë¡œ ìœ„ì„

3. **Repository** (`EnrollmentExtendedTblRepository.java`)
   - JPA ì¿¼ë¦¬ ì‹¤í–‰:
   ```java
   @Query("SELECT DISTINCT e FROM EnrollmentExtendedTbl e " +
          "JOIN FETCH e.lecture " +
          "JOIN FETCH e.student " +
          "WHERE e.lecIdx = :lecIdx")
   Page<EnrollmentExtendedTbl> findStudentsByLecture(@Param("lecIdx") Integer lecIdx, Pageable pageable);
   ```
   - **ì¿¼ë¦¬ ìì²´ëŠ” ì •ìƒ**: `lecIdx`ë¥¼ ë°›ìœ¼ë©´ í•´ë‹¹ ê°•ì˜ì˜ ìˆ˜ê°•ìƒ ëª©ë¡ ë°˜í™˜

### ğŸ› ê·¼ë³¸ ì›ì¸: Controller ì¡°ê±´ ìš°ì„ ìˆœìœ„ ì˜¤ë¥˜

#### ìˆ˜ì • ì „ ì½”ë“œ (Lines 115-150)
```java
@PostMapping("/list")
public ResponseEntity<ApiResponse<?>> getEnrollmentList(
    @RequestBody EnrollmentListRequest request,
    @RequestHeader(value = "Authorization", required = false) String authHeader) {
    
    // JWTì—ì„œ studentIdx ìë™ ì¶”ì¶œ
    Integer studentIdx = jwtUtil.extractStudentIdx(authHeader);
    
    // 1. í†µê³„ ì¡°íšŒ
    if (request.getStats() != null && request.getStats()) {
        // ...
    }
    
    // 2. í˜„ì¬ ìˆ˜ê°•ì¤‘ì¸ ëª©ë¡
    if (request.getEnrolled() != null && request.getEnrolled() && studentIdx != null) {
        // ...
    }
    
    // âŒ ë¬¸ì œ: studentIdx ì¡°ê±´ì´ lecIdxë³´ë‹¤ ë¨¼ì € ê²€ì‚¬ë¨
    // 3. í•™ìƒë³„ ìˆ˜ê°• ëª©ë¡ (í˜ì´ì§•) - JWTì—ì„œ ì¶”ì¶œëœ studentIdx=25ê°€ ì—¬ê¸°ì„œ ì²˜ë¦¬ë¨
    if (studentIdx != null && !request.getEnrolled()) {
        // studentIdx=25(êµìˆ˜)ë¡œ ì¡°íšŒ â†’ í•™ìƒì´ ì•„ë‹ˆë¯€ë¡œ ë¹ˆ ëª©ë¡ ë°˜í™˜
        return ...;
    }
    
    // 4. ê°•ì˜ë³„ ìˆ˜ê°•ìƒ ëª©ë¡ (í˜ì´ì§•) - ì—¬ê¸°ê¹Œì§€ ë„ë‹¬í•˜ì§€ ëª»í•¨!
    if (lecIdx != null) {
        Pageable pageable = PageRequest.of(request.getPage(), request.getSize());
        Page<EnrollmentExtendedTbl> enrollments = 
            enrollmentService.getEnrollmentsByLecturePaged(lecIdx, pageable);
        // ...
    }
}
```

**ë¬¸ì œ íë¦„**:
1. ìš”ì²­: `{ lecSerial: 'ETH201', studentIdx: null }`
2. JWT ìë™ ì¶”ì¶œ: `studentIdx = 25` (êµìˆ˜ ê³„ì •ì˜ userIdx)
3. ì¡°ê±´ ê²€ì‚¬ ìˆœì„œ:
   - âŒ `if (studentIdx != null && !request.getEnrolled())` â†’ **TRUE** (studentIdx=25 ì¡´ì¬, enrolled=false)
   - ğŸ‘‰ "í•™ìƒ 25ì˜ ìˆ˜ê°• ëª©ë¡" ì¡°íšŒ â†’ êµìˆ˜ëŠ” í•™ìƒì´ ì•„ë‹ˆë¯€ë¡œ ë¹ˆ ëª©ë¡ ë°˜í™˜
   - â›” `if (lecIdx != null)` ì¡°ê±´ì€ **ì‹¤í–‰ë˜ì§€ ì•ŠìŒ**

---

## í•´ê²° ë°©ë²•

### âœ… ìˆ˜ì • ì‚¬í•­: ì¡°ê±´ ê²€ì‚¬ ìˆœì„œ ë³€ê²½

**í•µì‹¬ ì›ì¹™**: **ëª…ì‹œì  íŒŒë¼ë¯¸í„°(lecSerial)ê°€ JWT ìë™ ì¶”ì¶œ ê°’(studentIdx)ë³´ë‹¤ ìš°ì„ **

#### ìˆ˜ì • í›„ ì½”ë“œ (Lines 115-150)
```java
@PostMapping("/list")
public ResponseEntity<ApiResponse<?>> getEnrollmentList(
    @RequestBody EnrollmentListRequest request,
    @RequestHeader(value = "Authorization", required = false) String authHeader) {
    
    // JWTì—ì„œ studentIdx ìë™ ì¶”ì¶œ
    Integer studentIdx = jwtUtil.extractStudentIdx(authHeader);
    
    // 1. í†µê³„ ì¡°íšŒ
    if (request.getStats() != null && request.getStats()) {
        // ...
    }
    
    // 2. í˜„ì¬ ìˆ˜ê°•ì¤‘ì¸ ëª©ë¡
    if (request.getEnrolled() != null && request.getEnrolled() && studentIdx != null) {
        // ...
    }
    
    // âœ… ìˆ˜ì •: lecIdx ì¡°ê±´ì„ studentIdx ì¡°ê±´ë³´ë‹¤ ì•ìœ¼ë¡œ ì´ë™
    // 3. ê°•ì˜ë³„ ìˆ˜ê°•ìƒ ëª©ë¡ (í˜ì´ì§•) - ëª…ì‹œì  íŒŒë¼ë¯¸í„° ìš°ì„  ì²˜ë¦¬
    if (lecIdx != null) {
        Pageable pageable = PageRequest.of(request.getPage(), request.getSize());
        Page<EnrollmentExtendedTbl> enrollments = 
            enrollmentService.getEnrollmentsByLecturePaged(lecIdx, pageable);
        
        Map<String, Object> response = new HashMap<>();
        response.put("content", enrollments.getContent());
        response.put("totalElements", enrollments.getTotalElements());
        response.put("totalPages", enrollments.getTotalPages());
        response.put("number", enrollments.getNumber());
        response.put("size", enrollments.getSize());
        
        return ResponseEntity.ok(ApiResponse.success(response));
    }
    
    // 4. í•™ìƒë³„ ìˆ˜ê°• ëª©ë¡ (í˜ì´ì§•) - JWT ìë™ ì¶”ì¶œ ê°’ì€ í›„ìˆœìœ„
    if (studentIdx != null && !request.getEnrolled()) {
        Pageable pageable = PageRequest.of(request.getPage(), request.getSize());
        Page<EnrollmentExtendedTbl> enrollments = 
            enrollmentService.getEnrollmentsByStudentPaged(studentIdx, pageable);
        // ...
    }
}
```

**ìˆ˜ì • í›„ íë¦„**:
1. ìš”ì²­: `{ lecSerial: 'ETH201', studentIdx: null }`
2. JWT ìë™ ì¶”ì¶œ: `studentIdx = 25`
3. ì¡°ê±´ ê²€ì‚¬ ìˆœì„œ:
   - âœ… `if (lecIdx != null)` â†’ **TRUE** (lecSerial='ETH201' â†’ lecIdx=48)
   - ğŸ‘‰ "ê°•ì˜ 48(ETH201)ì˜ ìˆ˜ê°•ìƒ ëª©ë¡" ì¡°íšŒ â†’ 25ëª… ë°˜í™˜
   - âœ… ì •ìƒ ì‘ë™!

### ğŸ“ ì¶”ê°€ ìˆ˜ì •: í”„ë¡ íŠ¸ì—”ë“œ ë°©ì–´ ì½”ë“œ

```javascript
// 07_ìˆ˜ê°•ìƒëª©ë¡_í…ŒìŠ¤íŠ¸.js
const data = {
    lecSerial,
    studentIdx: null,  // ëª…ì‹œì ìœ¼ë¡œ null ì „ë‹¬í•˜ì—¬ JWT ìë™ ì¶”ì¶œ ë°©ì§€ (ë°±ì—”ë“œ ìˆ˜ì •ìœ¼ë¡œ ë¶ˆí•„ìš”í•˜ì§€ë§Œ ëª…ì‹œì  ë°©ì–´)
    page: parseInt(page, 10) || 0,
    size: parseInt(size, 10) || 100
};
```

---

## í…ŒìŠ¤íŠ¸ ê²°ê³¼

### âœ… ìˆ˜ì • í›„ ì •ìƒ ì‘ë™ í™•ì¸

```javascript
// í…ŒìŠ¤íŠ¸ ì‹¤í–‰
enrollmentListTest.setContext({ lecSerial: 'ETH201' })
await enrollmentListTest.list()

// ì‘ë‹µ (ì„±ê³µ)
{
  success: true,
  data: {
    content: [
      { studentIdx: 6, studentName: 'í…ŒìŠ¤í„°', ... },
      { studentIdx: 1, studentName: 'ì§‘ê°ˆë˜', ... },
      { studentIdx: 33, studentName: 'ê¹€ë¯¼ì¤€', ... },
      // ... ì´ 25ëª…
    ],
    totalElements: 25,
    totalPages: 1,
    number: 0,
    size: 100
  },
  duration: '1281.80ms'
}

// studentIdx ëª©ë¡ (ê²€ì¦ìš©)
[6, 1, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 53, 54, 55]
```

### ğŸ“Š ì„±ëŠ¥
- **ì‘ë‹µ ì‹œê°„**: ~1.3ì´ˆ (25ëª… í•™ìƒ ì •ë³´ + JOIN FETCH)
- **ë°ì´í„° ì •í•©ì„±**: DBì˜ 25ëª… ì „ì› ì¡°íšŒ ì„±ê³µ
- **gradeConfig í™•ì¸**: ëª¨ë“  í•™ìƒì—ê²Œ ì„±ì  êµ¬ì„± ì„¤ì • ì €ì¥ë¨ í™•ì¸

---

## ê´€ë ¨ íŒŒì¼

### ìˆ˜ì •ëœ íŒŒì¼
1. **EnrollmentController.java** (Lines 121-150)
   - ê²½ë¡œ: `backend/BlueCrab/src/main/java/BlueCrab/com/example/controller/Lecture/EnrollmentController.java`
   - ë³€ê²½ ì‚¬í•­: ì¡°ê±´ ê²€ì‚¬ ìˆœì„œ ë³€ê²½ (lecIdx â†’ studentIdx)

### í…ŒìŠ¤íŠ¸ íŒŒì¼
2. **07_ìˆ˜ê°•ìƒëª©ë¡_í…ŒìŠ¤íŠ¸.js**
   - ê²½ë¡œ: `backend/BlueCrab/docs/ê°•ì˜ê´€ë ¨ë¬¸ì„œ-ì‹ íŒ/ì°ë§‰ ê¸°ëŠ¥í…ŒìŠ¤íŠ¸/07_ìˆ˜ê°•ìƒëª©ë¡_í…ŒìŠ¤íŠ¸.js`
   - ìš©ë„: ìˆ˜ê°•ìƒ ëª©ë¡ ì¡°íšŒ API í…ŒìŠ¤íŠ¸ ìŠ¤í¬ë¦½íŠ¸

### ì •ìƒ ë™ì‘í•˜ëŠ” íŒŒì¼ (ìˆ˜ì • ë¶ˆí•„ìš”)
3. **EnrollmentService.java**
   - ê²½ë¡œ: `backend/BlueCrab/src/main/java/BlueCrab/com/example/service/Lecture/EnrollmentService.java`
   - ë©”ì„œë“œ: `getEnrollmentsByLecturePaged(Integer lecIdx, Pageable pageable)`

4. **EnrollmentExtendedTblRepository.java**
   - ê²½ë¡œ: `backend/BlueCrab/src/main/java/BlueCrab/com/example/repository/Lecture/EnrollmentExtendedTblRepository.java`
   - ì¿¼ë¦¬: `findStudentsByLecture(@Param("lecIdx") Integer lecIdx, Pageable pageable)`

---

## êµí›ˆ (Lessons Learned)

### 1. ì¡°ê±´ ê²€ì‚¬ ìˆœì„œì˜ ì¤‘ìš”ì„±
- **ëª…ì‹œì  íŒŒë¼ë¯¸í„°ë¥¼ ì•”ë¬µì  ê°’(JWT ìë™ ì¶”ì¶œ)ë³´ë‹¤ ìš°ì„  ì²˜ë¦¬**í•´ì•¼ í•¨
- ì—¬ëŸ¬ ì¡°ê±´ì´ ë™ì‹œì— ë§Œì¡±ë  ìˆ˜ ìˆëŠ” ê²½ìš°, ìš°ì„ ìˆœìœ„ë¥¼ ëª…í™•íˆ ì •ì˜

### 2. JWT ìë™ ì¶”ì¶œì˜ ë¶€ì‘ìš©
- JWTì—ì„œ ìë™ìœ¼ë¡œ ì¶”ì¶œë˜ëŠ” ê°’ì€ í¸ë¦¬í•˜ì§€ë§Œ, ëª…ì‹œì  íŒŒë¼ë¯¸í„°ì™€ ì¶©ëŒí•  ìˆ˜ ìˆìŒ
- ì¡°ê±´ë¬¸ ì„¤ê³„ ì‹œ "ëª…ì‹œì  ìš”ì²­ ì˜ë„"ë¥¼ ìš°ì„  ê³ ë ¤

### 3. ë””ë²„ê¹… ì²´ì¸ ì¶”ì 
- Controller â†’ Service â†’ Repository ì „ì²´ í˜¸ì¶œ ì²´ì¸ì„ ì¶”ì í•˜ì—¬ ë¬¸ì œ ìœ„ì¹˜ ì •í™•íˆ íŒŒì•…
- ì¿¼ë¦¬ê°€ ì •ìƒì´ë¼ë©´ **ì¡°ê±´ ê²€ì‚¬ ë¡œì§**ì„ ì˜ì‹¬

### 4. ë¡œê·¸ ë©”ì‹œì§€ì˜ ì¤‘ìš”ì„±
- "JWTì—ì„œ studentIdx ìë™ ì¶”ì¶œ: 25" ë¡œê·¸ê°€ ë¬¸ì œ ì›ì¸ íŒŒì•…ì— ê²°ì •ì  ë„ì›€
- ê° ì¡°ê±´ ë¶„ê¸°ì—ì„œ ì–´ë–¤ ë¡œì§ì´ ì‹¤í–‰ë˜ëŠ”ì§€ ë¡œê·¸ë¡œ ë‚¨ê¸°ëŠ” ê²ƒì´ ì¤‘ìš”

---

## ê´€ë ¨ ì´ìŠˆ

- **ë™ì‹œ ë°œìƒ ë¬¸ì œ**: [ì„±ì  êµ¬ì„± ì„¤ì • API 504 Gateway Timeout](./ì„±ì êµ¬ì„±ì„¤ì •_íƒ€ì„ì•„ì›ƒ_í•´ê²°.md)
  - ì›ì¸: 25ëª… í•™ìƒ ìˆœì°¨ ì²˜ë¦¬ (50+ ì´ˆ)
  - í•´ê²°: ë°°ì¹˜ ì²˜ë¦¬ ìµœì í™” + í”„ë¡ íŠ¸ì—”ë“œ íƒ€ì„ì•„ì›ƒ 120ì´ˆ ì—°ì¥

---

**ì‘ì„±ì**: GitHub Copilot  
**ê²€í† **: 2025-10-28 (í”„ë¡œë•ì…˜ ë°°í¬ ì „ í™•ì¸ ì™„ë£Œ)
