# 성적 기능 테스트 준비 완료 보고

**작성일**: 2025-10-27  
**작성자**: AI Assistant

---

## ✅ 현황 확인 완료

### 1. DB 상태 분석
- **ENROLLMENT_EXTENDED_TBL**: 대부분 빈 JSON `{}` 또는 출석 데이터만 존재
- **ASSIGNMENT_EXTENDED_TBL**: 과제 생성됨, 제출물은 대부분 비어있음
- **grade 필드**: 현재 존재하지 않음 (첫 조회 시 자동 생성됨)

### 2. 코드 검증 완료
✅ **GradeCalculationService.java**: 성적 계산 로직 구현 완료
- `calculateStudentGrade()`: 출석+과제 통합 계산
- `calculateTotalScore()`: 총점 및 백분율 계산
- 지각 감점 로직 포함

✅ **AttendanceService.java**: 출석 점수 계산 메서드 확인
- `calculateAttendanceScoreForGrade()`: 출석 데이터 → 점수 변환

✅ **AssignmentService.java**: 과제 점수 계산 메서드 확인
- `getStudentAssignmentScoresForGrade()`: 과제 제출물 → 점수 목록

✅ **EnrollmentController.java**: API 엔드포인트 확인
- `POST /api/enrollments/grade-config`: 성적 구성 설정
- `POST /api/enrollments/grade-info`: 개별 성적 조회
- `POST /api/enrollments/grade-list`: 전체 성적 목록

---

## 📊 성적 계산 로직 요약

### 출석 점수 계산
```
출석 점수 = (출석수 / 총회차) × attendanceMaxScore
지각 감점 = 지각수 × latePenaltyPerSession
최종 출석 점수 = max(0, 출석점수 - 지각감점)
```

### 과제 점수 계산
```
과제 총점 = Σ(각 과제의 제출 점수)
```

### 총점 계산
```
총점 = 출석 점수 + 과제 총점
백분율 = (총점 / 총 만점) × 100
```

### JSON 구조
```json
{
  "attendance": { /* 출석 원본 데이터 */ },
  "grade": {
    "attendanceScore": {
      "currentScore": 14.0,
      "maxScore": 20.0,
      "percentage": 70.00,
      "lateCount": 2,
      "latePenalty": 1.0
    },
    "assignments": [
      { "assignmentIdx": 1, "score": 20, "maxScore": 25 }
    ],
    "total": {
      "score": 34.0,
      "maxScore": 45.0,
      "percentage": 75.56
    }
  },
  "gradeConfig": {
    "attendanceMaxScore": 20,
    "assignmentTotalScore": 50,
    "latePenaltyPerSession": 0.5
  }
}
```

---

## 🧪 테스트 시나리오 (권장 순서)

### STEP 1: 성적 구성 설정 ⭐ 필수
```bash
POST /api/enrollments/grade-config
```
- 강의의 성적 구성 설정 (출석/과제 배점, 지각 감점 등)
- 모든 수강생의 ENROLLMENT_DATA에 `gradeConfig` 추가

### STEP 2: 개별 성적 조회 (데이터 없는 경우)
```bash
POST /api/enrollments/grade-info
```
- 출석/과제 데이터 없을 때 → 0점 처리 확인
- `grade` 필드 자동 생성 확인

### STEP 3: 출석 데이터 추가 후 재조회
- 출석 데이터를 수동으로 추가 (또는 출석 API 사용)
- 출석 점수 계산 및 지각 감점 적용 확인

### STEP 4: 과제 제출 데이터 추가 후 재조회
- 과제 제출물 추가
- 과제 점수 합산 확인

### STEP 5: 전체 수강생 성적 목록
```bash
POST /api/enrollments/grade-list
```
- 전체 수강생 성적 일괄 계산
- 순위 및 통계 확인

---

## ⚠️ ENROLLMENT_DATA 처리 방침

### 권장: 옵션 B (기존 데이터 유지)
- **장점**: 기존 출석 데이터 보존
- **장점**: 실제 운영 환경과 유사
- **장점**: 점진적 업데이트로 안전

### 이유
1. `GradeCalculationService`가 null/empty 데이터를 안전하게 처리
2. 기존 `attendance` 필드를 읽어서 `grade` 필드를 생성
3. 각 API 호출 시 자동으로 JSON 업데이트
4. 데이터 손실 없이 테스트 가능

### 초기화가 필요한 경우만 실행
```sql
-- 특정 강의만 초기화
UPDATE ENROLLMENT_EXTENDED_TBL
SET ENROLLMENT_DATA = '{}'
WHERE LEC_IDX = 6;
```

---

## 📝 테스트 체크리스트

### 기본 테스트
- [ ] 1. 성적 구성 설정 API (`set-config`)
- [ ] 2. 개별 성적 조회 - 데이터 없음 (`get-grade`)
- [ ] 3. 개별 성적 조회 - 출석만 있음
- [ ] 4. 개별 성적 조회 - 과제만 있음
- [ ] 5. 개별 성적 조회 - 출석+과제 모두
- [ ] 6. 전체 성적 목록 조회 (`list-all`)

### 계산 정확성 검증
- [ ] 출석 점수 계산 공식
- [ ] 지각 감점 적용
- [ ] 과제 점수 합산
- [ ] 총점 계산
- [ ] 백분율 계산 (소수점 둘째자리)
- [ ] 0점 미만 방지

### JSON 업데이트 검증
- [ ] `gradeConfig` 추가 확인
- [ ] `grade.attendanceScore` 생성
- [ ] `grade.assignments` 배열 생성
- [ ] `grade.total` 계산
- [ ] 기존 `attendance` 데이터 보존

### 에러 처리
- [ ] 존재하지 않는 강의
- [ ] 존재하지 않는 학생
- [ ] 권한 없는 접근
- [ ] null/empty 데이터 처리

---

## 🚀 테스트 시작 방법

### 1. 백엔드 서버 실행 확인
```bash
# 서버 상태 확인
curl http://localhost:8080/actuator/health
```

### 2. 테스트용 데이터 확인
```sql
-- LEC_IDX=6인 강의의 수강생 목록
SELECT e.ENROLLMENT_IDX, e.STUDENT_IDX, u.USER_NAME, u.USER_CODE
FROM ENROLLMENT_EXTENDED_TBL e
JOIN USER_TBL u ON e.STUDENT_IDX = u.USER_IDX
WHERE e.LEC_IDX = 6
LIMIT 5;
```

### 3. API 테스트 실행
- Thunder Client / Postman 사용
- `성적기능_API_테스트_스크립트.md` 참고
- STEP 1부터 순차적으로 실행

### 4. DB 검증
- 각 API 호출 후 SQL로 ENROLLMENT_DATA 확인
- JSON 구조 및 값 검증

---

## 📚 관련 문서

1. **성적기능_테스트_현황.md**: 상세 분석 및 코드 리뷰
2. **성적기능_API_테스트_스크립트.md**: 실제 API 테스트 예시
3. **06_성적_API.md**: 공식 API 문서

---

## 💡 권장 사항

### 테스트 전
1. ✅ DB 백업 (현재 상태 보존)
2. ✅ 테스트 계정 준비 (교수, 학생)
3. ✅ 로그 레벨 DEBUG 설정 (상세 로그 확인)

### 테스트 중
1. 각 단계마다 DB 확인
2. 응답 데이터와 DB 일치 여부 검증
3. 에러 발생 시 로그 확인

### 테스트 후
1. 성공/실패 케이스 문서화
2. 버그 발견 시 이슈 등록
3. 성능 이슈 확인

---

## ✅ 결론

**현재 상태**: 테스트 준비 완료  
**다음 작업**: 실제 API 테스트 실행  
**ENROLLMENT_DATA 처리**: 기존 데이터 유지 권장 (옵션 B)

모든 성적 계산 로직이 구현되어 있으며, null/empty 데이터에 대한 안전 처리도 되어 있습니다.
바로 API 테스트를 시작할 수 있습니다! 🚀
