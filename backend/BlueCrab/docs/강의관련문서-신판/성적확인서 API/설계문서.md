# 성적확인서 API 설계 문서

## 📋 개요

학생이 본인의 전체 수강 이력과 성적을 조회할 수 있는 성적확인서 API

**작성일**: 2025-10-29  
**버전**: 1.0.0

---

## 🎯 요구사항

### 1. 기능 요구사항
- ✅ 학생 본인의 전체 수강 이력 조회
- ✅ 수료/중도포기/낙제 상태 구분
- ✅ 이수학점, 성적(A~F), GPA(4.0 만점) 표시
- ✅ 학기별 통계 (학기 GPA, 취득 학점)
- ✅ 전체 통계 (누적 GPA, 총 취득 학점)

### 2. 성적 체계
- **등급**: A, B, C, D, F (5단계)
- **GPA**: 4.0 만점
  - A = 4.0
  - B = 3.0
  - C = 2.0
  - D = 1.0
  - F = 0.0 (GPA 계산 제외)

### 3. 성적 상태
- `COMPLETED` - 수료 (60% 이상, 최종 성적 확정)
- `FAILED` - 낙제 (60% 미만)
- `DROPPED` - 중도포기
- `IN_PROGRESS` - 수강 중
- `NOT_GRADED` - 성적 미입력

---

## 🏗️ 데이터 소스

### ENROLLMENT_DATA JSON 구조

```json
{
  "gradeConfig": {
    "totalMaxScore": 294,
    "attendanceMaxScore": 67,
    "assignmentTotalScore": 227,
    "latePenaltyPerSession": 0.4,
    "gradeDistribution": {
      "A": 30,
      "B": 40,
      "C": 20,
      "D": 10
    }
  },
  "grade": {
    "letterGrade": "A",          // 최종 성적 (finalized=true일 때만 유효)
    "finalized": true,            // 성적 확정 여부
    "finalizedDate": "2025-10-29 15:30:00",
    "rank": 3,                    // 석차
    "totalStudents": 25,          // 전체 학생 수
    "passingStudents": 22,        // 합격 학생 수
    "total": {
      "score": 281.76,
      "maxScore": 294.0,
      "percentage": 95.84
    },
    "attendanceScore": {
      "currentScore": 65.76,
      "maxScore": 67.0,
      "percentage": 98.15,
      "presentCount": 78,
      "lateCount": 1,
      "absentCount": 1,
      "attendanceRate": 79
    },
    "assignments": [
      {
        "name": "과제1",
        "score": 45.0,
        "maxScore": 50.0,
        "percentage": 90.0,
        "submitted": true
      }
    ]
  }
}
```

### USER_TBL
- `USER_IDX` - 학생 고유 ID
- `USER_CODE` - 학번
- `USER_NAME` - 이름
- `USER_STUDENT` - 권한 (0=학생, 1=교수, 2=관리자)

### LEC_TBL
- `LEC_IDX` - 강의 고유 ID
- `LEC_SERIAL` - 강의 코드
- `LEC_TIT` - 강의명
- `LEC_POINT` - 이수학점
- `LEC_YEAR` - 개설 년도
- `LEC_SEMESTER` - 학기 (1=1학기, 2=2학기)
- `LEC_PROF` - 교수 IDX (String)

### ENROLLMENT_EXTENDED_TBL
- `ENROLLMENT_IDX` - 수강 신청 고유 ID
- `LEC_IDX` - 강의 IDX
- `STUDENT_IDX` - 학생 IDX (USER_IDX)
- `ENROLLMENT_DATA` - JSON 성적 데이터

---

## 📡 API 엔드포인트

### 1. 성적확인서 조회

**엔드포인트**: `POST /api/transcript/view`

**권한**: 학생 본인 (JWT 토큰)

**요청**:
```json
{
  "action": "view-transcript"
}
```

**응답**:
```json
{
  "success": true,
  "message": "성적확인서 조회 성공",
  "data": {
    "student": {
      "studentIdx": 33,
      "studentCode": "202500106114",
      "name": "김민준",
      "admissionYear": 2025,
      "currentGrade": 1
    },
    "courses": [
      {
        "lecIdx": 48,
        "lecSerial": "ETH201",
        "lecTitle": "현대윤리학",
        "credits": 3,
        "professorName": "문어",
        "year": 2025,
        "semester": 1,
        "totalScore": 281.76,
        "maxScore": 294.0,
        "percentage": 95.84,
        "letterGrade": "A",
        "gpa": 4.0,
        "rank": 3,
        "totalStudents": 25,
        "status": "COMPLETED"
      }
    ],
    "semesterSummaries": {
      "2025-1": {
        "year": 2025,
        "semester": 1,
        "courseCount": 2,
        "earnedCredits": 3,
        "attemptedCredits": 6,
        "semesterGpa": 2.0,
        "averagePercentage": 57.65
      }
    },
    "overallSummary": {
      "totalCourses": 2,
      "totalEarnedCredits": 3,
      "totalAttemptedCredits": 6,
      "cumulativeGpa": 2.0,
      "averagePercentage": 57.65,
      "completionRate": 50.0
    },
    "issuedAt": "2025-10-29T15:30:00",
    "certificateNumber": "TR-202500106114-20251029153000"
  }
}
```

---

## 🔄 처리 로직

### 1. 성적 상태 판정

```java
private String determineStatus(Map<String, Object> gradeData, double percentage) {
    // 1. finalized 확인
    Boolean finalized = gradeData.get("finalized");
    
    if (finalized != null && finalized) {
        // 최종 성적 확정됨
        String letterGrade = gradeData.get("letterGrade");
        return letterGrade.equals("F") ? "FAILED" : "COMPLETED";
    }
    
    // 2. 성적 미확정
    if (percentage >= 60.0) {
        return "IN_PROGRESS";
    } else {
        return "NOT_GRADED";  // 또는 "IN_PROGRESS"
    }
}
```

### 2. GPA 계산

```java
private double convertToGpa(String letterGrade) {
    switch (letterGrade) {
        case "A": return 4.0;
        case "B": return 3.0;
        case "C": return 2.0;
        case "D": return 1.0;
        case "F": return 0.0;
        default: return 0.0;
    }
}

private double calculateWeightedGpa(List<Course> courses) {
    double totalWeighted = 0.0;
    int totalCredits = 0;
    
    for (Course course : courses) {
        if ("COMPLETED".equals(course.getStatus())) {
            totalWeighted += convertToGpa(course.getLetterGrade()) * course.getCredits();
            totalCredits += course.getCredits();
        }
    }
    
    return totalCredits > 0 ? Math.round((totalWeighted / totalCredits) * 100.0) / 100.0 : 0.0;
}
```

### 3. 학기별 통계

```java
private Map<String, SemesterSummary> calculateSemesterSummaries(List<Course> courses) {
    Map<String, List<Course>> grouped = courses.stream()
        .filter(c -> c.getYear() != null && c.getSemester() != null)
        .collect(Collectors.groupingBy(c -> c.getYear() + "-" + c.getSemester()));
    
    Map<String, SemesterSummary> summaries = new LinkedHashMap<>();
    
    for (Map.Entry<String, List<Course>> entry : grouped.entrySet()) {
        String semesterKey = entry.getKey();
        List<Course> semesterCourses = entry.getValue();
        
        int earnedCredits = semesterCourses.stream()
            .filter(c -> "COMPLETED".equals(c.getStatus()))
            .mapToInt(Course::getCredits)
            .sum();
        
        int attemptedCredits = semesterCourses.stream()
            .mapToInt(Course::getCredits)
            .sum();
        
        double semesterGpa = calculateWeightedGpa(semesterCourses);
        
        summaries.put(semesterKey, SemesterSummary.builder()
            .semesterKey(semesterKey)
            .courseCount(semesterCourses.size())
            .earnedCredits(earnedCredits)
            .attemptedCredits(attemptedCredits)
            .semesterGpa(semesterGpa)
            .build());
    }
    
    return summaries;
}
```

---

## 🔒 보안

### JWT 인증
- 모든 엔드포인트는 JWT 토큰 검증 필수
- 토큰에서 USER_IDX 추출하여 본인 확인
- 학생은 본인 성적만 조회 가능

### 권한 체크
```java
Integer studentIdxFromToken = jwtUtil.getUserIdxFromToken(token);

// 학생 본인만 조회 가능
if (!studentIdxFromToken.equals(requestStudentIdx)) {
    throw new ForbiddenException("본인의 성적만 조회할 수 있습니다.");
}
```

---

## ⚠️ 주의사항

1. **F 등급 GPA 제외**: F 등급은 GPA 계산에서 제외
2. **성적 미확정 처리**: `finalized=false`인 경우 임시 상태 표시
3. **Null 안전**: 모든 JSON 필드는 null 체크 필수
4. **학기 정렬**: 년도 → 학기 순으로 정렬
5. **백분율 소수점**: 소수점 둘째 자리까지 표시

---

## � 응답 형식 예시

### 성공 응답 (200 OK)

```json
{
  "status": "success",
  "message": "성적확인서 조회 성공",
  "data": {
    "student": {
      "studentIdx": 2,
      "studentCode": "202500106114",
      "name": "박대현",
      "admissionYear": 2025,
      "currentGrade": 1
    },
    "courses": [
      {
        "lecIdx": 101,
        "lecSerial": "CS101",
        "lecTitle": "자료구조",
        "credits": 3,
        "professorName": "김교수",
        "year": 2025,
        "semester": 1,
        "totalScore": 281.76,
        "maxScore": 294.0,
        "percentage": 95.84,
        "letterGrade": "A",
        "gpa": 4.0,
        "rank": 3,
        "totalStudents": 25,
        "status": "COMPLETED",
        "attendanceScore": 65.2,
        "attendanceMaxScore": 67.0,
        "attendanceRate": 97,
        "assignmentScore": 216.56,
        "assignmentMaxScore": 227.0
      },
      {
        "lecIdx": 102,
        "lecSerial": "MATH201",
        "lecTitle": "선형대수학",
        "credits": 3,
        "professorName": "이교수",
        "year": 2025,
        "semester": 1,
        "totalScore": 165.4,
        "maxScore": 294.0,
        "percentage": 56.26,
        "letterGrade": "F",
        "gpa": 0.0,
        "rank": 23,
        "totalStudents": 25,
        "status": "FAILED",
        "attendanceScore": 45.8,
        "attendanceMaxScore": 67.0,
        "attendanceRate": 68,
        "assignmentScore": 119.6,
        "assignmentMaxScore": 227.0
      },
      {
        "lecIdx": 103,
        "lecSerial": "ENG101",
        "lecTitle": "영어회화",
        "credits": 2,
        "professorName": "최교수",
        "year": 2025,
        "semester": 1,
        "totalScore": 198.5,
        "maxScore": 294.0,
        "percentage": 67.52,
        "letterGrade": "진행중",
        "gpa": 0.0,
        "rank": null,
        "totalStudents": null,
        "status": "IN_PROGRESS",
        "attendanceScore": 52.3,
        "attendanceMaxScore": 67.0,
        "attendanceRate": 78,
        "assignmentScore": 146.2,
        "assignmentMaxScore": 227.0
      }
    ],
    "semesterSummaries": {
      "2025-1": {
        "semesterKey": "2025-1",
        "year": 2025,
        "semester": 1,
        "courseCount": 3,
        "earnedCredits": 3,
        "attemptedCredits": 8,
        "semesterGpa": 4.0,
        "averagePercentage": 73.21,
        "gradeACount": 1,
        "gradeBCount": 0,
        "gradeCCount": 0,
        "gradeDCount": 0,
        "gradeFCount": 1
      }
    },
    "overallSummary": {
      "totalCourses": 3,
      "totalEarnedCredits": 3,
      "totalAttemptedCredits": 8,
      "cumulativeGpa": 4.0,
      "averagePercentage": 73.21,
      "completionRate": 37.5,
      "totalGradeACount": 1,
      "totalGradeBCount": 0,
      "totalGradeCCount": 0,
      "totalGradeDCount": 0,
      "totalGradeFCount": 1
    },
    "issuedAt": "2025-10-29T14:35:22",
    "certificateNumber": "TR-202500106114-20251029143522"
  }
}
```

### 실패 응답

#### 401 Unauthorized - 인증 실패
```json
{
  "status": "error",
  "message": "인증이 필요합니다"
}
```

#### 403 Forbidden - 권한 없음
```json
{
  "status": "error",
  "message": "본인의 성적만 조회할 수 있습니다"
}
```

#### 404 Not Found - 학생 없음
```json
{
  "status": "error",
  "message": "학생을 찾을 수 없습니다: 99999"
}
```

#### 500 Internal Server Error - 서버 오류
```json
{
  "status": "error",
  "message": "서버 오류가 발생했습니다"
}
```

---

## 📊 필드 설명

### StudentInfo
| 필드 | 타입 | 설명 | 예시 |
|------|------|------|------|
| studentIdx | Integer | 학생 IDX | 2 |
| studentCode | String | 학번 | "202500106114" |
| name | String | 이름 | "박대현" |
| admissionYear | Integer | 입학년도 | 2025 |
| currentGrade | Integer | 현재 학년 (1~4) | 1 |

### CourseDto
| 필드 | 타입 | 설명 | 예시 |
|------|------|------|------|
| lecIdx | Integer | 강의 IDX | 101 |
| lecSerial | String | 강의 코드 | "CS101" |
| lecTitle | String | 강의명 | "자료구조" |
| credits | Integer | 학점 | 3 |
| professorName | String | 교수명 | "김교수" |
| year | Integer | 년도 | 2025 |
| semester | Integer | 학기 | 1 |
| totalScore | Double | 총점 | 281.76 |
| maxScore | Double | 만점 | 294.0 |
| percentage | Double | 백분율 | 95.84 |
| letterGrade | String | 학점 등급 (A/B/C/D/F) | "A" |
| gpa | Double | GPA (4.0 만점) | 4.0 |
| rank | Integer | 등수 (확정 시에만) | 3 |
| totalStudents | Integer | 전체 학생 수 (확정 시에만) | 25 |
| status | String | 상태 | "COMPLETED" |
| attendanceScore | Double | 출석 점수 | 65.2 |
| attendanceMaxScore | Double | 출석 만점 | 67.0 |
| attendanceRate | Integer | 출석률 (%) | 97 |
| assignmentScore | Double | 과제 점수 | 216.56 |
| assignmentMaxScore | Double | 과제 만점 | 227.0 |

### SemesterSummary
| 필드 | 타입 | 설명 | 예시 |
|------|------|------|------|
| semesterKey | String | 학기 키 | "2025-1" |
| year | Integer | 년도 | 2025 |
| semester | Integer | 학기 | 1 |
| courseCount | Integer | 과목 수 | 3 |
| earnedCredits | Integer | 취득 학점 | 3 |
| attemptedCredits | Integer | 신청 학점 | 8 |
| semesterGpa | Double | 학기 GPA | 4.0 |
| averagePercentage | Double | 평균 백분율 | 73.21 |
| gradeACount | Integer | A 학점 수 | 1 |
| gradeBCount | Integer | B 학점 수 | 0 |
| gradeCCount | Integer | C 학점 수 | 0 |
| gradeDCount | Integer | D 학점 수 | 0 |
| gradeFCount | Integer | F 학점 수 | 1 |

### OverallSummary
| 필드 | 타입 | 설명 | 예시 |
|------|------|------|------|
| totalCourses | Integer | 총 과목 수 | 3 |
| totalEarnedCredits | Integer | 총 취득 학점 | 3 |
| totalAttemptedCredits | Integer | 총 신청 학점 | 8 |
| cumulativeGpa | Double | 누적 GPA | 4.0 |
| averagePercentage | Double | 평균 백분율 | 73.21 |
| completionRate | Double | 학점 취득률 (%) | 37.5 |
| totalGradeACount | Integer | 총 A 학점 수 | 1 |
| totalGradeBCount | Integer | 총 B 학점 수 | 0 |
| totalGradeCCount | Integer | 총 C 학점 수 | 0 |
| totalGradeDCount | Integer | 총 D 학점 수 | 0 |
| totalGradeFCount | Integer | 총 F 학점 수 | 1 |

### 상태 코드 (status)
| 코드 | 설명 | 조건 |
|------|------|------|
| COMPLETED | 수료 | finalized=true, letterGrade≠F |
| FAILED | 낙제 | finalized=true, letterGrade=F |
| IN_PROGRESS | 진행중 | finalized=false, percentage≥60% |
| NOT_GRADED | 미확정 | finalized=false, percentage<60% |
| DROPPED | 중도포기 | 별도 플래그 필요 (미구현) |

---

## �📝 프론트엔드 가이드

### 📍 체크포인트

1. **인증 처리**
   - JWT 토큰을 `Authorization: Bearer {token}` 헤더에 포함
   - 401 응답 시 로그인 페이지로 리다이렉트
   - 403 응답 시 권한 없음 메시지 표시

2. **데이터 바인딩**
   - `data.student`: 학생 기본 정보
   - `data.courses`: 전체 수강 내역 (배열)
   - `data.semesterSummaries`: 학기별 요약 (맵, 키는 "YYYY-S")
   - `data.overallSummary`: 전체 통계

3. **상태 표시**
   - `COMPLETED`: 초록색, ✅ 아이콘
   - `FAILED`: 빨간색, ❌ 아이콘
   - `IN_PROGRESS`: 파란색, ⏳ 아이콘
   - `NOT_GRADED`: 회색, ⏸️ 아이콘
   - `DROPPED`: 주황색, 🚫 아이콘

4. **GPA 표시**
   - 소수점 둘째 자리까지 표시: `gpa.toFixed(2)`
   - F 등급은 GPA 0.0으로 표시하되, 누적 GPA 계산에서는 제외됨
   - 예: "4.00 / 4.0", "3.50 / 4.0"

5. **학기 정렬**
   - `semesterSummaries`의 키를 년도-학기 순으로 정렬
   - 예: "2024-1", "2024-2", "2025-1", "2025-2"

6. **Null 처리**
   - `rank`, `totalStudents`: 성적 미확정 시 null → "-" 또는 "N/A" 표시
   - `letterGrade`: "진행중", "미확정" 등 임시 값 가능

7. **발급 정보**
   - `issuedAt`: ISO 8601 형식 → 한국어 날짜 포맷으로 변환
   - `certificateNumber`: 고유 발급 번호 (출력용)

### 📱 UI 구성 제안

```
┌─────────────────────────────────────────┐
│         성 적 확 인 서                  │
├─────────────────────────────────────────┤
│ 학생 정보                               │
│ - 학번: 202500106114                    │
│ - 이름: 박대현                          │
│ - 입학년도: 2025                        │
│ - 현재학년: 1학년                       │
├─────────────────────────────────────────┤
│ 전체 요약                               │
│ - 총 수강 과목: 3개                     │
│ - 취득/신청 학점: 3 / 8                 │
│ - 누적 평점: 4.00 / 4.0                 │
│ - 학점 취득률: 37.5%                    │
├─────────────────────────────────────────┤
│ 학기별 요약                             │
│ [2025-1학기] 3과목, 학기GPA 4.00        │
├─────────────────────────────────────────┤
│ 수강 내역                               │
│ ┌───────────────────────────────────┐  │
│ │ 자료구조 (CS101) | 3학점 | A | ✅ │  │
│ │ 선형대수학 (MATH201) | 3학점 | F | ❌│  │
│ │ 영어회화 (ENG101) | 2학점 | 진행중 │  │
│ └───────────────────────────────────┘  │
├─────────────────────────────────────────┤
│ 발급일시: 2025-10-29 14:35:22           │
│ 발급번호: TR-202500106114-20251029143522│
└─────────────────────────────────────────┘
```

---

## 📝 TODO

- [x] TranscriptController.java 생성
- [x] TranscriptService.java 생성
- [x] CourseDto.java 생성
- [x] TranscriptResponseDto.java 생성
- [ ] 단위 테스트 작성
- [ ] 프론트엔드 구현
- [x] API 문서 작성 (이 문서)
