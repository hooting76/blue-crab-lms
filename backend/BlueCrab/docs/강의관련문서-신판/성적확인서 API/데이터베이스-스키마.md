# 데이터베이스 스키마

성적확인서 API에서 사용하는 데이터베이스 구조 및 JSON 형식

---

## 📊 테이블 구조

### USER_TBL (사용자)

| 컬럼 | 타입 | 설명 |
|------|------|------|
| USER_IDX | Integer | 학생 고유 ID (PK) |
| USER_CODE | String | 학번 |
| USER_NAME | String | 이름 |
| USER_EMAIL | String | 이메일 |
| USER_STUDENT | Integer | 권한 (0=학생, 1=교수, 2=관리자) |

### LEC_TBL (강의)

| 컬럼 | 타입 | 설명 |
|------|------|------|
| LEC_IDX | Integer | 강의 고유 ID (PK) |
| LEC_SERIAL | String | 강의 코드 |
| LEC_TIT | String | 강의명 |
| LEC_POINT | Integer | 이수학점 |
| LEC_YEAR | Integer | 개설 년도 |
| LEC_SEMESTER | Integer | 학기 (1=1학기, 2=2학기) |
| LEC_PROF | String | 교수 IDX |

### ENROLLMENT_EXTENDED_TBL (수강 신청)

| 컬럼 | 타입 | 설명 |
|------|------|------|
| ENROLLMENT_IDX | Integer | 수강 신청 고유 ID (PK) |
| LEC_IDX | Integer | 강의 IDX (FK) |
| STUDENT_IDX | Integer | 학생 IDX (FK) |
| ENROLLMENT_DATA | TEXT | JSON 성적 데이터 |

---

## 📄 ENROLLMENT_DATA JSON 구조

### 전체 구조

```json
{
  "gradeConfig": {
    "totalMaxScore": 294,
    "attendanceMaxScore": 67,
    "assignmentTotalScore": 227,
    "latePenaltyPerSession": 0.4,
    "gradeDistribution": {
      "A": 30,
      "B": 40,
      "C": 20,
      "D": 10
    }
  },
  "grade": {
    "letterGrade": "A",
    "finalized": true,
    "finalizedDate": "2025-10-29 15:30:00",
    "rank": 3,
    "totalStudents": 25,
    "passingStudents": 22,
    "total": {
      "score": 281.76,
      "maxScore": 294.0,
      "percentage": 95.84
    },
    "attendanceScore": {
      "currentScore": 65.76,
      "maxScore": 67.0,
      "percentage": 98.15,
      "presentCount": 78,
      "lateCount": 1,
      "absentCount": 1,
      "attendanceRate": 79
    },
    "assignments": [
      {
        "name": "과제1",
        "score": 45.0,
        "maxScore": 50.0,
        "percentage": 90.0,
        "submitted": true,
        "submittedDate": "2025-10-15 14:30:00"
      },
      {
        "name": "과제2",
        "score": 48.0,
        "maxScore": 50.0,
        "percentage": 96.0,
        "submitted": true,
        "submittedDate": "2025-10-22 10:15:00"
      }
    ]
  }
}
```

---

## 🔑 주요 필드 설명

### gradeConfig (성적 설정)

| 필드 | 타입 | 설명 |
|------|------|------|
| totalMaxScore | Double | 총점 만점 |
| attendanceMaxScore | Double | 출석 만점 |
| assignmentTotalScore | Double | 과제 총점 |
| latePenaltyPerSession | Double | 지각 감점 |
| gradeDistribution | Object | 성적 분포 (A: 30%, B: 40%, C: 20%, D: 10%) |

### grade (성적 정보)

| 필드 | 타입 | 설명 |
|------|------|------|
| letterGrade | String | 최종 학점 (A/B/C/D/F) |
| finalized | Boolean | 성적 확정 여부 ⭐ |
| finalizedDate | String | 성적 확정 일시 |
| rank | Integer | 석차 |
| totalStudents | Integer | 전체 학생 수 |
| passingStudents | Integer | 합격 학생 수 (60% 이상) |

### grade.total (총점 정보)

| 필드 | 타입 | 설명 |
|------|------|------|
| score | Double | 획득 점수 |
| maxScore | Double | 만점 |
| percentage | Double | 백분율 |

### grade.attendanceScore (출석 정보)

| 필드 | 타입 | 설명 |
|------|------|------|
| currentScore | Double | 출석 점수 |
| maxScore | Double | 출석 만점 |
| percentage | Double | 출석 백분율 |
| presentCount | Integer | 출석 횟수 |
| lateCount | Integer | 지각 횟수 |
| absentCount | Integer | 결석 횟수 |
| attendanceRate | Integer | 출석률 (%) |

### grade.assignments[] (과제 목록)

| 필드 | 타입 | 설명 |
|------|------|------|
| name | String | 과제명 |
| score | Double | 획득 점수 |
| maxScore | Double | 만점 |
| percentage | Double | 백분율 |
| submitted | Boolean | 제출 여부 |
| submittedDate | String | 제출 일시 |

---

## ⚠️ 중요 사항

### finalized 플래그

**성적 확정 여부를 판단하는 가장 중요한 필드**

- `true`: 성적이 최종 확정됨
  - `letterGrade`, `rank`, `totalStudents` 값 신뢰 가능
  - 상태: COMPLETED (A~D) 또는 FAILED (F)

- `false`: 성적 미확정 (진행중)
  - `letterGrade` 값 무시
  - `percentage`로 임시 상태 판단
  - 상태: IN_PROGRESS 또는 NOT_GRADED

### 성적 계산 순서

1. **ENROLLMENT_DATA.grade.finalized** 확인
2. **finalized = true** → `letterGrade` 사용
3. **finalized = false** → `percentage`로 임시 판단
4. **letterGrade → GPA 변환** (A=4.0, B=3.0, C=2.0, D=1.0, F=0.0)

### Null 처리

JSON 파싱 시 다음 필드들은 null일 수 있음:

- `letterGrade` (finalized=false일 때)
- `rank` (finalized=false일 때)
- `totalStudents` (finalized=false일 때)
- `finalizedDate` (finalized=false일 때)
- `assignments[]` (과제 없는 경우 빈 배열)

---

## 📝 데이터 조회 예시

### SQL 쿼리

```sql
-- 학생의 전체 수강 이력 조회
SELECT 
    e.ENROLLMENT_IDX,
    e.STUDENT_IDX,
    e.LEC_IDX,
    e.ENROLLMENT_DATA,
    l.LEC_SERIAL,
    l.LEC_TIT,
    l.LEC_POINT,
    l.LEC_YEAR,
    l.LEC_SEMESTER,
    l.LEC_PROF,
    u.USER_CODE,
    u.USER_NAME
FROM 
    ENROLLMENT_EXTENDED_TBL e
    JOIN LEC_TBL l ON e.LEC_IDX = l.LEC_IDX
    JOIN USER_TBL u ON e.STUDENT_IDX = u.USER_IDX
WHERE 
    e.STUDENT_IDX = ?
ORDER BY 
    l.LEC_YEAR ASC, 
    l.LEC_SEMESTER ASC;
```

### JSON 파싱 (Java)

```java
ObjectMapper mapper = new ObjectMapper();
JsonNode root = mapper.readTree(enrollmentData);

// finalized 확인
boolean finalized = root.path("grade").path("finalized").asBoolean(false);

// 성적 정보 추출
if (finalized) {
    String letterGrade = root.path("grade").path("letterGrade").asText();
    int rank = root.path("grade").path("rank").asInt();
    int totalStudents = root.path("grade").path("totalStudents").asInt();
}

// 총점 정보
double totalScore = root.path("grade").path("total").path("score").asDouble();
double percentage = root.path("grade").path("total").path("percentage").asDouble();

// 출석 정보
double attendanceScore = root.path("grade").path("attendanceScore").path("currentScore").asDouble();
int attendanceRate = root.path("grade").path("attendanceScore").path("attendanceRate").asInt();

// 과제 집계
double assignmentScore = 0.0;
JsonNode assignments = root.path("grade").path("assignments");
for (JsonNode assignment : assignments) {
    assignmentScore += assignment.path("score").asDouble();
}
```
