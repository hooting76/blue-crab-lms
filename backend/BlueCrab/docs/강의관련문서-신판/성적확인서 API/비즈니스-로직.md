# 비즈니스 로직

성적확인서 API의 성적 계산 및 통계 로직

---

## 🎯 성적 상태 판정

### 상태 결정 로직

```java
private String determineStatus(JsonNode gradeNode, double percentage) {
    // 1. finalized 플래그 확인
    boolean finalized = gradeNode.path("finalized").asBoolean(false);
    
    if (finalized) {
        // 성적 확정됨
        String letterGrade = gradeNode.path("letterGrade").asText("N/A");
        return letterGrade.equals("F") ? "FAILED" : "COMPLETED";
    }
    
    // 2. 성적 미확정 - percentage로 임시 판단
    if (percentage >= 60.0) {
        return "IN_PROGRESS";    // 60% 이상 - 진행중
    } else {
        return "NOT_GRADED";     // 60% 미만 - 미확정
    }
}
```

### 상태별 조건

| 상태 | 조건 | letterGrade | 설명 |
|------|------|-------------|------|
| COMPLETED | finalized=true, grade≠F | A/B/C/D | 수료 (학점 취득) |
| FAILED | finalized=true, grade=F | F | 낙제 (재수강 필요) |
| IN_PROGRESS | finalized=false, ≥60% | "진행중" | 수강 중 (합격 가능) |
| NOT_GRADED | finalized=false, <60% | "미확정" | 수강 중 (불합격 가능) |
| DROPPED | 별도 플래그 | - | 중도포기 (미구현) |

---

## 📊 GPA 계산

### 학점 → GPA 변환

```java
private double convertToGpa(String letterGrade) {
    if (letterGrade == null) return 0.0;
    
    switch (letterGrade) {
        case "A": return 4.0;
        case "B": return 3.0;
        case "C": return 2.0;
        case "D": return 1.0;
        case "F": return 0.0;
        default: return 0.0;  // "진행중", "미확정" 등
    }
}
```

### 가중 평균 GPA (학점 반영)

```java
private double calculateWeightedGpa(List<CourseDto> courses) {
    double totalWeighted = 0.0;
    int totalCredits = 0;
    
    for (CourseDto course : courses) {
        // COMPLETED 상태만 GPA 계산에 포함
        if ("COMPLETED".equals(course.getStatus())) {
            int credits = course.getCredits() != null ? course.getCredits() : 0;
            double gpa = course.getGpa() != null ? course.getGpa() : 0.0;
            
            totalWeighted += gpa * credits;
            totalCredits += credits;
        }
    }
    
    if (totalCredits == 0) return 0.0;
    
    // 소수점 둘째 자리까지 반올림
    return Math.round((totalWeighted / totalCredits) * 100.0) / 100.0;
}
```

### 계산 예시

**과목 목록**:
- 자료구조 (3학점, A, GPA 4.0) - COMPLETED
- 선형대수학 (3학점, F, GPA 0.0) - FAILED
- 영어회화 (2학점, 진행중, GPA 0.0) - IN_PROGRESS

**GPA 계산**:
```
totalWeighted = (3 × 4.0) = 12.0
totalCredits = 3
cumulativeGpa = 12.0 / 3 = 4.00
```

**⚠️ 주의**: F 등급(FAILED)과 진행중(IN_PROGRESS)은 GPA 계산에서 제외됨

---

## 📅 학기별 통계 계산

### 학기 그룹핑

```java
private Map<String, SemesterSummary> calculateSemesterSummaries(List<CourseDto> courses) {
    // 1. 학기별로 그룹화 (key: "YYYY-S")
    Map<String, List<CourseDto>> grouped = courses.stream()
        .filter(c -> c.getYear() != null && c.getSemester() != null)
        .collect(Collectors.groupingBy(c -> c.getYear() + "-" + c.getSemester()));
    
    Map<String, SemesterSummary> summaries = new LinkedHashMap<>();
    
    // 2. 각 학기별 통계 계산
    for (Map.Entry<String, List<CourseDto>> entry : grouped.entrySet()) {
        String semesterKey = entry.getKey();
        List<CourseDto> semesterCourses = entry.getValue();
        
        // 취득 학점 (COMPLETED만)
        int earnedCredits = semesterCourses.stream()
            .filter(c -> "COMPLETED".equals(c.getStatus()))
            .mapToInt(c -> c.getCredits() != null ? c.getCredits() : 0)
            .sum();
        
        // 신청 학점 (전체)
        int attemptedCredits = semesterCourses.stream()
            .mapToInt(c -> c.getCredits() != null ? c.getCredits() : 0)
            .sum();
        
        // 학기 GPA
        double semesterGpa = calculateWeightedGpa(semesterCourses);
        
        // 평균 백분율
        double averagePercentage = semesterCourses.stream()
            .mapToDouble(c -> c.getPercentage() != null ? c.getPercentage() : 0.0)
            .average()
            .orElse(0.0);
        
        // 학점 분포
        int gradeACount = countByGrade(semesterCourses, "A");
        int gradeBCount = countByGrade(semesterCourses, "B");
        int gradeCCount = countByGrade(semesterCourses, "C");
        int gradeDCount = countByGrade(semesterCourses, "D");
        int gradeFCount = countByGrade(semesterCourses, "F");
        
        summaries.put(semesterKey, SemesterSummary.builder()
            .semesterKey(semesterKey)
            .year(Integer.parseInt(semesterKey.split("-")[0]))
            .semester(Integer.parseInt(semesterKey.split("-")[1]))
            .courseCount(semesterCourses.size())
            .earnedCredits(earnedCredits)
            .attemptedCredits(attemptedCredits)
            .semesterGpa(round(semesterGpa))
            .averagePercentage(round(averagePercentage))
            .gradeACount(gradeACount)
            .gradeBCount(gradeBCount)
            .gradeCCount(gradeCCount)
            .gradeDCount(gradeDCount)
            .gradeFCount(gradeFCount)
            .build());
    }
    
    return summaries;
}
```

### 학기별 통계 예시

**2025-1학기**:
- 과목: 자료구조(A), 선형대수학(F), 영어회화(진행중)
- 취득/신청 학점: 3 / 8 (영어회화 2학점 미취득)
- 학기 GPA: 4.00 (자료구조만 계산)
- 평균 백분율: 73.21% (3과목 평균)
- 학점 분포: A(1), B(0), C(0), D(0), F(1)

---

## 🎓 전체 통계 계산

### OverallSummary 생성

```java
private OverallSummary calculateOverallSummary(List<CourseDto> courses) {
    // 총 취득 학점 (COMPLETED만)
    int totalEarnedCredits = courses.stream()
        .filter(c -> "COMPLETED".equals(c.getStatus()))
        .mapToInt(c -> c.getCredits() != null ? c.getCredits() : 0)
        .sum();
    
    // 총 신청 학점
    int totalAttemptedCredits = courses.stream()
        .mapToInt(c -> c.getCredits() != null ? c.getCredits() : 0)
        .sum();
    
    // 누적 GPA
    double cumulativeGpa = calculateWeightedGpa(courses);
    
    // 평균 백분율
    double averagePercentage = courses.stream()
        .mapToDouble(c -> c.getPercentage() != null ? c.getPercentage() : 0.0)
        .average()
        .orElse(0.0);
    
    // 학점 취득률
    double completionRate = totalAttemptedCredits > 0 
        ? (double) totalEarnedCredits / totalAttemptedCredits * 100.0 
        : 0.0;
    
    return OverallSummary.builder()
        .totalCourses(courses.size())
        .totalEarnedCredits(totalEarnedCredits)
        .totalAttemptedCredits(totalAttemptedCredits)
        .cumulativeGpa(round(cumulativeGpa))
        .averagePercentage(round(averagePercentage))
        .completionRate(round(completionRate))
        .totalGradeACount(countByGrade(courses, "A"))
        .totalGradeBCount(countByGrade(courses, "B"))
        .totalGradeCCount(countByGrade(courses, "C"))
        .totalGradeDCount(countByGrade(courses, "D"))
        .totalGradeFCount(countByGrade(courses, "F"))
        .build();
}
```

### 전체 통계 예시

- **총 과목**: 3개
- **취득/신청 학점**: 3 / 8 (37.5%)
- **누적 GPA**: 4.00 (자료구조만)
- **평균 백분율**: 73.21%
- **학점 취득률**: 37.5%
- **학점 분포**: A(1), B(0), C(0), D(0), F(1)

---

## 🔢 유틸리티 함수

### 특정 등급 카운트

```java
private int countByGrade(List<CourseDto> courses, String grade) {
    return (int) courses.stream()
        .filter(c -> grade.equals(c.getLetterGrade()))
        .count();
}
```

### 소수점 반올림

```java
private double round(double value) {
    return Math.round(value * 100.0) / 100.0;
}
```

### 학생 정보 생성

```java
private StudentInfo createStudentInfo(UserTbl student) {
    // 학번에서 입학년도 추출 (예: 202500106114 → 2025)
    Integer admissionYear = null;
    if (student.getUserCode() != null && student.getUserCode().length() >= 4) {
        try {
            admissionYear = Integer.parseInt(student.getUserCode().substring(0, 4));
        } catch (NumberFormatException e) {
            log.warn("입학년도 파싱 실패: {}", student.getUserCode());
        }
    }
    
    // 현재 학년 계산
    Integer currentGrade = null;
    if (admissionYear != null) {
        int currentYear = LocalDateTime.now().getYear();
        currentGrade = currentYear - admissionYear + 1;
        currentGrade = Math.max(1, Math.min(4, currentGrade)); // 1~4학년 제한
    }
    
    return StudentInfo.builder()
        .studentIdx(student.getUserIdx())
        .studentCode(student.getUserCode())
        .name(student.getUserName())
        .admissionYear(admissionYear)
        .currentGrade(currentGrade)
        .build();
}
```

### 발급번호 생성

```java
private String generateCertificateNumber(UserTbl student) {
    String studentCode = student.getUserCode() != null 
        ? student.getUserCode() 
        : String.valueOf(student.getUserIdx());
    
    String timestamp = LocalDateTime.now()
        .format(DateTimeFormatter.ofPattern("yyyyMMddHHmmss"));
    
    return String.format("TR-%s-%s", studentCode, timestamp);
}
```

---

## ⚠️ 주의사항

### 1. F 등급 처리

- **GPA 계산 제외**: F 등급은 `FAILED` 상태이므로 GPA 계산에서 제외
- **학점 미취득**: 취득 학점(earnedCredits)에 포함 안 됨
- **신청 학점 포함**: 신청 학점(attemptedCredits)에는 포함

### 2. 진행중 과목 처리

- **GPA 계산 제외**: `IN_PROGRESS`와 `NOT_GRADED`는 GPA 계산 제외
- **학점 미취득**: 아직 성적 미확정이므로 취득 학점 제외
- **통계 포함**: 과목 수, 평균 백분율에는 포함

### 3. Null 안전

```java
// Null 체크 예시
int credits = course.getCredits() != null ? course.getCredits() : 0;
double gpa = course.getGpa() != null ? course.getGpa() : 0.0;
String grade = course.getLetterGrade() != null ? course.getLetterGrade() : "N/A";
```

### 4. 소수점 처리

- 모든 백분율, GPA는 **소수점 둘째 자리까지 반올림**
- `Math.round(value * 100.0) / 100.0` 사용

### 5. 정렬 순서

- 과목 목록: **년도 → 학기** 순으로 정렬
- 학기별 요약: LinkedHashMap으로 순서 유지
