# 엔티티 관계도 문서

## 📋 개요

JPA 엔티티 간의 관계 및 참조 구조를 정리한 문서입니다.

**패키지**: `BlueCrab.com.example.entity.Lecture`

---

## 🏗️ 엔티티 목록

### 1. LecTbl (강의 엔티티)

**파일**: `LecTbl.java`  
**테이블**: `LEC_TBL`

**주요 필드**:
```java
@Entity
@Table(name = "LEC_TBL")
public class LecTbl {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    @Column(name = "LEC_IDX")
    private Integer lecIdx;
    
    @Column(name = "LEC_SERIAL", unique = true)
    private String lecSerial;
    
    @Column(name = "LEC_TIT")
    private String lecTit;
    
    @Column(name = "LEC_PROF")
    private Integer lecProf;
    
    @Column(name = "LEC_POINT")
    private Integer lecPoint;
    
    @Column(name = "LEC_MANY")
    private Integer lecMany;
    
    @Column(name = "LEC_CURRENT")
    private Integer lecCurrent;
    
    @Column(name = "LEC_OPEN")
    private Integer lecOpen;
    
    @Column(name = "LEC_YEAR")
    private Integer lecYear;
    
    @Column(name = "LEC_SEMESTER")
    private Integer lecSemester;
}
```

**관계**:
- `lecProf` → `USER_TBL.USER_IDX` (교수)
- `lecMcode` → `FACULTY.faculty_code` (학부)
- `lecMcodeDep` → `DEPARTMENT.dept_code` (학과)

---

### 2. EnrollmentExtendedTbl (수강신청 엔티티)

**파일**: `EnrollmentExtendedTbl.java`  
**테이블**: `ENROLLMENT_EXTENDED_TBL`

**주요 필드**:
```java
@Entity
@Table(name = "ENROLLMENT_EXTENDED_TBL")
public class EnrollmentExtendedTbl {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    @Column(name = "ENROLLMENT_IDX")
    private Integer enrollmentIdx;
    
    @Column(name = "LEC_IDX")
    private Integer lecIdx;
    
    @Column(name = "STUDENT_IDX")
    private Integer studentIdx;
    
    @Column(name = "ENROLLMENT_DATA", columnDefinition = "TEXT")
    private String enrollmentData;
}
```

**관계**:
- `lecIdx` → `LEC_TBL.LEC_IDX` (강의)
- `studentIdx` → `USER_TBL.USER_IDX` (학생)

**JSON 데이터 구조**:
```json
{
  "attendance": "1출2출3결4지",
  "attendanceRate": "2/4",
  "midterm": 85,
  "final": 90,
  "assignment": 95,
  "totalGrade": 92.5,
  "letterGrade": "A+"
}
```

---

### 3. AssignmentExtendedTbl (과제 엔티티)

**파일**: `AssignmentExtendedTbl.java`  
**테이블**: `ASSIGNMENT_EXTENDED_TBL`

**주요 필드**:
```java
@Entity
@Table(name = "ASSIGNMENT_EXTENDED_TBL")
public class AssignmentExtendedTbl {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    @Column(name = "ASSIGN_IDX")
    private Integer assignIdx;
    
    @Column(name = "LEC_IDX")
    private Integer lecIdx;
    
    @Column(name = "ASSIGN_TITLE")
    private String assignTitle;
    
    @Column(name = "ASSIGN_CONTENT", columnDefinition = "TEXT")
    private String assignContent;
    
    @Column(name = "ASSIGN_DUE_DATE")
    private LocalDateTime assignDueDate;
    
    @Column(name = "ASSIGN_MAX_SCORE")
    private Integer assignMaxScore;
    
    @Column(name = "ASSIGN_FILES", columnDefinition = "TEXT")
    private String assignFiles;
}
```

**관계**:
- `lecIdx` → `LEC_TBL.LEC_IDX` (강의)

---

### 4. AttendanceRequestTbl (출석 요청 엔티티)

**파일**: `AttendanceRequestTbl.java`  
**테이블**: `ATTENDANCE_REQUEST_TBL`

**주요 필드**:
```java
@Entity
@Table(name = "ATTENDANCE_REQUEST_TBL")
public class AttendanceRequestTbl {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    @Column(name = "request_idx")
    private Integer requestIdx;
    
    @Column(name = "lec_idx")
    private Integer lecIdx;
    
    @Column(name = "student_idx")
    private Integer studentIdx;
    
    @Column(name = "session_number")
    private Integer sessionNumber;
    
    @Column(name = "request_reason", columnDefinition = "TEXT")
    private String requestReason;
    
    @Column(name = "status")
    private String status; // PENDING, APPROVED, REJECTED
    
    @Column(name = "rejection_reason", columnDefinition = "TEXT")
    private String rejectionReason;
    
    @Column(name = "requested_at")
    private LocalDateTime requestedAt;
    
    @Column(name = "processed_at")
    private LocalDateTime processedAt;
}
```

**관계**:
- `lecIdx` → `LEC_TBL.LEC_IDX` (강의)
- `studentIdx` → `USER_TBL.USER_IDX` (학생)

---

### 5. CourseApplyNotice (수강신청 안내문 엔티티)

**파일**: `CourseApplyNotice.java`  
**테이블**: `COURSE_APPLY_NOTICE`

**주요 필드**:
```java
@Entity
@Table(name = "COURSE_APPLY_NOTICE")
public class CourseApplyNotice {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    @Column(name = "notice_idx")
    private Integer noticeIdx;
    
    @Column(name = "message", columnDefinition = "TEXT")
    private String message;
    
    @Column(name = "updated_at")
    private LocalDateTime updatedAt;
    
    @Column(name = "updated_by")
    private String updatedBy;
    
    @Column(name = "created_at")
    private LocalDateTime createdAt;
}
```

**관계**: 없음 (독립 테이블)

---

### 6. Faculty (학부 엔티티)

**파일**: `Faculty.java`  
**테이블**: `FACULTY`

**주요 필드**:
```java
@Entity
@Table(name = "FACULTY")
public class Faculty {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    @Column(name = "faculty_id")
    private Integer facultyId;
    
    @Column(name = "faculty_code")
    private String facultyCode;
    
    @Column(name = "faculty_name")
    private String facultyName;
    
    @Column(name = "established_at")
    private String establishedAt;
    
    @Column(name = "capacity")
    private Integer capacity;
    
    @OneToMany(mappedBy = "faculty")
    private List<Department> departments;
}
```

**관계**:
- `departments` ← `DEPARTMENT.faculty_id` (1:N)

---

### 7. Department (학과 엔티티)

**파일**: `Department.java`  
**테이블**: `DEPARTMENT`

**주요 필드**:
```java
@Entity
@Table(name = "DEPARTMENT")
public class Department {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    @Column(name = "dept_id")
    private Integer deptId;
    
    @Column(name = "dept_code")
    private String deptCode;
    
    @Column(name = "dept_name")
    private String deptName;
    
    @ManyToOne
    @JoinColumn(name = "faculty_id")
    private Faculty faculty;
    
    @Column(name = "established_at")
    private String establishedAt;
    
    @Column(name = "capacity")
    private Integer capacity;
}
```

**관계**:
- `faculty` → `FACULTY.faculty_id` (N:1)

---

## 🔗 엔티티 관계도

```
┌─────────────┐
│   Faculty   │
│   (학부)     │
└──────┬──────┘
       │ 1
       │ OneToMany
       │ N
┌──────┴──────┐
│ Department  │
│   (학과)     │
└─────────────┘

┌─────────────┐
│   LecTbl    │       교수 정보는 별도 JOIN 필요
│   (강의)     │       (lecProf → USER_TBL.USER_IDX)
└──────┬──────┘
       │ 1
       │
       ├──────────────┬──────────────┐
       │ N            │ N            │ N
┌──────┴──────┐ ┌────┴─────┐ ┌─────┴──────┐
│ Enrollment  │ │Assignment│ │ Attendance │
│  Extended   │ │ Extended │ │  Request   │
│  (수강신청)  │ │  (과제)   │ │ (출석요청) │
└─────────────┘ └──────────┘ └────────────┘
       │
       │ enrollmentData (JSON)
       │ - attendance
       │ - attendanceRate
       │ - midterm/final
       │ - totalGrade
       └─────────────

┌─────────────────────┐
│ CourseApplyNotice   │   (독립 테이블)
│  (수강신청 안내문)   │
└─────────────────────┘
```

---

## 📊 JPA 어노테이션 사용 패턴

### 기본 매핑
```java
@Entity
@Table(name = "테이블명")
public class EntityName {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    @Column(name = "컬럼명")
    private Integer id;
}
```

### OneToMany 관계
```java
// Faculty.java
@OneToMany(mappedBy = "faculty")
private List<Department> departments;

// Department.java
@ManyToOne
@JoinColumn(name = "faculty_id")
private Faculty faculty;
```

### JSON 데이터 컬럼
```java
@Column(name = "ENROLLMENT_DATA", columnDefinition = "TEXT")
private String enrollmentData;
```

### LocalDateTime 매핑
```java
@Column(name = "created_at")
private LocalDateTime createdAt;
```

---

## 🔄 Repository 패턴

### 기본 Repository
```java
public interface LecTblRepository extends JpaRepository<LecTbl, Integer> {
    Optional<LecTbl> findByLecSerial(String lecSerial);
    List<LecTbl> findByLecProf(Integer lecProf);
    Page<LecTbl> findByLecYear(Integer year, Pageable pageable);
}
```

### 커스텀 쿼리
```java
@Query("SELECT l FROM LecTbl l WHERE l.lecTit LIKE %:title%")
List<LecTbl> searchByTitle(@Param("title") String title);
```

---

## 💡 데이터 처리 패턴

### JSON 데이터 파싱 (enrollmentData)
```java
ObjectMapper mapper = new ObjectMapper();

// 읽기
JsonNode data = mapper.readTree(enrollment.getEnrollmentData());
String attendance = data.get("attendance").asText();
int midterm = data.get("midterm").asInt();

// 쓰기
ObjectNode newData = mapper.createObjectNode();
newData.put("attendance", "1출2출3결");
newData.put("midterm", 85);
enrollment.setEnrollmentData(mapper.writeValueAsString(newData));
```

### 출석 문자열 파싱
```java
String attendanceStr = "1출2출3결4지5출";
Pattern pattern = Pattern.compile("(\\d+)([출결지조])");
Matcher matcher = pattern.matcher(attendanceStr);

Map<Integer, String> attendanceMap = new HashMap<>();
while (matcher.find()) {
    int session = Integer.parseInt(matcher.group(1));
    String status = matcher.group(2);
    attendanceMap.put(session, status);
}
```

---

## ⚠️ 주의사항

### 1. N+1 문제 방지
```java
// Bad: N+1 발생
List<LecTbl> lectures = lecRepository.findAll();
for (LecTbl lec : lectures) {
    String profName = userRepository.findById(lec.getLecProf()).getName(); // N번 쿼리
}

// Good: JOIN FETCH 사용
@Query("SELECT l FROM LecTbl l JOIN FETCH l.professor")
List<LecTbl> findAllWithProfessor();
```

### 2. JSON 필드 동시성
```java
// enrollmentData 업데이트 시 트랜잭션 필수
@Transactional
public void updateAttendance(Integer enrollmentIdx, String newAttendance) {
    EnrollmentExtendedTbl enrollment = repository.findById(enrollmentIdx).orElseThrow();
    
    // JSON 데이터 읽기
    JsonNode data = mapper.readTree(enrollment.getEnrollmentData());
    
    // 수정
    ((ObjectNode) data).put("attendance", newAttendance);
    
    // 저장
    enrollment.setEnrollmentData(mapper.writeValueAsString(data));
    repository.save(enrollment);
}
```

### 3. 양방향 관계 주의
```java
// Faculty ↔ Department 양방향 관계 시
faculty.getDepartments().add(department);
department.setFaculty(faculty);  // 양쪽 모두 설정 필요
```

---

## 📈 성능 최적화 팁

1. **인덱스 활용**: `lecSerial`, `lecProf`, `status` 등에 인덱스 생성
2. **페이징 사용**: 대량 조회 시 `Pageable` 사용
3. **Projection 활용**: 필요한 컬럼만 조회
4. **캐싱**: 자주 조회되는 데이터 (Faculty, Department) 캐싱

---

© 2025 BlueCrab LMS Development Team
