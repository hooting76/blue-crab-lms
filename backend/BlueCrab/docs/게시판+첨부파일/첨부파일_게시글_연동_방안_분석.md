# 첨부파일-게시글 연동 구현 가이드

## 📋 개요

BlueCrab LMS에서 게시글 작성 시 첨부파일을 연동하는 기능을 단계별로 구현하는 가이드입니다.

**구현 방식**: JSON API 유지 + 기존 첨부파일 업로드 API 활용

## 🎯 최종 목표

게시글 작성 시 첨부파일을 함께 처리하여 `BOARD_TBL.BOARD_FILE` 컬럼에 첨부파일 ID들을 쉼표 구분으로 저장
- 예: `BOARD_FILE = "123,124,125"`

## 📊 전체 플로우

```
1. 게시글 생성 (JSON) → boardIdx 획득
2. 첨부파일 업로드 (FormData) → attachment IDs 획득  
3. 첨부파일 연결 (JSON) → BOARD_FILE 업데이트
```

---

## 1단계: BoardTbl 엔티티에 유틸리티 메서드 추가

### 📝 목적
`BOARD_FILE` 컬럼에 첨부파일 ID 목록을 쉼표 구분으로 저장/조회하는 메서드 추가

### 🔧 구현

**파일**: `BoardTbl.java`

```java
// ========== 첨부파일 ID 관리 유틸리티 메서드 추가 ==========

/**
 * 첨부파일 ID 목록을 BOARD_FILE 컬럼에 쉼표 구분으로 저장
 * @param attachmentIds 첨부파일 ID 목록
 */
public void setAttachmentIds(List<Integer> attachmentIds) {
    if (attachmentIds != null && !attachmentIds.isEmpty()) {
        this.boardFile = attachmentIds.stream()
            .map(String::valueOf)
            .collect(Collectors.joining(","));
    } else {
        this.boardFile = null;
    }
}

/**
 * BOARD_FILE 컬럼에서 첨부파일 ID 목록을 파싱하여 반환
 * @return 첨부파일 ID 목록
 */
public List<Integer> getAttachmentIds() {
    if (boardFile == null || boardFile.trim().isEmpty()) {
        return new ArrayList<>();
    }
    
    return Arrays.stream(boardFile.split(","))
        .filter(id -> !id.trim().isEmpty())
        .map(id -> Integer.parseInt(id.trim()))
        .collect(Collectors.toList());
}

/**
 * 첨부파일이 있는지 확인
 * @return 첨부파일 존재 여부
 */
public boolean hasAttachments() {
    return boardFile != null && !boardFile.trim().isEmpty();
}
```

### 📦 Import 추가

```java
import java.util.Arrays;
import java.util.List;
import java.util.ArrayList;
import java.util.stream.Collectors;
```

---

## 2단계: 첨부파일 연결 DTO 클래스 생성

### 📝 목적
첨부파일 ID 목록을 받기 위한 요청 DTO 생성

### 🔧 구현

**파일**: `AttachmentLinkRequest.java`

```java
// filepath: f:\main_project\team_work\blue-crab-lms\backend\BlueCrab\src\main\java\BlueCrab\com\example\dto\AttachmentLinkRequest.java
// 작성자 : 성태준
// 첨부파일 연결 요청 DTO

package BlueCrab.com.example.dto;

import javax.validation.constraints.NotNull;
import javax.validation.constraints.Size;
import java.util.List;

public class AttachmentLinkRequest {
    
    @NotNull(message = "첨부파일 ID 목록은 필수입니다")
    @Size(max = 5, message = "첨부파일은 최대 5개까지만 가능합니다")
    private List<Integer> attachmentIds;
    
    // ========== 생성자 ==========
    
    public AttachmentLinkRequest() {}
    
    public AttachmentLinkRequest(List<Integer> attachmentIds) {
        this.attachmentIds = attachmentIds;
    }
    
    // ========== Getter/Setter ==========
    
    public List<Integer> getAttachmentIds() {
        return attachmentIds;
    }
    
    public void setAttachmentIds(List<Integer> attachmentIds) {
        this.attachmentIds = attachmentIds;
    }
    
    // ========== 유틸리티 메서드 ==========
    
    @Override
    public String toString() {
        return "AttachmentLinkRequest{" +
                "attachmentIds=" + attachmentIds +
                '}';
    }
}
```

---

## 3단계: BoardController에 첨부파일 연결 API 추가

### 📝 목적
게시글에 첨부파일 ID들을 연결하는 API 추가

### 🔧 구현

**파일**: `BoardController.java`

```java
// ========== 첨부파일 연결 API 추가 ==========

/**
 * 게시글에 첨부파일 연결
 * @param boardIdx 게시글 IDX
 * @param request 첨부파일 ID 목록
 * @return 성공 응답
 */
@PostMapping("/{boardIdx}/link-attachments")
public ResponseEntity<Map<String, Object>> linkAttachments(
        @PathVariable Integer boardIdx,
        @Valid @RequestBody AttachmentLinkRequest request,
        HttpServletRequest httpRequest) {

    log.info("첨부파일 연결 요청: boardIdx={}, attachmentIds={}", 
             boardIdx, request.getAttachmentIds());

    try {
        // JWT 토큰 검증
        String token = jwtUtil.extractTokenFromRequest(httpRequest);
        if (!jwtUtil.validateToken(token)) {
            log.warn("유효하지 않은 JWT 토큰: {}", token);
            return ResponseEntity.status(401)
                .body(Map.of("success", false, "message", "유효하지 않은 토큰입니다."));
        }

        // 게시글 존재 확인
        BoardTbl board = boardService.findById(boardIdx);
        if (board == null) {
            log.warn("존재하지 않는 게시글: boardIdx={}", boardIdx);
            return ResponseEntity.status(404)
                .body(Map.of("success", false, "message", "존재하지 않는 게시글입니다."));
        }

        // 첨부파일 ID 연결
        board.setAttachmentIds(request.getAttachmentIds());
        BoardTbl updatedBoard = boardService.updateBoard(board);

        log.info("첨부파일 연결 완료: boardIdx={}, boardFile={}", 
                 boardIdx, updatedBoard.getBoardFile());

        return ResponseEntity.ok(Map.of(
            "success", true,
            "message", "첨부파일이 성공적으로 연결되었습니다.",
            "data", Map.of(
                "boardIdx", boardIdx,
                "attachmentIds", request.getAttachmentIds(),
                "boardFile", updatedBoard.getBoardFile()
            )
        ));

    } catch (NumberFormatException e) {
        log.error("잘못된 첨부파일 ID 형식: {}", e.getMessage());
        return ResponseEntity.status(400)
            .body(Map.of("success", false, "message", "잘못된 첨부파일 ID 형식입니다."));
    } catch (Exception e) {
        log.error("첨부파일 연결 중 오류 발생: {}", e.getMessage(), e);
        return ResponseEntity.status(500)
            .body(Map.of("success", false, "message", "서버 내부 오류가 발생했습니다."));
    }
}
```

### 📦 Import 추가

```java
import BlueCrab.com.example.dto.AttachmentLinkRequest;
import javax.validation.Valid;
```

---

## 4단계: BoardService에 findById 메서드 확인/추가

### 📝 목적
게시글 존재 확인을 위한 메서드가 있는지 확인하고, 없으면 추가

### 🔧 구현 확인

**파일**: `BoardService.java`

```java
// 게시글 조회 메서드가 있는지 확인하고, 없으면 추가
public BoardTbl findById(Integer boardIdx) {
    return boardRepository.findById(boardIdx).orElse(null);
}

public BoardTbl updateBoard(BoardTbl board) {
    return boardRepository.save(board);
}
```

---

## 5단계: 프론트엔드 구현

### 📝 목적
3단계 API 호출을 순차적으로 처리하는 프론트엔드 로직

### 🔧 구현

**JavaScript 예시**:

```javascript
/**
 * 첨부파일이 포함된 게시글 생성
 * @param {Object} boardData - 게시글 데이터
 * @param {File[]} files - 첨부파일 목록
 */
const createBoardWithAttachments = async (boardData, files) => {
    try {
        // 1단계: 게시글 생성 (JSON)
        console.log('1단계: 게시글 생성 중...');
        const boardResponse = await fetch('/api/boards/create', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${getAuthToken()}`
            },
            body: JSON.stringify(boardData)
        });

        if (!boardResponse.ok) {
            throw new Error('게시글 생성 실패');
        }

        const boardResult = await boardResponse.json();
        const boardIdx = boardResult.boardIdx || boardResult.data?.boardIdx;
        
        console.log(`게시글 생성 완료: boardIdx=${boardIdx}`);

        // 2단계: 첨부파일 업로드 (FormData) - 파일이 있는 경우만
        let attachmentIds = [];
        if (files && files.length > 0) {
            console.log(`2단계: 첨부파일 업로드 중... (${files.length}개)`);
            
            const formData = new FormData();
            files.forEach(file => formData.append('files', file));

            const attachmentResponse = await fetch(`/api/board-attachments/upload/${boardIdx}`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${getAuthToken()}`
                },
                body: formData
            });

            if (!attachmentResponse.ok) {
                throw new Error('첨부파일 업로드 실패');
            }

            const attachmentResult = await attachmentResponse.json();
            attachmentIds = attachmentResult.map(att => att.attachmentIdx);
            
            console.log(`첨부파일 업로드 완료: attachmentIds=${attachmentIds}`);

            // 3단계: 첨부파일 연결 (JSON)
            console.log('3단계: 첨부파일 연결 중...');
            const linkResponse = await fetch(`/api/boards/${boardIdx}/link-attachments`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${getAuthToken()}`
                },
                body: JSON.stringify({ attachmentIds })
            });

            if (!linkResponse.ok) {
                throw new Error('첨부파일 연결 실패');
            }

            const linkResult = await linkResponse.json();
            console.log(`첨부파일 연결 완료: boardFile=${linkResult.data.boardFile}`);
        }

        return {
            success: true,
            boardIdx: boardIdx,
            attachmentIds: attachmentIds,
            message: '게시글이 성공적으로 생성되었습니다.'
        };

    } catch (error) {
        console.error('게시글 생성 중 오류:', error);
        return {
            success: false,
            message: error.message || '게시글 생성 중 오류가 발생했습니다.'
        };
    }
};

// 사용 예시
const handleSubmit = async () => {
    const boardData = {
        boardCode: 1,
        boardWriter: "홍길동",
        boardTitle: "제목",
        boardContent: "내용"
    };
    
    const files = document.getElementById('fileInput').files;
    const result = await createBoardWithAttachments(boardData, Array.from(files));
    
    if (result.success) {
        alert('게시글이 성공적으로 생성되었습니다!');
        location.href = `/board/view/${result.boardIdx}`;
    } else {
        alert(`오류: ${result.message}`);
    }
};
```

---

## 6단계: 테스트

### 📝 테스트 시나리오

#### **시나리오 1: 첨부파일 없는 게시글**
```javascript
const result = await createBoardWithAttachments({
    boardCode: 1,
    boardWriter: "테스터",
    boardTitle: "첨부파일 없는 게시글",
    boardContent: "내용입니다."
}, []);

// 예상 결과: BOARD_FILE = null
```

#### **시나리오 2: 첨부파일 1개**
```javascript
const files = [new File(['test'], 'test.txt', {type: 'text/plain'})];
const result = await createBoardWithAttachments(boardData, files);

// 예상 결과: BOARD_FILE = "123"
```

#### **시나리오 3: 첨부파일 3개**
```javascript
const files = [
    new File(['test1'], 'test1.txt'),
    new File(['test2'], 'test2.txt'), 
    new File(['test3'], 'test3.txt')
];
const result = await createBoardWithAttachments(boardData, files);

// 예상 결과: BOARD_FILE = "123,124,125"
```

---

## 7단계: 검증 및 확인

### 📝 확인 사항

1. **데이터베이스 확인**
   ```sql
   SELECT BOARD_IDX, BOARD_TITLE, BOARD_FILE 
   FROM BOARD_TBL 
   WHERE BOARD_IDX = [생성된_게시글_ID];
   
   SELECT ATTACHMENT_IDX, BOARD_IDX, ORIGINAL_FILE_NAME 
   FROM BOARD_ATTACHMENT_TBL 
   WHERE BOARD_IDX = [생성된_게시글_ID];
   ```

2. **로그 확인**
   - 각 단계별 로그 메시지 확인
   - 에러 로그 없음 확인

3. **응답 데이터 확인**
   - 각 API 응답 구조 정확성
   - attachmentIds 배열 정확성

---

## 🎯 구현 완료 체크리스트

- [ ] 1단계: BoardTbl 유틸리티 메서드 추가
- [ ] 2단계: AttachmentLinkRequest DTO 생성
- [ ] 3단계: BoardController API 추가
- [ ] 4단계: BoardService 메서드 확인
- [ ] 5단계: 프론트엔드 로직 구현
- [ ] 6단계: 테스트 시나리오 실행
- [ ] 7단계: 검증 완료

## 🚀 예상 구현 시간

- **백엔드**: 30분
- **프론트엔드**: 30분
- **테스트**: 15분
- **총 시간**: 1시간 15분

---

## 📋 최종 결과

구현 완료 후 다음과 같은 결과를 얻을 수 있습니다:

1. **JSON API 완전 유지**: 기존 인터페이스 변경 없음
2. **기존 코드 재사용**: 검증된 첨부파일 업로드 로직 활용
3. **성능 최적화**: BOARD_FILE에서 직접 첨부파일 조회
4. **확장성**: 최대 5개 첨부파일 지원
5. **안정성**: 단계별 에러 처리 및 롤백

게시글과 첨부파일이 완벽하게 연동된 시스템이 완성됩니다! 🎉