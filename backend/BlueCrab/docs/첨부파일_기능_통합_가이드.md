# 게시글 첨부파일 기능 통합 가이드

## 📋 개요
기존 게시글 작성/수정 기능에 첨부파일 업로드 기능을 추가하기 위한 API 플로우 가이드입니다.

---

## 🔄 전체 API 플로우

### **게시글 작성 (첨부파일 포함)**
```
1단계: 게시글 생성
   ↓
2단계: 첨부파일 업로드 (선택사항)
   ↓
3단계: 첨부파일 연결 (2단계 실행 시에만)
```

### **게시글 수정 (첨부파일 추가/변경)**
```
1단계: 기존 게시글 조회
   ↓
2단계: 새로운 첨부파일 업로드 (필요시)
   ↓  
3단계: 첨부파일 목록 업데이트
```

---

## 🛠️ API 상세 명세

### **1단계: 게시글 생성** (기존 API)
**엔드포인트**: `POST /api/boards/create`
**헤더**: 
```
Authorization: Bearer {JWT_TOKEN}
Content-Type: application/json
```
**요청 Body**:
```json
{
  "boardCode": 0,
  "boardTitle": "공지사항 제목",
  "boardContent": "공지사항 내용",
  "boardWriterIdx": 1,
  "boardWriterType": 1
}
```
**응답**:
```json
{
  "success": true,
  "boardIdx": 123,  // ← 이 값을 저장해야 함!
  "message": "게시글이 성공적으로 작성되었습니다."
}
```

---

### **2단계: 첨부파일 업로드** (기존 API)
**엔드포인트**: `POST /api/board-attachments/upload/{boardIdx}`
**헤더**: 
```
Authorization: Bearer {JWT_TOKEN}
Content-Type: multipart/form-data
```
**요청 Body**:
```
files: [File1, File2, File3]  // FormData로 전송
```
> **📝 프론트엔드 팀 참고사항**: 
> - 파일 업로드는 반드시 `FormData` 객체를 사용해야 합니다
> - JSON으로는 파일 전송이 불가능합니다 (웹 표준 제약)
> - `<input type="file">` 태그에서 선택한 File 객체들을 FormData에 append하여 전송
**응답**:
```json
{
  "success": true,
  "message": "첨부파일 업로드가 완료되었습니다.",
  "boardIdx": 123,
  "fileCount": 3,
  "attachments": [
    {
      "attachmentIdx": 45,  // ← 이 값들을 저장해야 함!
      "fileName": "파일1.pdf",
      "fileSize": 1024000   // 파일 크기 (단위: bytes, 1024000 = 약 1MB)
    },
    {
      "attachmentIdx": 46,
      "fileName": "파일2.jpg", 
      "fileSize": 512000    // 파일 크기 (단위: bytes, 512000 = 약 500KB)
    },
    {
      "attachmentIdx": 47,
      "fileName": "파일3.docx",
      "fileSize": 256000    // 파일 크기 (단위: bytes, 256000 = 약 250KB)
    }
  ]
}
```

---

### **3단계: 첨부파일 연결** (신규 API)
**엔드포인트**: `POST /api/boards/link-attachments/{boardIdx}`
**헤더**:
```
Authorization: Bearer {JWT_TOKEN}
Content-Type: application/json
```
**요청 Body**:
```json
{
  "attachmentIdx": [45, 46, 47]  // 2단계에서 받은 attachmentIdx들
}
```
**응답**:
```json
{
  "success": true,
  "message": "첨부파일이 성공적으로 연결되었습니다.",
  "boardIdx": 123,
  "attachmentCount": 3,
  "attachmentIdx": [45, 46, 47]
}
```

---

## 💻 프론트엔드 구현 예시

### **게시글 작성 (첨부파일 포함)**

```javascript
async function createBoardWithAttachments(boardData, files) {
    try {
        // 1단계: 게시글 생성
        console.log('1단계: 게시글 생성 시작');
        const boardResponse = await fetch('/api/boards/create', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${getJwtToken()}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(boardData)
        });
        
        const boardResult = await boardResponse.json();
        
        if (!boardResult.success) {
            throw new Error(boardResult.message || '게시글 생성 실패');
        }
        
        const boardIdx = boardResult.boardIdx;
        console.log('1단계 완료: 게시글 생성됨 (boardIdx:', boardIdx, ')');
        
        // 첨부파일이 있는 경우에만 2~3단계 실행
        if (files && files.length > 0) {
            
            // 2단계: 첨부파일 업로드
            console.log('2단계: 첨부파일 업로드 시작');
            
            // 💡 중요: 파일 업로드는 FormData 객체를 사용해야 함
            // JSON으로는 파일 전송 불가능 (웹 표준 제약)
            const formData = new FormData();
            files.forEach(file => formData.append('files', file));
            // ↑ File 객체를 'files' 키로 FormData에 추가
            
            const uploadResponse = await fetch(`/api/board-attachments/upload/${boardIdx}`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${getJwtToken()}`
                },
                body: formData
            });
            
            const uploadResult = await uploadResponse.json();
            
            if (!uploadResult.success) {
                throw new Error(uploadResult.message || '첨부파일 업로드 실패');
            }
            
            console.log('2단계 완료: 첨부파일 업로드됨');
            
            // 3단계: 첨부파일 연결
            console.log('3단계: 첨부파일 연결 시작');
            const attachmentIds = uploadResult.attachments.map(att => att.attachmentIdx);
            
            const linkResponse = await fetch(`/api/boards/link-attachments/${boardIdx}`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${getJwtToken()}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    attachmentIdx: attachmentIds
                })
            });
            
            const linkResult = await linkResponse.json();
            
            if (!linkResult.success) {
                throw new Error(linkResult.message || '첨부파일 연결 실패');
            }
            
            console.log('3단계 완료: 첨부파일 연결됨');
        }
        
        return {
            success: true,
            boardIdx: boardIdx,
            message: '게시글이 성공적으로 작성되었습니다.'
        };
        
    } catch (error) {
        console.error('게시글 작성 실패:', error);
        return {
            success: false,
            error: error.message
        };
    }
}

// JWT 토큰 가져오기 (기존 구현에 맞게 수정 필요)
function getJwtToken() {
    return localStorage.getItem('jwtToken') || sessionStorage.getItem('jwtToken');
}
```

---

## 🔧 기존 프론트엔드 수정 가이드

### **1. HTML 폼 수정**
```html
<!-- 기존 게시글 작성 폼에 파일 입력 추가 -->
<form id="boardForm">
    <!-- 기존 필드들 -->
    <input type="text" id="boardTitle" name="boardTitle" required>
    <textarea id="boardContent" name="boardContent" required></textarea>
    
    <!-- 새로 추가할 첨부파일 필드 -->
    <div class="file-upload-section">
        <label for="attachments">첨부파일 (최대 5개)</label>
        <input type="file" id="attachments" name="attachments" multiple accept="*/*" max="5">
        <div id="fileList" class="file-list"></div>
    </div>
    
    <button type="submit">게시글 작성</button>
</form>
```

### **2. JavaScript 이벤트 핸들러 수정**
```javascript
// 기존 폼 제출 이벤트 핸들러 수정
document.getElementById('boardForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    // 기존 게시글 데이터 수집
    const boardData = {
        boardCode: parseInt(document.getElementById('boardCode').value),
        boardTitle: document.getElementById('boardTitle').value,
        boardContent: document.getElementById('boardContent').value,
        boardWriterIdx: getCurrentUserIdx(),  // 기존 구현에 맞게 수정
        boardWriterType: getCurrentUserType() // 기존 구현에 맞게 수정
    };
    
    // 첨부파일 수집
    const fileInput = document.getElementById('attachments');
    const files = Array.from(fileInput.files);
    
    // 파일 개수 검증
    if (files.length > 5) {
        alert('첨부파일은 최대 5개까지만 업로드할 수 있습니다.');
        return;
    }
    
    // 로딩 상태 표시
    showLoading('게시글을 작성 중입니다...');
    
    try {
        // 새로운 통합 함수 호출
        const result = await createBoardWithAttachments(boardData, files);
        
        if (result.success) {
            alert('게시글이 성공적으로 작성되었습니다.');
            // 게시글 목록 페이지로 이동 또는 새로고침
            window.location.href = '/boards';
        } else {
            alert('게시글 작성 실패: ' + result.error);
        }
    } catch (error) {
        alert('게시글 작성 중 오류가 발생했습니다: ' + error.message);
    } finally {
        hideLoading();
    }
});
```

### **3. 파일 선택 미리보기 기능**
```javascript
// 파일 선택 시 미리보기 표시
document.getElementById('attachments').addEventListener('change', function(e) {
    const files = Array.from(e.target.files);
    const fileListDiv = document.getElementById('fileList');
    
    // 파일 개수 검증
    if (files.length > 5) {
        alert('첨부파일은 최대 5개까지만 선택할 수 있습니다.');
        e.target.value = '';
        return;
    }
    
    // 파일 목록 표시
    fileListDiv.innerHTML = '';
    files.forEach((file, index) => {
        const fileItem = document.createElement('div');
        fileItem.className = 'file-item';
        fileItem.innerHTML = `
            <span class="file-name">${file.name}</span>
            <span class="file-size">(${formatFileSize(file.size)})</span>
            <button type="button" onclick="removeFile(${index})">삭제</button>
        `;
        fileListDiv.appendChild(fileItem);
    });
});

// 파일 크기 포맷팅 (bytes를 사람이 읽기 쉬운 단위로 변환)
function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;  // 1KB = 1024 bytes
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];  // 단위 배열
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    // 예시: 1024000 bytes → 1000.00 KB → "1000.00 KB"
    //      1048576 bytes → 1.00 MB → "1.00 MB"
}
```

---

## ⚠️ 주의사항

### **1. 파일 전송 방식 (중요!)**
- **2단계 파일 업로드**: 반드시 `FormData` 사용 (JSON 불가)
- **1, 3단계**: JSON 방식으로 전송
- **이유**: 파일(바이너리 데이터)은 웹 표준상 FormData로만 전송 가능

### **2. 에러 처리**
- 각 단계별로 실패 시 사용자에게 명확한 메시지 표시
- 네트워크 오류, 인증 오류, 서버 오류 구분하여 처리

### **2. 첨부파일 제한**
- 최대 5개 파일
- 파일 크기 제한 (서버 설정에 따라)
- 파일 형식 제한 (필요시)

### **3. 사용자 경험**
- 로딩 상태 표시
- 진행률 표시 (대용량 파일 업로드 시)
- 취소 기능 제공

### **4. 트랜잭션 처리**
- 1단계 성공 후 2~3단계 실패 시에도 게시글은 생성됨
- 필요시 롤백 로직 구현 고려

---

## 🔍 테스트 시나리오

### **정상 케이스**
1. 첨부파일 없는 게시글 작성
2. 첨부파일 1개 포함 게시글 작성  
3. 첨부파일 5개 포함 게시글 작성

### **에러 케이스**
1. JWT 토큰 만료
2. 첨부파일 개수 초과 (6개 이상)
3. 네트워크 연결 오류
4. 서버 오류

---

## 📞 문의사항
백엔드 API 관련 문의사항이 있으시면 언제든지 말씀해 주세요!