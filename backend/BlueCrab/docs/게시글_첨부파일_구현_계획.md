# 게시글 첨부파일 구현 계획 (MinIO 기반)

## 개요

게시글 시스템에 MinIO를 활용한 첨부파일 기능을 구현한다. 파일 업로드, 다운로드, 삭제 기능을 제공하며 보안성과 성능을 고려한 아키텍처를 구성한다.

## MinIO 설정 작업

### 1. 버킷 생성

- **버킷 이름**: `board-attached`
- **목적**: 게시글 첨부파일 저장 전용 버킷

### 2. 파일 저장 구조

- **폴더 구조**: `YYYYMMDD/` 형식의 날짜별 하위 폴더 자동 생성
- **파일명 규칙**: `YYYYMMDD-HHMMSS-XXX` (XXX는 3자리 고유 숫자)
  - 예: `20231201-143052-005.pdf`
- **태그 설정**:
  - `BOARD_IDX`: 연결된 게시글 ID
  - `EXPIRY_DATE`: 파일 만료일
  - `ACTIVE`: 첨부파일 활성화 상태 (true/false)

## Backend 작업

### Controller 레이어

#### 1. BoardCreateController

- **게시글 작성 시 첨부파일 처리**
  - 파일 업로드 API 추가
  - `boardFile` 컬럼에 파일 경로 저장 (없을 시 null)
  - 파일 검증 로직 포함

#### 2. BoardUpdateController

- **게시글 수정 시 첨부파일 처리**
  - 파일 업로드/교체 기능
  - 파일 삭제 기능 (비활성화 처리)
- **게시글 삭제 시 첨부파일 처리**
  - 첨부파일 자동 비활성화

#### 3. BoardController

- **게시글 열람 시 첨부파일 처리**
  - 첨부파일 정보 포함하여 반환
  - 태그 확인 후 활성 파일만 다운로드 허용

### Repository 레이어

#### BoardRepository

- **리스트 조회 시 최적화**
  - 첨부파일 정보 로드 제외 (성능 향상)
  - 기존 쿼리 유지하되 첨부 관련 컬럼 제외

#### BoardAttachmentRepository

- **첨부파일 관리**
  - BoardAttachment 엔티티 CRUD 작업
  - 게시글별 첨부파일 조회
  - 활성 파일 필터링

### Service 레이어

#### BoardService

- **리스트 조회 서비스**
  - 첨부파일 항목 로드 제외
  - 기존 로직 유지

#### BoardManagementService

- **게시글 작성 시 첨부파일 처리**
  - 파일 업로드 로직 추가
  - MinIO 연동 및 파일 저장

#### BoardAttachmentService

- **첨부파일 전용 서비스**
  - 파일 업로드/다운로드/삭제
  - MinIO 연동 및 태그 관리
  - 파일 검증 및 보안 처리

## 설정 파일

### application.properties

```properties
# MinIO 설정
minio.endpoint=http://localhost:9000
minio.access-key=your-access-key
minio.secret-key=your-secret-key
minio.bucket-name=board-attached

# 파일 업로드 설정
file.upload.max-size=10MB
file.upload.allowed-extensions=pdf,doc,docx,xls,xlsx,ppt,pptx,txt,jpg,jpeg,png,gif
```

## 보안 및 검증 요구사항

### 1. 파일 형식 검증

- 허용된 파일 확장자만 업로드 가능
- MIME 타입 검증

### 2. 보안 조치

- 파일명 Sanitization (경로 조작 방지)
- 파일 내용 인젝션 방지
- 업로드 용량 제한 (기본: 10MB)

### 3. 바이러스 검사 (선택사항)

- ClamAV 연동 고려
- 업로드 전 바이러스 스캔

### 4. 만료 정책

- 파일 만료일 설정
- 만료 시 자동 비활성화
- MinIO 라이프사이클 정책 적용

## 구현 순서

1. **MinIO 설정 및 연결**
   - application.properties에 MinIO 설정 추가
   - MinIO 클라이언트 빈 생성

2. **데이터베이스 스키마 변경**
   - board_attachment 테이블 설계
   - BoardAttachment 엔티티 생성

3. **Controller 구현**
   - 파일 업로드 API 구현
   - 파일 다운로드 API 구현
   - 파일 삭제 API 구현

4. **통합 테스트**
   - 단위 테스트 작성
   - 통합 테스트 수행

## 고려사항

- **성능**: 대용량 파일 처리 시 스트리밍 고려
- **확장성**: 분산 MinIO 클러스터 구성 고려
- **백업**: 파일 백업 전략 수립
- **모니터링**: 업로드/다운로드 로그 기록

## 관련 파일

- MinIO 설정: `application.properties`
- 서비스 클래스: `BoardManagementService.java`, `BoardAttachmentService.java`
- 컨트롤러: `BoardCreateController.java`, `BoardUpdateController.java`, `BoardController.java`
- 리포지토리: `BoardRepository.java`, `BoardAttachmentRepository.java`