# 게시글 첨부파일 구현 계획 (MinIO 기반) - 업데이트

## 개요

게시글 시스템에 MinIO를 활용한 첨부파일 기능을 구현한다. **3단계 API 워크플로우**를 통해 파일 업로드, 연결, 조회 기능을 제공하며 보안성과 성능을 고려한 아키텍처를 구성한다.

## ✅ 완료된 구현

### 1. 첨부파일 업로드 API
- **엔드포인트**: `POST /api/board-attachments/upload/{boardIdx}`
- **기능**: MultipartFile을 MinIO에 업로드하고 DB에 메타데이터 저장
- **구현파일**: `BoardAttachmentUploadController.java`, `BoardAttachmentService.java`

### 2. 첨부파일 연결 API
- **엔드포인트**: `POST /api/boards/link-attachments/{boardIdx}`
- **기능**: 업로드된 첨부파일을 게시글과 연결 (BOARD_FILE 컬럼 업데이트)
- **구현파일**: `BoardController.java`

### 3. 3단계 워크플로우 완성
1. **게시글 생성**: `POST /api/boards/create`
2. **파일 업로드**: `POST /api/board-attachments/upload/{boardIdx}`
3. **첨부파일 연결**: `POST /api/boards/link-attachments/{boardIdx}`

### 4. 데이터베이스 구조
- **BOARD_TBL.BOARD_FILE**: 첨부파일 IDX를 콤마 구분 문자열로 저장
- **BoardAttachmentTbl**: 첨부파일 메타데이터 (파일명, 경로, 크기 등)

## 🔄 실제 구현된 플로우

### 현재 API 플로우 (3단계)
```
1. 게시글 생성 (JSON)
   ↓ boardIdx 받기
2. 파일 업로드 (FormData)  
   ↓ attachmentIdx 받기
3. 첨부파일 연결 (JSON)
   ↓ 완료
```

### MinIO 파일 저장 구조 (구현됨)
- **버킷**: `board-attached`
- **폴더 구조**: `YYYYMMDD/` 형식의 날짜별 하위 폴더
- **파일명 규칙**: `YYYYMMDD-HHMMSS-XXX` (XXX는 3자리 고유 숫자)
- **태그 설정**: `BOARD_IDX`, `EXPIRY_DATE`, `ACTIVE`

## 🚧 미완성 기능 (다음 단계)

### 1. 첨부파일 조회 기능

- **목적**: 게시글 상세 조회 시 첨부파일 목록 포함
- **필요 작업**:
  - `BoardController.getBoardDetail()` 수정
  - 첨부파일 목록 응답에 포함
  - 다운로드 URL 생성

### 2. 첨부파일 다운로드 API

- **엔드포인트**: `GET /api/board-attachments/download/{attachmentIdx}`
- **기능**: MinIO에서 파일 스트리밍 다운로드
- **필요 작업**:
  - 다운로드 컨트롤러 구현
  - 권한 검증 (게시글 접근 권한)
  - MinIO 파일 스트리밍

### 3. 첨부파일 삭제 기능

- **게시글 삭제 시**: 연결된 첨부파일 자동 비활성화
- **개별 삭제**: 첨부파일 개별 삭제 API
- **필요 작업**:
  - `BoardManagementService.deleteBoard()` 수정
  - MinIO 파일 태그 업데이트 (ACTIVE=false)
  - 개별 삭제 API 구현

### 4. 게시글 수정 시 첨부파일 관리

- **기능**: 기존 첨부파일 유지/삭제, 새 파일 추가
- **복잡도**: 높음 (프론트엔드 UI 복잡)
- **우선순위**: 낮음

## 🎯 다음 단계 우선순위

### 높은 우선순위 (즉시 구현 권장)

#### **1. 첨부파일 조회 기능** 🔥

- **이유**: 업로드만 되고 조회가 안 되면 의미가 없음
- **작업량**: 중간
- **영향도**: 높음

#### **2. 첨부파일 다운로드 API** 🔥

- **이유**: 사용자가 업로드한 파일을 다운로드할 수 있어야 함
- **작업량**: 중간
- **영향도**: 높음

### 중간 우선순위 (2차 구현)

#### **3. 게시글 삭제 시 첨부파일 자동 삭제**

- **이유**: 데이터 정합성 유지 필요
- **작업량**: 적음
- **영향도**: 중간

### 낮은 우선순위 (3차 구현)

#### **4. 게시글 수정 시 첨부파일 관리**

- **이유**: 복잡한 UI/UX 필요, 당장 필수적이지 않음
- **작업량**: 많음
- **영향도**: 낮음

## 📋 권장 개발 순서

### **Step 1: 첨부파일 조회 기능** (1-2일)

```java
// BoardController.getBoardDetail() 수정
// 첨부파일 목록을 응답에 포함
```

### **Step 2: 첨부파일 다운로드 API** (2-3일)

```java
// 새 컨트롤러: BoardAttachmentDownloadController
// MinIO 파일 스트리밍 구현
```

### **Step 3: 자동 삭제 기능** (1일)

```java
// BoardManagementService.deleteBoard() 수정
// MinIO 태그 업데이트
```

## 💡 즉시 할 일

1. **첨부파일 조회 기능부터 시작** - 가장 급함
2. **프론트엔드 팀과 협업** - 조회/다운로드 UI 필요
3. **테스트 환경 준비** - 실제 파일 업로드/다운로드 테스트

이렇게 단계별로 진행하면 **사용 가능한 첨부파일 시스템**이 완성됩니다! 🚀