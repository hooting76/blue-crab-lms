<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>첨부파일 기능 테스트</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .section h3 {
            margin-top: 0;
            color: #333;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .log-area {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            padding: 15px;
            margin-top: 15px;
            border-radius: 4px;
            height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        .auth-status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .auth-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .auth-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔧 BlueCrab LMS 첨부파일 기능 테스트</h1>
        
        <!-- 인증 상태 -->
        <div class="section">
            <h3>🔐 1. 인증 상태</h3>
            <div id="authStatus" class="auth-status auth-error">
                로그인이 필요합니다.
            </div>
            <button onclick="checkAuthStatus()">인증 상태 확인</button>
            <button onclick="showLoginModal()">로그인</button>
            <button onclick="logout()">로그아웃</button>
        </div>

        <!-- 로그인 모달 -->
        <div id="loginModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 8px; width: 400px;">
                <h3>🔐 로그인</h3>
                
                <!-- 로그인 타입 선택 -->
                <div style="margin: 15px 0;">
                    <label>
                        <input type="radio" name="loginType" value="user" checked> 일반 사용자 로그인
                    </label>
                    <br>
                    <label>
                        <input type="radio" name="loginType" value="admin"> 관리자 로그인
                    </label>
                </div>
                
                <!-- 일반 사용자 로그인 폼 -->
                <div id="userLoginForm">
                    <div style="margin: 10px 0;">
                        <label>이메일:</label>
                        <input type="email" id="userEmail" placeholder="professor@example.com" style="width: 100%; padding: 8px; margin-top: 5px;">
                    </div>
                    <div style="margin: 10px 0;">
                        <label>비밀번호:</label>
                        <input type="password" id="userPassword" style="width: 100%; padding: 8px; margin-top: 5px;">
                    </div>
                    <button onclick="performUserLogin()" style="width: 100%; margin: 10px 0;">일반 사용자 로그인</button>
                </div>
                
                <!-- 관리자 로그인 폼 -->
                <div id="adminLoginForm" style="display: none;">
                    <div style="margin: 10px 0;">
                        <label>관리자 ID:</label>
                        <input type="text" id="adminId" placeholder="admin" style="width: 100%; padding: 8px; margin-top: 5px;">
                    </div>
                    <div id="adminStep1" style="display: block;">
                        <button onclick="performAdminStep1()" style="width: 100%; margin: 10px 0;">1단계: 관리자 확인</button>
                    </div>
                    <div id="adminStep2" style="display: none;">
                        <button onclick="performAdminStep2()" style="width: 100%; margin: 10px 0;">2단계: 인증 코드 요청</button>
                    </div>
                    <div id="adminStep3" style="display: none;">
                        <div style="margin: 10px 0;">
                            <label>인증 코드:</label>
                            <input type="text" id="verificationCode" placeholder="6자리 숫자" style="width: 100%; padding: 8px; margin-top: 5px;">
                        </div>
                        <button onclick="performAdminStep3()" style="width: 100%; margin: 10px 0;">3단계: 로그인 완료</button>
                    </div>
                </div>
                
                <button onclick="closeLoginModal()" style="width: 100%; background: #6c757d;">취소</button>
            </div>
        </div>

        <!-- 게시글 생성 -->
        <div class="section">
            <h3>📝 2. 게시글 생성</h3>
            <button onclick="createBasicBoard()" id="createBasicBtn">기본 게시글 생성</button>
            <button onclick="createBoardWithAttachments()" id="createWithAttBtn" disabled>첨부파일 포함 게시글 생성</button>
            <button onclick="createQuickBoardWithAttachments()" id="createQuickAttBtn" disabled>빠른 첨부파일 게시글 생성</button>
        </div>

        <!-- 파일 업로드 테스트 -->
        <div class="section">
            <h3>📎 3. 파일 업로드 테스트</h3>
            <input type="file" id="fileInput" multiple accept="*/*" style="margin: 10px 0;">
            <br>
            <button onclick="testFileUpload()" id="uploadBtn" disabled>선택된 파일 업로드 테스트</button>
            <button onclick="testAttachmentLink()" id="linkBtn" disabled>첨부파일 연결 테스트</button>
        </div>

        <!-- 로그 영역 -->
        <div class="section">
            <h3>📋 4. 실행 로그</h3>
            <button onclick="clearLog()">로그 지우기</button>
            <div id="logArea" class="log-area"></div>
        </div>
    </div>

    <script>
        // ========== 설정 ==========
        const API_BASE_URL = 'https://bluecrab.chickenkiller.com/BlueCrab-1.0.0';
        let lastCreatedBoard = null;
        let lastUploadedAttachments = [];

        // ========== 로그 함수 ==========
        function log(message, type = 'info') {
            const logArea = document.getElementById('logArea');
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                info: '#333',
                success: '#28a745',
                error: '#dc3545',
                warning: '#ffc107'
            };
            
            logArea.innerHTML += `<div style="color: ${colors[type]}; margin: 2px 0;">
                [${timestamp}] ${message}
            </div>`;
            logArea.scrollTop = logArea.scrollHeight;
        }

        function clearLog() {
            document.getElementById('logArea').innerHTML = '';
        }

        // ========== 인증 관련 ==========
        function checkAuthStatus() {
            const adminToken = window.adminJwtToken || localStorage.getItem('adminJwtToken');
            const userToken = window.authToken;
            const statusDiv = document.getElementById('authStatus');
            
            if (adminToken || userToken) {
                statusDiv.className = 'auth-status auth-success';
                statusDiv.textContent = '✅ 로그인됨 - 첨부파일 기능 사용 가능';
                
                // 버튼들 활성화
                document.getElementById('createWithAttBtn').disabled = false;
                document.getElementById('createQuickAttBtn').disabled = false;
                document.getElementById('uploadBtn').disabled = false;
                document.getElementById('linkBtn').disabled = false;
                
                log('✅ 인증 상태: 로그인됨', 'success');
                if (adminToken) log('🔑 관리자 토큰 사용', 'info');
                if (userToken) log('🔑 사용자 토큰 사용', 'info');
            } else {
                statusDiv.className = 'auth-status auth-error';
                statusDiv.textContent = '❌ 로그인 필요 - 먼저 로그인하세요';
                
                // 버튼들 비활성화
                document.getElementById('createWithAttBtn').disabled = true;
                document.getElementById('createQuickAttBtn').disabled = true;
                document.getElementById('uploadBtn').disabled = true;
                document.getElementById('linkBtn').disabled = true;
                
                log('❌ 인증 상태: 로그인 필요', 'error');
            }
        }

        function showLoginInstructions() {
            log('💡 로그인 방법:', 'info');
            log('1. "로그인" 버튼을 클릭하세요', 'info');
            log('2. 일반 사용자 또는 관리자를 선택하세요', 'info');
            log('3. 로그인 정보를 입력하고 로그인하세요', 'info');
        }

        // ========== 로그인 모달 관련 ==========
        function showLoginModal() {
            document.getElementById('loginModal').style.display = 'block';
            resetAdminLoginSteps();
        }

        function closeLoginModal() {
            document.getElementById('loginModal').style.display = 'none';
            resetAdminLoginSteps();
        }

        function resetAdminLoginSteps() {
            document.getElementById('adminStep1').style.display = 'block';
            document.getElementById('adminStep2').style.display = 'none';
            document.getElementById('adminStep3').style.display = 'none';
            document.getElementById('verificationCode').value = '';
        }

        // 로그인 타입 변경 이벤트
        document.addEventListener('DOMContentLoaded', function() {
            log('🔧 첨부파일 테스트 페이지 로드 완료', 'success');
            log('💡 사용법:', 'info');
            log('1. 먼저 "인증 상태 확인" 버튼을 클릭하세요', 'info');
            log('2. 로그인이 필요하면 "로그인" 버튼을 클릭하세요', 'info');
            log('3. 파일을 선택하고 테스트 버튼들을 사용하세요', 'info');
            
            checkAuthStatus();
            
            // 파일 선택 시 로그 출력
            document.getElementById('fileInput').addEventListener('change', function(e) {
                const files = Array.from(e.target.files);
                if (files.length > 0) {
                    log(`📁 ${files.length}개 파일 선택됨:`, 'info');
                    files.forEach((file, index) => {
                        log(`   ${index + 1}. ${file.name} (${formatFileSize(file.size)})`, 'info');
                    });
                } else {
                    log('📁 파일 선택이 취소되었습니다.', 'warning');
                }
            });
            
            // 로그인 타입 변경 이벤트 리스너 추가
            const loginTypeRadios = document.querySelectorAll('input[name="loginType"]');
            loginTypeRadios.forEach(radio => {
                radio.addEventListener('change', function() {
                    const userForm = document.getElementById('userLoginForm');
                    const adminForm = document.getElementById('adminLoginForm');
                    
                    if (this.value === 'user') {
                        userForm.style.display = 'block';
                        adminForm.style.display = 'none';
                        log('🔄 일반 사용자 로그인 모드로 변경', 'info');
                    } else {
                        userForm.style.display = 'none';
                        adminForm.style.display = 'block';
                        log('🔄 관리자 로그인 모드로 변경', 'info');
                    }
                    resetAdminLoginSteps();
                });
            });
            
            // Enter 키 이벤트 추가
            document.getElementById('userEmail').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    document.getElementById('userPassword').focus();
                }
            });
            
            document.getElementById('userPassword').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    performUserLogin();
                }
            });
            
            document.getElementById('verificationCode').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    performAdminStep3();
                }
            });
        });

        // ========== 일반 사용자 로그인 ==========
        async function performUserLogin() {
            const email = document.getElementById('userEmail').value.trim();
            const password = document.getElementById('userPassword').value.trim();
            
            if (!email || !password) {
                log('❌ 이메일과 비밀번호를 모두 입력해주세요.', 'error');
                return;
            }
            
            log('🔐 일반 사용자 로그인 시도...', 'info');
            log(`📧 이메일: ${email}`, 'info');
            
            const loginData = { username: email, password: password };
            
            try {
                log('📡 로그인 API 호출 중...', 'info');
                
                const response = await fetch('https://bluecrab.chickenkiller.com/BlueCrab-1.0.0/api/auth/login', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    mode: 'cors',
                    credentials: 'include',
                    body: JSON.stringify(loginData)
                });
                
                log(`📡 응답 상태: ${response.status}`, response.ok ? 'success' : 'error');
                
                const result = await response.json();
                log(`📡 응답 데이터: ${JSON.stringify(result)}`, 'info');
                
                if (response.ok && result.data && result.data.accessToken) {
                    window.authToken = result.data.accessToken;
                    window.refreshToken = result.data.refreshToken;
                    window.currentUser = result.data.user;
                    
                    log('✅ 일반 사용자 로그인 성공!', 'success');
                    log(`👤 사용자: ${result.data.user.userName}`, 'success');
                    log(`📋 유형: ${result.data.user.userStudent === 1 ? '교수' : '학생'}`, 'success');
                    log(`🎯 토큰 저장 완료`, 'success');
                    
                    closeLoginModal();
                    checkAuthStatus();
                } else {
                    const errorMsg = result.message || result.error || '로그인에 실패했습니다';
                    log('❌ 로그인 실패: ' + errorMsg, 'error');
                    
                    if (response.status === 401) {
                        log('💡 이메일과 비밀번호를 다시 확인해주세요', 'warning');
                    } else if (response.status >= 500) {
                        log('💡 서버 오류입니다. 잠시 후 다시 시도해주세요', 'warning');
                    }
                }
            } catch (error) {
                log('❌ 로그인 요청 오류: ' + error.message, 'error');
                log('💡 네트워크 연결을 확인해주세요', 'warning');
            }
        }

        // ========== 관리자 로그인 (3단계) ==========
        async function performAdminStep1() {
            const adminId = document.getElementById('adminId').value.trim();
            
            if (!adminId) {
                log('❌ 관리자 ID를 입력해주세요.', 'error');
                return;
            }
            
            log('🔐 관리자 로그인 1단계 시도...', 'info');
            log(`👤 관리자 ID: ${adminId}`, 'info');
            
            try {
                log('📡 1단계 API 호출 중...', 'info');
                
                const response = await fetch('https://bluecrab.chickenkiller.com/BlueCrab-1.0.0/api/admin/auth/login', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    mode: 'cors',
                    credentials: 'include',
                    body: JSON.stringify({ adminId: adminId })
                });
                
                log(`📡 1단계 응답 상태: ${response.status}`, response.ok ? 'success' : 'error');
                
                const result = await response.json();
                log(`📡 1단계 응답 데이터: ${JSON.stringify(result)}`, 'info');
                
                if (response.ok) {
                    window.adminId = adminId;
                    
                    log('✅ 1단계 완료: 관리자 확인됨', 'success');
                    log('💡 2단계 버튼을 클릭하여 인증 코드를 요청하세요.', 'info');
                    
                    document.getElementById('adminStep1').style.display = 'none';
                    document.getElementById('adminStep2').style.display = 'block';
                } else {
                    const errorMsg = result.message || result.error || '관리자 ID를 확인해주세요';
                    log('❌ 1단계 실패: ' + errorMsg, 'error');
                    
                    if (response.status === 404) {
                        log('💡 관리자 ID가 존재하지 않습니다', 'warning');
                    }
                }
            } catch (error) {
                log('❌ 1단계 요청 오류: ' + error.message, 'error');
                log('💡 네트워크 연결을 확인해주세요', 'warning');
            }
        }

        async function performAdminStep2() {
            if (!window.adminId) {
                log('❌ 1단계를 먼저 완료해주세요.', 'error');
                return;
            }
            
            log('🔐 관리자 로그인 2단계: 인증 코드 요청...', 'info');
            log(`👤 관리자 ID: ${window.adminId}`, 'info');
            
            try {
                log('📡 2단계 API 호출 중...', 'info');
                
                const response = await fetch('https://bluecrab.chickenkiller.com/BlueCrab-1.0.0/api/admin/auth/send-code', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    mode: 'cors',
                    credentials: 'include',
                    body: JSON.stringify({ adminId: window.adminId })
                });
                
                log(`📡 2단계 응답 상태: ${response.status}`, response.ok ? 'success' : 'error');
                
                const result = await response.json();
                log(`📡 2단계 응답 데이터: ${JSON.stringify(result)}`, 'info');
                
                if (response.ok) {
                    log('✅ 2단계 완료: 인증 코드 발송됨', 'success');
                    log('� 이메일을 확인하고 6자리 인증 코드를 입력하세요.', 'info');
                    
                    document.getElementById('adminStep2').style.display = 'none';
                    document.getElementById('adminStep3').style.display = 'block';
                    
                    // 인증 코드 입력 필드에 포커스
                    setTimeout(() => {
                        document.getElementById('verificationCode').focus();
                    }, 100);
                } else {
                    const errorMsg = result.message || result.error || '인증 코드 발송에 실패했습니다';
                    log('❌ 2단계 실패: ' + errorMsg, 'error');
                    
                    if (response.status === 429) {
                        log('💡 너무 많은 요청입니다. 잠시 후 다시 시도해주세요', 'warning');
                    }
                }
            } catch (error) {
                log('❌ 2단계 요청 오류: ' + error.message, 'error');
                log('💡 네트워크 연결을 확인해주세요', 'warning');
            }
        }

        async function performAdminStep3() {
            const code = document.getElementById('verificationCode').value;
            
            if (!code) {
                log('❌ 인증 코드를 입력해주세요.', 'error');
                return;
            }
            
            log('🔐 관리자 로그인 3단계: 인증 코드 확인...', 'info');
            
            try {
                const response = await fetch('https://bluecrab.chickenkiller.com/BlueCrab-1.0.0/api/admin/auth/verify-code', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        adminId: window.adminId,
                        verificationCode: code 
                    })
                });
                
                const result = await response.json();
                
                if (response.ok && result.data) {
                    window.adminJwtToken = result.data.jwtToken;
                    localStorage.setItem('adminJwtToken', result.data.jwtToken);
                    localStorage.setItem('adminInfo', JSON.stringify({
                        adminId: window.adminId,
                        name: result.data.adminName
                    }));
                    
                    log('✅ 관리자 로그인 완료!', 'success');
                    log(`관리자명: ${result.data.adminName}`, 'success');
                    
                    closeLoginModal();
                    checkAuthStatus();
                } else {
                    log('❌ 3단계 실패: ' + (result.message || '인증 코드가 올바르지 않습니다'), 'error');
                }
            } catch (error) {
                log('❌ 3단계 오류: ' + error.message, 'error');
            }
        }

        // ========== 로그아웃 ==========
        async function logout() {
            log('🚪 로그아웃 중...', 'info');
            
            // 토큰 정리
            window.authToken = null;
            window.refreshToken = null;
            window.currentUser = null;
            window.adminJwtToken = null;
            window.adminId = null;
            
            localStorage.removeItem('adminJwtToken');
            localStorage.removeItem('adminInfo');
            
            log('✅ 로그아웃 완료', 'success');
            checkAuthStatus();
        }

        // ========== HTTP 요청 함수 ==========
        async function apiRequest(url, method = 'GET', data = null, requireAuth = false, isFormData = false) {
            const options = {
                method: method,
                headers: {},
                mode: 'cors',
                credentials: 'include'
            };

            // FormData가 아닌 경우에만 Content-Type 설정
            if (!isFormData) {
                options.headers['Content-Type'] = 'application/json';
                options.headers['Accept'] = 'application/json';
            } else {
                options.headers['Accept'] = 'application/json';
            }

            // 인증 토큰 추가
            if (requireAuth) {
                const adminToken = window.adminJwtToken || localStorage.getItem('adminJwtToken');
                const userToken = window.authToken;
                const token = adminToken || userToken;
                
                if (token) {
                    options.headers['Authorization'] = `Bearer ${token}`;
                }
            }

            if (data) {
                if (isFormData) {
                    options.body = data; // FormData는 그대로 전달
                } else {
                    options.body = JSON.stringify(data);
                }
            }

            try {
                log(`${method} ${url}`, 'info');
                if (data && !isFormData) log(`Data: ${JSON.stringify(data)}`, 'info');
                
                const response = await fetch(url, options);
                const result = await response.json();
                
                log(`Status: ${response.status}`, response.ok ? 'success' : 'error');
                log(`Response: ${JSON.stringify(result)}`, response.ok ? 'success' : 'error');
                
                return { success: response.ok, status: response.status, data: result };
            } catch (error) {
                log(`Request failed: ${error.message}`, 'error');
                return { success: false, error: error.message };
            }
        }

        // ========== 게시글 생성 함수 ==========
        async function createBasicBoard() {
            log('📝 기본 게시글 생성 시작...', 'info');
            
            const boardData = {
                boardTitle: `테스트 게시글 ${new Date().toLocaleTimeString()}`,
                boardContent: `HTML 페이지에서 생성된 테스트 게시글입니다.\n생성 시간: ${new Date().toISOString()}`,
                boardCode: 3
            };

            const result = await apiRequest(`${API_BASE_URL}/api/boards/create`, 'POST', boardData, true);
            
            if (result.success) {
                lastCreatedBoard = result.data;
                log(`✅ 게시글 생성 성공! 번호: ${result.data.boardIdx}`, 'success');
                log(`제목: ${result.data.boardTitle}`, 'success');
                log(`작성자: ${result.data.boardWriter}`, 'success');
            } else {
                log('❌ 게시글 생성 실패', 'error');
            }
        }

        async function createBoardWithAttachments() {
            log('📎 첨부파일 포함 게시글 생성 시작...', 'info');
            
            try {
                // 1단계: 게시글 생성
                log('=== 1단계: 게시글 생성 ===', 'info');
                await createBasicBoard();
                
                if (!lastCreatedBoard) {
                    log('❌ 게시글 생성 실패로 중단', 'error');
                    return;
                }
                
                // 2단계: 파일 선택 및 업로드
                log('=== 2단계: 파일 업로드 ===', 'info');
                const fileInput = document.getElementById('fileInput');
                const files = fileInput.files;
                
                if (files.length === 0) {
                    log('❌ 파일이 선택되지 않았습니다. 먼저 파일을 선택해주세요.', 'warning');
                    return;
                }
                
                const attachmentIds = await uploadFiles(Array.from(files));
                
                if (attachmentIds.length === 0) {
                    log('❌ 파일 업로드 실패', 'error');
                    return;
                }
                
                // 3단계: 첨부파일 연결
                log('=== 3단계: 첨부파일 연결 ===', 'info');
                const linkResult = await linkAttachments(lastCreatedBoard.boardIdx, attachmentIds);
                
                if (linkResult.success) {
                    log('🎉 첨부파일 포함 게시글 생성 완료!', 'success');
                    log(`📋 게시글: ${lastCreatedBoard.boardIdx}번`, 'success');
                    log(`📎 첨부파일: ${attachmentIds.length}개`, 'success');
                }
                
            } catch (error) {
                log(`❌ 오류 발생: ${error.message}`, 'error');
            }
        }

        async function createQuickBoardWithAttachments() {
            log('⚡📎 빠른 첨부파일 포함 게시글 생성...', 'info');
            
            const fileInput = document.getElementById('fileInput');
            const files = fileInput.files;
            
            if (files.length === 0) {
                log('❌ 파일이 선택되지 않았습니다. 먼저 파일을 선택해주세요.', 'warning');
                return;
            }
            
            await createBoardWithAttachments();
        }

        // ========== 파일 업로드 함수 ==========
        async function uploadFiles(files) {
            if (!files || files.length === 0) {
                log('📎 선택된 파일이 없습니다.', 'warning');
                return [];
            }
            
            if (files.length > 5) {
                log('❌ 최대 5개 파일까지 업로드 가능합니다.', 'error');
                return [];
            }
            
            log(`📤 ${files.length}개 파일 업로드 시작...`, 'info');
            const results = [];
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                log(`[${i + 1}/${files.length}] ${file.name} 업로드 중... (${formatFileSize(file.size)})`, 'info');
                
                const formData = new FormData();
                formData.append('file', file);
                
                const result = await apiRequest(`${API_BASE_URL}/api/attachments/upload`, 'POST', formData, true, true);
                
                if (result.success) {
                    results.push(result.data.attachmentIdx);
                    log(`✅ ${file.name} 업로드 성공! (ID: ${result.data.attachmentIdx})`, 'success');
                } else {
                    log(`❌ ${file.name} 업로드 실패`, 'error');
                    return [];
                }
            }
            
            log(`✅ 모든 파일 업로드 완료! ID 목록: [${results.join(', ')}]`, 'success');
            lastUploadedAttachments = results;
            return results;
        }

        async function testFileUpload() {
            const fileInput = document.getElementById('fileInput');
            const files = Array.from(fileInput.files);
            
            if (files.length === 0) {
                log('❌ 파일이 선택되지 않았습니다.', 'warning');
                return;
            }
            
            await uploadFiles(files);
        }

        async function linkAttachments(boardIdx, attachmentIds) {
            if (!attachmentIds || attachmentIds.length === 0) {
                log('📎 연결할 첨부파일이 없습니다.', 'warning');
                return { success: true };
            }
            
            log(`🔗 게시글 ${boardIdx}번에 첨부파일 연결 중...`, 'info');
            log(`첨부파일 ID 목록: [${attachmentIds.join(', ')}]`, 'info');
            
            const linkData = {
                attachmentIds: attachmentIds
            };
            
            const result = await apiRequest(`${API_BASE_URL}/api/boards/link-attachments/${boardIdx}`, 'POST', linkData, true);
            
            if (result.success) {
                log('✅ 첨부파일 연결 성공!', 'success');
                log(`연결된 파일 수: ${attachmentIds.length}개`, 'success');
            } else {
                log('❌ 첨부파일 연결 실패', 'error');
            }
            
            return result;
        }

        async function testAttachmentLink() {
            if (!lastCreatedBoard) {
                log('❌ 연결할 게시글이 없습니다. 먼저 게시글을 생성하세요.', 'warning');
                return;
            }
            
            if (lastUploadedAttachments.length === 0) {
                log('❌ 연결할 첨부파일이 없습니다. 먼저 파일을 업로드하세요.', 'warning');
                return;
            }
            
            await linkAttachments(lastCreatedBoard.boardIdx, lastUploadedAttachments);
        }

        // ========== 유틸리티 함수 ==========
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // ========== 초기화 ==========
        document.addEventListener('DOMContentLoaded', function() {
            log('🔧 첨부파일 테스트 페이지 로드 완료', 'success');
            log('💡 사용법:', 'info');
            log('1. 먼저 "인증 상태 확인" 버튼을 클릭하세요', 'info');
            log('2. 로그인이 필요하면 콘솔에서 로그인하세요', 'info');
            log('3. 파일을 선택하고 테스트 버튼들을 사용하세요', 'info');
            
            checkAuthStatus();
            
            // 파일 선택 시 로그 출력
            document.getElementById('fileInput').addEventListener('change', function(e) {
                const files = Array.from(e.target.files);
                if (files.length > 0) {
                    log(`📁 ${files.length}개 파일 선택됨:`, 'info');
                    files.forEach((file, index) => {
                        log(`   ${index + 1}. ${file.name} (${formatFileSize(file.size)})`, 'info');
                    });
                } else {
                    log('📁 파일 선택이 취소되었습니다.', 'warning');
                }
            });
        });
    </script>
</body>
</html>