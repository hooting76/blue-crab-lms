<mxfile host="app.diagrams.net">
  <diagram name="FCM 푸시 알림" id="fcm-push-notification">
    <mxGraphModel dx="1422" dy="794" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="1169" pageHeight="827" math="0" shadow="0">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />

        <!-- 제목 -->
        <mxCell id="title" value="열람실 만료 15분 전 푸시 알림 플로우" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=24;fontStyle=1;fontColor=#263238;" parent="1" vertex="1">
          <mxGeometry x="280" y="30" width="600" height="40" as="geometry" />
        </mxCell>

        <!-- 1단계: 스케줄러 -->
        <mxCell id="scheduler-box" value="⏰ Scheduler (매 1분마다)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FFECB3;strokeColor=#F57C00;strokeWidth=3;fontSize=16;fontStyle=1;" parent="1" vertex="1">
          <mxGeometry x="80" y="120" width="240" height="60" as="geometry" />
        </mxCell>

        <mxCell id="scheduler-code" value="@Scheduled(cron = &quot;0 * * * * *&quot;)" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=12;fontColor=#E65100;fontFamily=Courier New;fontStyle=1;" parent="1" vertex="1">
          <mxGeometry x="80" y="185" width="240" height="25" as="geometry" />
        </mxCell>

        <!-- 2단계: DB 조회 -->
        <mxCell id="step1-title" value="1️⃣ DB 조회: 15분 후 만료 좌석 검색" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=14;fontStyle=1;fontColor=#1976D2;" parent="1" vertex="1">
          <mxGeometry x="80" y="240" width="320" height="30" as="geometry" />
        </mxCell>

        <mxCell id="db-query" value="ReadingSeatRepository" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#BBDEFB;strokeColor=#1976D2;strokeWidth=2;fontSize=13;fontStyle=1;" parent="1" vertex="1">
          <mxGeometry x="80" y="280" width="180" height="50" as="geometry" />
        </mxCell>

        <mxCell id="db" value="MariaDB" style="shape=cylinder3;whiteSpace=wrap;html=1;boundedLbl=1;backgroundOutline=1;size=15;fillColor=#EF5350;strokeColor=#C62828;strokeWidth=2;fontSize=13;fontStyle=1;fontColor=#FFFFFF;" parent="1" vertex="1">
          <mxGeometry x="300" y="275" width="90" height="60" as="geometry" />
        </mxCell>

        <mxCell id="arr1" value="findActiveSeatsEndingBetween()" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;strokeColor=#1976D2;fontSize=11;fontStyle=1;" parent="1" source="db-query" target="db" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>

        <!-- 3단계: FCM Token 조회 -->
        <mxCell id="step2-title" value="2️⃣ FCM Token 조회" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=14;fontStyle=1;fontColor=#388E3C;" parent="1" vertex="1">
          <mxGeometry x="80" y="360" width="200" height="30" as="geometry" />
        </mxCell>

        <mxCell id="token-service" value="FcmTokenService" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#C8E6C9;strokeColor=#388E3C;strokeWidth=2;fontSize=13;fontStyle=1;" parent="1" vertex="1">
          <mxGeometry x="80" y="400" width="150" height="50" as="geometry" />
        </mxCell>

        <mxCell id="redis" value="Redis" style="shape=cylinder3;whiteSpace=wrap;html=1;boundedLbl=1;backgroundOutline=1;size=15;fillColor=#EC407A;strokeColor=#C62828;strokeWidth=2;fontSize=13;fontStyle=1;fontColor=#FFFFFF;" parent="1" vertex="1">
          <mxGeometry x="270" y="395" width="80" height="60" as="geometry" />
        </mxCell>

        <mxCell id="arr2" value="getTokens(userCode)" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;strokeColor=#388E3C;fontSize=11;fontStyle=1;" parent="1" source="token-service" target="redis" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>

        <!-- 4단계: 알림 메시지 생성 -->
        <mxCell id="step3-title" value="3️⃣ 알림 메시지 생성" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=14;fontStyle=1;fontColor=#7B1FA2;" parent="1" vertex="1">
          <mxGeometry x="80" y="480" width="200" height="30" as="geometry" />
        </mxCell>

        <mxCell id="notification-factory" value="NotificationFactory" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#E1BEE7;strokeColor=#7B1FA2;strokeWidth=2;fontSize=13;fontStyle=1;" parent="1" vertex="1">
          <mxGeometry x="80" y="520" width="160" height="50" as="geometry" />
        </mxCell>

        <mxCell id="notification-template" value="📋 NotificationTemplate&#xa;• title: &quot;시설 예약 승인&quot;&#xa;• body: &quot;좌석 69번, 15분 후 종료&quot;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#F3E5F5;strokeColor=#7B1FA2;strokeWidth=2;fontSize=11;align=left;verticalAlign=top;" parent="1" vertex="1">
          <mxGeometry x="280" y="505" width="240" height="80" as="geometry" />
        </mxCell>

        <mxCell id="arr3" value="createPreExpiryTemplate()" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;strokeColor=#7B1FA2;fontSize=11;fontStyle=1;" parent="1" source="notification-factory" target="notification-template" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>

        <!-- 5단계: Firebase 푸시 전송 -->
        <mxCell id="step4-title" value="4️⃣ Firebase로 푸시 전송" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=14;fontStyle=1;fontColor=#F57C00;" parent="1" vertex="1">
          <mxGeometry x="600" y="120" width="220" height="30" as="geometry" />
        </mxCell>

        <mxCell id="firebase-service" value="FirebasePushService" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FFE0B2;strokeColor=#E65100;strokeWidth=2;fontSize=13;fontStyle=1;" parent="1" vertex="1">
          <mxGeometry x="600" y="160" width="170" height="50" as="geometry" />
        </mxCell>

        <mxCell id="firebase-sdk" value="Firebase Admin SDK" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FFAB91;strokeColor=#BF360C;strokeWidth=2;fontSize=13;fontStyle=1;fontColor=#FFFFFF;" parent="1" vertex="1">
          <mxGeometry x="600" y="250" width="170" height="50" as="geometry" />
        </mxCell>

        <mxCell id="fcm-cloud" value="🔥 Firebase Cloud Messaging" style="ellipse;whiteSpace=wrap;html=1;fillColor=#FF6F00;strokeColor=#E65100;strokeWidth=3;fontSize=14;fontStyle=1;fontColor=#FFFFFF;" parent="1" vertex="1">
          <mxGeometry x="820" y="165" width="180" height="130" as="geometry" />
        </mxCell>

        <mxCell id="arr4" value="sendNotificationBatch()" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;strokeColor=#E65100;fontSize=11;fontStyle=1;" parent="1" source="firebase-service" target="firebase-sdk" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>

        <mxCell id="arr5" value="send()" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=3;strokeColor=#FF6F00;fontSize=11;fontStyle=1;" parent="1" source="firebase-sdk" target="fcm-cloud" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>

        <!-- 6단계: 클라이언트 수신 -->
        <mxCell id="client" value="📱 클라이언트&#xa;(Service Worker)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#E3F2FD;strokeColor=#1976D2;strokeWidth=3;fontSize=14;fontStyle=1;" parent="1" vertex="1">
          <mxGeometry x="820" y="340" width="180" height="70" as="geometry" />
        </mxCell>

        <mxCell id="arr6" value="Push Message" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=3;strokeColor=#1976D2;fontSize=12;fontStyle=1;" parent="1" source="fcm-cloud" target="client" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>

        <!-- 7단계: 전송 결과 로깅 -->
        <mxCell id="step5-title" value="5️⃣ 전송 결과 로깅 &amp; DB 업데이트" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=14;fontStyle=1;fontColor=#558B2F;" parent="1" vertex="1">
          <mxGeometry x="600" y="440" width="280" height="30" as="geometry" />
        </mxCell>

        <mxCell id="logging" value="📝 Logging&#xa;• 성공/실패 count&#xa;• preNoticeSentAt 기록" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#DCEDC8;strokeColor=#558B2F;strokeWidth=2;fontSize=12;align=left;verticalAlign=top;" parent="1" vertex="1">
          <mxGeometry x="600" y="480" width="180" height="80" as="geometry" />
        </mxCell>

        <mxCell id="db-update" value="ReadingUsageLog&#xa;업데이트" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#AED581;strokeColor=#33691E;strokeWidth=2;fontSize=12;fontStyle=1;" parent="1" vertex="1">
          <mxGeometry x="820" y="500" width="140" height="60" as="geometry" />
        </mxCell>

        <mxCell id="arr7" value="markPreNoticeSent()" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;strokeColor=#558B2F;fontSize=11;fontStyle=1;" parent="1" source="logging" target="db-update" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>

        <!-- 메인 플로우 화살표 -->
        <mxCell id="flow1" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=3;strokeColor=#424242;fontSize=11;fontStyle=1;dashed=1;" parent="1" source="scheduler-box" target="db-query" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>

        <mxCell id="flow2" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=3;strokeColor=#424242;fontSize=11;fontStyle=1;dashed=1;" parent="1" source="db-query" target="token-service" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="170" y="360" />
              <mxPoint x="155" y="360" />
            </Array>
          </mxGeometry>
        </mxCell>

        <mxCell id="flow3" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=3;strokeColor=#424242;fontSize=11;fontStyle=1;dashed=1;" parent="1" source="token-service" target="notification-factory" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="155" y="480" />
              <mxPoint x="160" y="480" />
            </Array>
          </mxGeometry>
        </mxCell>

        <mxCell id="flow4" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=3;strokeColor=#424242;fontSize=11;fontStyle=1;dashed=1;" parent="1" source="notification-factory" target="firebase-service" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="160" y="620" />
              <mxPoint x="560" y="620" />
              <mxPoint x="560" y="185" />
            </Array>
          </mxGeometry>
        </mxCell>

        <mxCell id="flow5" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=3;strokeColor=#424242;fontSize=11;fontStyle=1;dashed=1;" parent="1" source="firebase-service" target="logging" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="685" y="440" />
              <mxPoint x="690" y="440" />
            </Array>
          </mxGeometry>
        </mxCell>

        <!-- DB 구조 박스 (우측) -->
        <mxCell id="db-structure-box" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#E8EAF6;strokeColor=#3F51B5;strokeWidth=3;verticalAlign=top;align=left;fontSize=12;" parent="1" vertex="1">
          <mxGeometry x="600" y="580" width="380" height="190" as="geometry" />
        </mxCell>

        <mxCell id="db-structure-title" value="📊 관련 DB 구조" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=16;fontStyle=1;fontColor=#3F51B5;" parent="1" vertex="1">
          <mxGeometry x="600" y="590" width="380" height="30" as="geometry" />
        </mxCell>

        <!-- ReadingSeat 테이블 -->
        <mxCell id="table-seat" value="ReadingSeat" style="swimlane;fontStyle=1;align=center;verticalAlign=top;childLayout=stackLayout;horizontal=1;startSize=26;horizontalStack=0;resizeParent=1;resizeParentMax=0;resizeLast=0;collapsible=1;marginBottom=0;fillColor=#BBDEFB;strokeColor=#1976D2;strokeWidth=2;fontSize=12;" parent="1" vertex="1">
          <mxGeometry x="620" y="630" width="160" height="86" as="geometry" />
        </mxCell>
        <mxCell id="table-seat-field1" value="seatNumber (PK)" style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;fontSize=11;" parent="table-seat" vertex="1">
          <mxGeometry y="26" width="160" height="20" as="geometry" />
        </mxCell>
        <mxCell id="table-seat-field2" value="endTime" style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;fontSize=11;" parent="table-seat" vertex="1">
          <mxGeometry y="46" width="160" height="20" as="geometry" />
        </mxCell>
        <mxCell id="table-seat-field3" value="status" style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;fontSize=11;" parent="table-seat" vertex="1">
          <mxGeometry y="66" width="160" height="20" as="geometry" />
        </mxCell>

        <!-- ReadingUsageLog 테이블 -->
        <mxCell id="table-log" value="ReadingUsageLog" style="swimlane;fontStyle=1;align=center;verticalAlign=top;childLayout=stackLayout;horizontal=1;startSize=26;horizontalStack=0;resizeParent=1;resizeParentMax=0;resizeLast=0;collapsible=1;marginBottom=0;fillColor=#C8E6C9;strokeColor=#388E3C;strokeWidth=2;fontSize=12;" parent="1" vertex="1">
          <mxGeometry x="620" y="640" width="160" height="126" as="geometry" />
        </mxCell>
        <mxCell id="table-log-field1" value="logId (PK)" style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;fontSize=11;" parent="table-log" vertex="1">
          <mxGeometry y="26" width="160" height="20" as="geometry" />
        </mxCell>
        <mxCell id="table-log-field2" value="seatNumber (FK)" style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;fontSize=11;" parent="table-log" vertex="1">
          <mxGeometry y="46" width="160" height="20" as="geometry" />
        </mxCell>
        <mxCell id="table-log-field3" value="userCode" style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;fontSize=11;" parent="table-log" vertex="1">
          <mxGeometry y="66" width="160" height="20" as="geometry" />
        </mxCell>
        <mxCell id="table-log-field4" value="preNoticeSentAt ⭐" style="text;strokeColor=none;fillColor=#FFEB3B;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;fontSize=11;fontStyle=1;" parent="table-log" vertex="1">
          <mxGeometry y="86" width="160" height="20" as="geometry" />
        </mxCell>
        <mxCell id="table-log-field5" value="startTime / endTime" style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;fontSize=11;" parent="table-log" vertex="1">
          <mxGeometry y="106" width="160" height="20" as="geometry" />
        </mxCell>

        <!-- FcmToken 테이블 -->
        <mxCell id="table-token" value="FcmToken (Redis)" style="swimlane;fontStyle=1;align=center;verticalAlign=top;childLayout=stackLayout;horizontal=1;startSize=26;horizontalStack=0;resizeParent=1;resizeParentMax=0;resizeLast=0;collapsible=1;marginBottom=0;fillColor=#FFE0B2;strokeColor=#E65100;strokeWidth=2;fontSize=12;" parent="1" vertex="1">
          <mxGeometry x="800" y="660" width="160" height="86" as="geometry" />
        </mxCell>
        <mxCell id="table-token-field1" value="userCode (Key)" style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;fontSize=11;" parent="table-token" vertex="1">
          <mxGeometry y="26" width="160" height="20" as="geometry" />
        </mxCell>
        <mxCell id="table-token-field2" value="token (Value)" style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;fontSize=11;" parent="table-token" vertex="1">
          <mxGeometry y="46" width="160" height="20" as="geometry" />
        </mxCell>
        <mxCell id="table-token-field3" value="device" style="text;strokeColor=none;fillColor=none;align=left;verticalAlign=top;spacingLeft=4;spacingRight=4;overflow=hidden;rotatable=0;points=[[0,0.5],[1,0.5]];portConstraint=eastwest;fontSize=11;" parent="table-token" vertex="1">
          <mxGeometry y="66" width="160" height="20" as="geometry" />
        </mxCell>

        <!-- 테이블 관계 화살표 -->
        <mxCell id="rel1" value="1:N" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;strokeColor=#424242;fontSize=11;fontStyle=1;endArrow=classic;endFill=1;startArrow=none;startFill=0;" parent="1" source="table-seat" target="table-log" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="700" y="730" />
              <mxPoint x="700" y="730" />
            </Array>
          </mxGeometry>
        </mxCell>

        <mxCell id="rel2" value="N:1" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;strokeColor=#424242;fontSize=11;fontStyle=1;endArrow=classic;endFill=1;startArrow=none;startFill=0;" parent="1" source="table-log" target="table-token" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="780" y="703" />
              <mxPoint x="780" y="703" />
            </Array>
          </mxGeometry>
        </mxCell>

        <!-- 설명 박스 -->
        <mxCell id="info-box" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FFF9C4;strokeColor=#F57F17;strokeWidth=2;verticalAlign=top;align=left;fontSize=12;" parent="1" vertex="1">
          <mxGeometry x="80" y="620" width="500" height="150" as="geometry" />
        </mxCell>

        <mxCell id="info-title" value="💡 핵심 포인트" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=16;fontStyle=1;" parent="1" vertex="1">
          <mxGeometry x="80" y="630" width="500" height="30" as="geometry" />
        </mxCell>

        <mxCell id="info-text" value="• 스케줄러: 매 1분마다 자동 실행&#xa;&#xa;• 비동기 처리: 메인 로직과 독립적&#xa;&#xa;• 중복 방지: preNoticeSentAt ⭐ 체크&#xa;&#xa;• 배치 전송: sendNotificationBatch&#xa;&#xa;• 로깅: 성공/실패 모니터링" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=top;whiteSpace=wrap;rounded=0;fontSize=13;" parent="1" vertex="1">
          <mxGeometry x="100" y="670" width="460" height="90" as="geometry" />
        </mxCell>

      </root>
    </mxGraphModel>
  </diagram>
</mxfile>
