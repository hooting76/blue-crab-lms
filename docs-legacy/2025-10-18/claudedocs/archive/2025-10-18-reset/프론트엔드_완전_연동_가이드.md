# Blue Crab LMS - 게시글 및 첨부파일 API 완전 연동 가이드

## 개요

이 문서는 Blue Crab LMS의 게시글 및 첨부파일 기능을 프론트엔드에서 완전히 연동하기 위한 완전한 API 가이드입니다. 모든 API 엔드포인트, 요청/응답 형식, 에러 처리, 그리고 실제 구현 예제를 포함합니다.

## 목차

1. [인증 및 보안](#인증-및-보안)
2. [게시글 API](#게시글-api)
3. [첨부파일 API](#첨부파일-api)
4. [통합 구현 시나리오](#통합-구현-시나리오)
5. [에러 처리 가이드](#에러-처리-가이드)
6. [주의사항 및 제한사항](#주의사항-및-제한사항)

---

## 인증 및 보안

### JWT 토큰 사용
- 모든 첨부파일 관련 API는 JWT 토큰 인증이 필요합니다.
- 헤더 형식: `Authorization: Bearer {jwt_token}`
- 토큰이 없거나 유효하지 않은 경우 401 Unauthorized 반환

### 첨부파일 권한
- 첨부파일 업로드/삭제는 인증된 사용자만 가능
- 다운로드는 인증 없이도 가능 (공개 파일)
- 게시글 조회는 인증 없이도 가능

---

## 게시글 API

### 1. 게시글 목록 조회

**엔드포인트:** `POST /api/boards/list`

**설명:** 전체 게시글 목록을 페이징하여 조회합니다. 성능 최적화를 위해 본문은 제외됩니다.

**요청:**
```json
{
  "page": 0,
  "size": 10
}
```

**응답:**
```json
{
  "content": [
    {
      "boardIdx": 1,
      "boardCode": 0,
      "boardTitle": "학교 공지사항",
      "boardWriter": "관리자",
      "boardView": 150,
      "boardReg": "2024-01-15 09:00:00",
      "boardWriterType": 1
    }
  ],
  "pageable": {
    "page": 0,
    "size": 10,
    "sort": ["boardReg,DESC"]
  },
  "totalElements": 25,
  "totalPages": 3,
  "first": true,
  "last": false
}
```

### 2. 코드별 게시글 목록 조회

**엔드포인트:** `POST /api/boards/bycode`

**설명:** 특정 코드(학교공지/학사공지/학과공지/교수공지)의 게시글만 조회합니다.

**요청:**
```json
{
  "boardCode": 0,
  "page": 0,
  "size": 10
}
```

**boardCode 값:**
- 0: 학교공지
- 1: 학사공지
- 2: 학과공지
- 3: 교수공지

### 3. 게시글 상세 조회

**엔드포인트:** `POST /api/boards/detail`

**설명:** 특정 게시글의 상세 정보와 첨부파일 목록을 함께 조회합니다. 조회수가 자동으로 증가합니다.

**요청:**
```json
{
  "boardIdx": 1
}
```

**응답:**
```json
{
  "boardIdx": 1,
  "boardCode": 0,
  "boardOn": 1,
  "boardWriter": "관리자",
  "boardTitle": "중요 공지사항",
  "boardContent": "공지 내용...",
  "boardView": 151,
  "boardReg": "2024-01-15 09:00:00",
  "boardLast": "2024-01-15 09:00:00",
  "boardWriterIdx": 1,
  "boardWriterType": 1,
  "attachmentDetails": [
    {
      "attachmentIdx": 1,
      "boardIdx": 1,
      "originalFileName": "공지문서.pdf",
      "filePath": "attachments/2024/01/15/uuid-12345.pdf",
      "fileSize": 2048576,
      "mimeType": "application/pdf",
      "uploadDate": "2024-01-15 09:00:00",
      "isActive": 1
    }
  ]
}
```

### 4. 게시글에 첨부파일 연결

**엔드포인트:** `POST /api/boards/link-attachments/{boardIdx}`

**설명:** 게시글 작성 후 첨부파일들을 게시글에 연결합니다. 첨부파일 업로드 후 반드시 호출해야 합니다.

**요청 헤더:**
```
Authorization: Bearer {jwt_token}
```

**요청:**
```json
{
  "attachmentIdx": [1, 2, 3]
}
```

**응답:**
```json
{
  "success": true,
  "message": "첨부파일이 성공적으로 연결되었습니다.",
  "boardIdx": 1,
  "attachmentCount": 3,
  "attachmentIdx": [1, 2, 3]
}
```

---

## 첨부파일 API

### 1. 첨부파일 업로드

**엔드포인트:** `POST /api/board-attachments/upload/{boardIdx}`

**설명:** 하나 이상의 파일을 업로드합니다. FormData를 사용해야 합니다.

**요청 헤더:**
```
Authorization: Bearer {jwt_token}
Content-Type: multipart/form-data
```

**요청 (FormData):**
```
files: [File 객체들]
```

**JavaScript 예제:**
```javascript
const formData = new FormData();
files.forEach(file => {
  formData.append('files', file);
});

const response = await fetch(`/api/board-attachments/upload/${boardIdx}`, {
  method: 'POST',
  headers: {
    'Authorization': `Bearer ${token}`
  },
  body: formData
});
```

**응답:**
```json
{
  "success": true,
  "message": "첨부파일 업로드가 완료되었습니다.",
  "boardIdx": 1,
  "fileCount": 2,
  "attachments": [
    {
      "attachmentIdx": 1,
      "boardIdx": 1,
      "originalFileName": "문서1.pdf",
      "filePath": "attachments/2024/01/15/uuid-123.pdf",
      "fileSize": 1048576,
      "mimeType": "application/pdf",
      "uploadDate": "2024-01-15 09:00:00",
      "isActive": 1
    },
    {
      "attachmentIdx": 2,
      "boardIdx": 1,
      "originalFileName": "문서2.docx",
      "filePath": "attachments/2024/01/15/uuid-456.docx",
      "fileSize": 2097152,
      "mimeType": "application/vnd.openxmlformats-officedocument.wordprocessingml.document",
      "uploadDate": "2024-01-15 09:00:00",
      "isActive": 1
    }
  ]
}
```

### 2. 첨부파일 다운로드

**엔드포인트:** `POST /api/board-attachments/download`

**설명:** 첨부파일을 다운로드합니다. 파일 스트림을 직접 반환합니다.

**요청:**
```json
{
  "attachmentIdx": 1
}
```

**JavaScript 예제:**
```javascript
const response = await fetch('/api/board-attachments/download', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json'
  },
  body: JSON.stringify({ attachmentIdx: 1 })
});

// 파일 다운로드 처리
if (response.ok) {
  const blob = await response.blob();
  const url = window.URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'filename.pdf'; // 원본 파일명으로 설정
  a.click();
  window.URL.revokeObjectURL(url);
}
```

### 3. 첨부파일 정보 조회

**엔드포인트:** `POST /api/board-attachments/info`

**설명:** 다운로드 전 파일 정보를 확인합니다.

**요청:**
```json
{
  "attachmentIdx": 1
}
```

**응답:**
```json
{
  "attachmentIdx": 1,
  "originalFileName": "문서.pdf",
  "fileSize": 1048576,
  "mimeType": "application/pdf",
  "uploadDate": "2024-01-15 09:00:00"
}
```

### 4. 단일 첨부파일 삭제

**엔드포인트:** `POST /api/board-attachments/delete/{attachmentIdx}`

**설명:** 특정 첨부파일을 삭제합니다.

**요청 헤더:**
```
Authorization: Bearer {jwt_token}
```

**응답:**
```json
{
  "success": true,
  "message": "첨부파일이 성공적으로 삭제되었습니다.",
  "attachmentIdx": 1
}
```

### 5. 다중 첨부파일 삭제

**엔드포인트:** `POST /api/board-attachments/delete-multiple`

**설명:** 여러 첨부파일을 한 번에 삭제합니다.

**요청 헤더:**
```
Authorization: Bearer {jwt_token}
```

**요청:**
```json
{
  "attachmentIds": [1, 2, 3]
}
```

**응답:**
```json
{
  "success": true,
  "message": "다중 첨부파일 삭제가 완료되었습니다.",
  "successCount": 3,
  "failureCount": 0,
  "successIds": [1, 2, 3],
  "failureIds": []
}
```

### 6. 게시글의 모든 첨부파일 삭제

**엔드포인트:** `POST /api/board-attachments/delete-all/{boardIdx}`

**설명:** 특정 게시글의 모든 첨부파일을 삭제합니다.

**요청 헤더:**
```
Authorization: Bearer {jwt_token}
```

**응답:**
```json
{
  "success": true,
  "message": "게시글의 모든 첨부파일이 삭제되었습니다.",
  "boardIdx": 1,
  "deletedCount": 3,
  "deletedIds": [1, 2, 3]
}
```

---

## 통합 구현 시나리오

### 게시글 작성 + 첨부파일 업로드 시나리오

```javascript
// 1. 첨부파일 먼저 업로드
async function uploadAttachments(boardIdx, files) {
  const formData = new FormData();
  files.forEach(file => formData.append('files', file));

  const uploadResponse = await fetch(`/api/board-attachments/upload/${boardIdx}`, {
    method: 'POST',
    headers: { 'Authorization': `Bearer ${token}` },
    body: formData
  });

  const uploadResult = await uploadResponse.json();
  return uploadResult.attachments.map(att => att.attachmentIdx);
}

// 2. 게시글에 첨부파일 연결
async function linkAttachments(boardIdx, attachmentIds) {
  const response = await fetch(`/api/boards/link-attachments/${boardIdx}`, {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${token}`,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({ attachmentIdx: attachmentIds })
  });

  return await response.json();
}

// 3. 전체 프로세스
async function createPostWithAttachments(postData, files) {
  try {
    // 게시글 생성 (별도 API 가정)
    const boardResponse = await createBoard(postData);
    const boardIdx = boardResponse.boardIdx;

    // 첨부파일 업로드
    const attachmentIds = await uploadAttachments(boardIdx, files);

    // 첨부파일 연결
    if (attachmentIds.length > 0) {
      await linkAttachments(boardIdx, attachmentIds);
    }

    return { success: true, boardIdx };
  } catch (error) {
    console.error('게시글 생성 실패:', error);
    return { success: false, error: error.message };
  }
}
```

### 게시글 조회 + 첨부파일 다운로드 시나리오

```javascript
// 게시글 상세 조회
async function loadPostDetail(boardIdx) {
  const response = await fetch('/api/boards/detail', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ boardIdx })
  });

  const post = await response.json();

  // 첨부파일 정보 표시
  if (post.attachmentDetails) {
    post.attachmentDetails.forEach(attachment => {
      console.log(`파일: ${attachment.originalFileName}, 크기: ${attachment.fileSize} bytes`);
    });
  }

  return post;
}

// 첨부파일 다운로드
async function downloadAttachment(attachmentIdx, filename) {
  const response = await fetch('/api/board-attachments/download', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ attachmentIdx })
  });

  if (response.ok) {
    const blob = await response.blob();
    const url = window.URL.createObjectURL(blob);

    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    a.click();

    window.URL.revokeObjectURL(url);
  }
}
```

---

## 에러 처리 가이드

### 공통 에러 응답 형식

```json
{
  "success": false,
  "message": "에러 메시지",
  "errorCode": "ERROR_CODE"
}
```

### 주요 에러 코드

| 에러 코드 | 설명 | HTTP 상태 코드 |
|-----------|------|----------------|
| `AUTHENTICATION_REQUIRED` | 인증 필요 | 401 |
| `INVALID_TOKEN` | 유효하지 않은 토큰 | 401 |
| `FILE_NOT_FOUND` | 파일을 찾을 수 없음 | 404 |
| `FILE_SIZE_EXCEEDED` | 파일 크기 초과 | 400 |
| `INVALID_FILE_TYPE` | 지원하지 않는 파일 형식 | 400 |
| `UPLOAD_FAILED` | 업로드 실패 | 500 |
| `DELETE_FAILED` | 삭제 실패 | 500 |

### JavaScript 에러 처리 예제

```javascript
async function handleApiCall(apiCall) {
  try {
    const response = await apiCall();

    if (!response.ok) {
      const errorData = await response.json();
      throw new Error(errorData.message || 'API 호출 실패');
    }

    const data = await response.json();
    return data;

  } catch (error) {
    console.error('API 에러:', error.message);

    // 사용자에게 에러 표시
    showErrorToast(error.message);

    throw error;
  }
}
```

---

## 주의사항 및 제한사항

### 파일 업로드 제한

- **최대 파일 크기:** 개별 파일 10MB
- **최대 파일 개수:** 게시글당 5개
- **지원 파일 형식:** PDF, DOC, DOCX, XLS, XLSX, PPT, PPTX, TXT, JPG, PNG, GIF
- **파일명 길이:** 최대 255자 (한글 포함)

### 보안 고려사항

- 첨부파일 업로드/삭제 시 JWT 토큰 필수
- 파일 다운로드는 공개적으로 접근 가능
- 민감한 파일은 별도 권한 체크 권장

### 성능 고려사항

- 게시글 목록 조회 시 본문 제외 (성능 최적화)
- 첨부파일 다운로드는 스트리밍 처리
- 대용량 파일 다운로드 시 진행률 표시 권장

### 데이터베이스 제약사항

- 첨부파일 정보는 `BOARD_ATTACHMENT_TBL`에 저장
- 게시글의 첨부파일 IDX는 `BOARD_TBL.BOARD_FILE`에 쉼표 구분으로 저장
- 첨부파일 삭제 시 물리적 파일과 DB 레코드 모두 삭제

---

이 문서를 참고하여 프론트엔드에서 게시글 및 첨부파일 기능을 완전히 구현할 수 있습니다. 추가 질문이 있으시면 언제든지 문의해주세요.